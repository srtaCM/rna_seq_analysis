---
title: "1_Diagnostics_DEG_Notebook"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---
# ICM 2024MAY15 DESeq2 Script
# UM v IM v H

```{r setup-clear-env}
# ===============================
# Environment Setup and Cleanup
# ===============================

# Clean environment: remove all objects (including hidden) from the workspace
rm(list = ls(all.names = TRUE))

#Garbage Collection to free up memory and report memory usage
gc()

# Set global R options:
options(
  max.print = .Machine$integer.max, # - max.print: prevent truncation of console output
  scipen = 0, # - scipen: control scientific notation (0 = default threshold)
  stringsAsFactors = FALSE, # - stringsAsFactors: keep strings as characters (not factors)
  dplyr.summarise.inform = FALSE # - dplyr.summarise.inform: suppress summarise() informational messages
)

# Set random seed for reproducibility
set.seed(123)
```


```{r load-packages, message = FALSE, warning = FALSE}
# =================
# Install packages
# =================

# Install BiocManager if not already installed
# if (!requireNamespace("BiocManager", quietly = TRUE)) {
#   install.packages("BiocManager")
# }

# Install / update Bioconductor packages (uncomment and edit as needed)
# BiocManager::install(c(
#   "DESeq2",
#   "EnhancedVolcano",
#   "ComplexHeatmap",
#   "reactome.db"
# ))

# Install / update CRAN packages (uncomment and edit as needed)
# install.packages(c(
#   "tidyverse",
#   "pheatmap",
#   "writexl",
#   "openxlsx",
#   "ggrepel",
#   "ggforce",
#   "gplots",
#   "RColorBrewer"
# ))

# ===============
# Load packages
# ===============

suppressPackageStartupMessages({
  library(DESeq2)
  library(tidyverse)   # loads ggplot2, dplyr, readr, etc.
  library(pheatmap)
  library(EnhancedVolcano)
  library(writexl)
  library(openxlsx)
})

# If you prefer to avoid loading the full tidyverse, you can instead do:
# suppressPackageStartupMessages({
#   library(dplyr)
#   library(ggplot2)
#   library(readr)
# })

```


```{r setup-output-dirs}
# Base results directory (relative to project root)
results_dir   <- "Results"
graphics_dir  <- file.path(results_dir, "Graphics")
tables_dir    <- file.path(results_dir, "Tables")
procdata_dir  <- file.path(results_dir, "Processed_data")

# Create directories if they do not exist
dir.create(graphics_dir, recursive = TRUE, showWarnings = FALSE)
dir.create(tables_dir,   recursive = TRUE, showWarnings = FALSE)
dir.create(procdata_dir, recursive = TRUE, showWarnings = FALSE)

```



```{r read-data}
#################
# 1. Read data
#################

# Set working directory for the project
setwd("/Users/lilicastillo/Desktop/Lab/TRAPseq")

# Read featureCounts output (whitespace-delimited, skip header metadata row)
featcount <- readr::read_table(
  "HvIM/Data_Repository/featcount.txt",
  col_names = TRUE,
  skip = 1
)

# Use Geneid as rownames and drop annotation columns (Geneid, Chr, Start, End, Strand, Length)
read.count <- as.data.frame(featcount)
rownames(read.count) <- read.count$Geneid
read.count <- read.count[, -c(1:6)]

# Assign biologically meaningful sample names to columns
colnames(read.count) <- c(
  "IT-107", "IT-108", "IT-109", "IT-110",
  "H-107", "H-108", "H-109", "H-110", "H-111",
  "UT-106", "UT-108", "UT-114",
  "IT-206", "IT-207", "IT-208", "IT-209",
  "IM-206", "IM-207", "IM-208", "IM-209", "IM-210",
  "UT-204", "UT-208", "UT-213", "UT-214",
  "UM-204", "UM-208", "UM-213", "UM-214", "UM-215"
)

# Metadata for each sample: group, infection condition, replicate id
sample_info1 <- data.frame(
  Sample = c(
    "IT-107", "IT-108", "IT-109", "IT-110",
    "H-107", "H-108", "H-109", "H-110", "H-111",
    "UT-106", "UT-108", "UT-114",
    "IT-206", "IT-207", "IT-208", "IT-209",
    "IM-206", "IM-207", "IM-208", "IM-209", "IM-210",
    "UT-204", "UT-208", "UT-213", "UT-214",
    "UM-204", "UM-208", "UM-213", "UM-214", "UM-215"
  ),
  Groups = c(
    "IT", "IT", "IT", "IT",
    "H", "H", "H", "H", "H",
    "UT", "UT", "UT",
    "IT", "IT", "IT", "IT",
    "IM", "IM", "IM", "IM", "IM",
    "UT", "UT", "UT", "UT",
    "UM", "UM", "UM", "UM", "UM"
  ),
  Condition = c(
    "Infected", "Infected", "Infected", "Infected",
    "Infected", "Infected", "Infected", "Infected", "Infected",
    "Uninfected", "Uninfected", "Uninfected",
    "Infected", "Infected", "Infected", "Infected",
    "Infected", "Infected", "Infected", "Infected", "Infected",
    "Uninfected", "Uninfected", "Uninfected", "Uninfected",
    "Uninfected", "Uninfected", "Uninfected", "Uninfected", "Uninfected"
  ),
  Replicate = c(
    "IT-107", "IT-108", "IT-109", "IT-110",
    "H-107", "H-108", "H-109", "H-110", "H-111",
    "UT-106", "UT-108", "UT-114",
    "IT-206", "IT-207", "IT-208", "IT-209",
    "IM-206", "IM-207", "IM-208", "IM-209", "IM-210",
    "UT-204", "UT-208", "UT-213", "UT-214",
    "UM-204", "UM-208", "UM-213", "UM-214", "UM-215"
  ),
  row.names = "Sample"
)

# Sanity checks: ensure sample metadata and count matrix are aligned
stopifnot(all(rownames(sample_info1) %in% colnames(read.count)))
stopifnot(all(colnames(read.count) %in% rownames(sample_info1)))


############################################
# 2. UM baseline (IM vs UM, H vs UM)
############################################

# Set UM as the reference group for DESeq2 contrasts
sample_info1$Groups <- factor(
  sample_info1$Groups,
  levels = c("UM", "IM", "H", "UT", "IT")
)

# Construct DESeq2 dataset with group as design factor
dds_UM <- DESeq2::DESeqDataSetFromMatrix(
  countData = read.count,
  colData   = sample_info1,
  design    = ~ Groups
)

# Minimal pre-filtering: keep genes with at least 10 total counts across all samples
dds_UM <- dds_UM[rowSums(DESeq2::counts(dds_UM)) > 10, ]

# Run DESeq2 pipeline (size factors, dispersions, model fitting)
dds_UM <- DESeq2::DESeq(dds_UM)

# List available model coefficients
DESeq2::resultsNames(dds_UM)

# Extract contrasts of interest: IM vs UM and H vs UM (UM is the reference)
res_IM_UM <- DESeq2::results(dds_UM, name = "Groups_IM_vs_UM")
res_H_UM  <- DESeq2::results(dds_UM, name = "Groups_H_vs_UM")

```


```{r ut-baseline-and-export}
################################
# 3. UT baseline (IT vs UT)
################################

# If you want UT as the reference (baseline) instead of UM, uncomment this block.
# This will re-level Groups and fit a separate DESeq2 model for UT vs IT.

# sample_info1$Groups <- factor(
#   sample_info1$Groups,
#   levels = c("UT", "IT", "IM", "H", "UM")
# )
# dds_UT <- DESeq2::DESeqDataSetFromMatrix(
#   countData = read.count,
#   colData   = sample_info1,
#   design    = ~ Groups
# )
# dds_UT <- dds_UT[rowSums(DESeq2::counts(dds_UT)) > 10, ]
# dds_UT <- DESeq2::DESeq(dds_UT)
# DESeq2::resultsNames(dds_UT)
# res_IT_UT <- DESeq2::results(dds_UT, name = "Groups_IT_vs_UT")


#########################
# 4. Export results
#########################

# Convert DESeq2 result objects to data frames and add GeneID column
res_IM_UM_df <- as.data.frame(res_IM_UM)
res_IM_UM_df$GeneID <- rownames(res_IM_UM_df)

res_H_UM_df  <- as.data.frame(res_H_UM)
res_H_UM_df$GeneID  <- rownames(res_H_UM_df)
```


```{r utexport}
# ===============================
# Export to organized Results/Tables directory
# ===============================

# Individual CSV files (one per contrast)
readr::write_csv(res_IM_UM_df, 
                 file.path(tables_dir, "DESeq2_IM_vs_UM.csv"))
readr::write_csv(res_H_UM_df,  
                 file.path(tables_dir, "DESeq2_H_vs_UM.csv"))

# Multi-sheet Excel workbook (recommended)
writexl::write_xlsx(
  list(
    "IM_vs_UM" = res_IM_UM_df,
    "H_vs_UM"  = res_H_UM_df
    # "IT_vs_UT" = res_IT_UT_df  # Uncomment if UT baseline was run
  ),
  path = file.path(tables_dir, "DESeq2_results_IM_H_vs_UM.xlsx")
)


cat("âœ… Tables exported to:", tables_dir, "\n")
cat("ðŸ“Š Files created:\n")


```


```{r merge-and-export-results}
# ===============================
# Merge and export results
# ===============================

# Ensure GeneID columns are present (in case previous chunk was skipped)
res_IM_UM_df$GeneID <- rownames(res_IM_UM_df)
res_H_UM_df$GeneID  <- rownames(res_H_UM_df)

# Select key columns and rename for clarity (log2FC and padj from each contrast)
im_um_sel <- res_IM_UM_df %>%
  dplyr::select(GeneID, IM_vs_UM_log2FC = log2FoldChange, IM_vs_UM_padj = padj)

h_um_sel <- res_H_UM_df %>%
  dplyr::select(GeneID, H_vs_UM_log2FC = log2FoldChange, H_vs_UM_padj = padj)

# If UT baseline is run:
# it_ut_sel <- res_IT_UT_df %>%
#   dplyr::select(
#     GeneID,
#     IT_vs_UT_log2FC = log2FoldChange,
#     IT_vs_UT_padj   = padj
#   )



# Full join all contrasts by GeneID (full_join keeps all genes from both tables)
deseq_all <- dplyr::full_join(im_um_sel, h_um_sel, by = "GeneID")
head(deseq_all)

# Preview the merged table
# These should now print the first 6 rows:
head(deseq_all)
head(deseq_all, 3)  # First 3 rows

# Column summaries look reasonable:
summary(deseq_all$IM_vs_UM_log2FC)
summary(deseq_all$IM_vs_UM_padj)

# View in spreadsheet-style viewer:
View(deseq_all)
```


```{r export-results}
# ===============================
# Export options (Results/Tables)
# ===============================

# 1. Single CSV with all contrasts (wide format)
readr::write_csv(
  deseq_all,
  file.path(tables_dir, "DESeq2_all_contrasts_wide.csv")
)

# 2. Multi-sheet Excel workbook (recommended)
writexl::write_xlsx(
  list(
    "IM_vs_UM" = im_um_sel,
    "H_vs_UM"  = h_um_sel,
    "All_wide" = deseq_all
  ),
  path = file.path(tables_dir, "DESeq2_results_combined.xlsx")
)

# 3. Long-format summary for downstream analysis
deseq_long <- deseq_all %>%
  tidyr::pivot_longer(
    cols = ends_with("_log2FC") | ends_with("_padj"),
    names_to = c("contrast", ".value"),
    names_pattern = "(.*)_(log2FC|padj)"
  )

readr::write_csv(
  deseq_long,
  file.path(tables_dir, "DESeq2_long_format_for_joining.csv")
)

cat("âœ… Tables exported to Results/Tables:\n")
cat("- DESeq2_all_contrasts_wide.csv\n")
cat("- DESeq2_results_combined.xlsx\n")
cat("- DESeq2_long_format_for_joining.csv\n")

```


```{r combined-de-analysis}
# ===============================
# Combined: Shared/Unique + Volcano + Heatmap
# ===============================

library(EnhancedVolcano)
library(pheatmap)

# 1. Significant genes (padj < 0.05)
sig_IM <- rownames(res_IM_UM)[res_IM_UM$padj < 0.05]
sig_H  <- rownames(res_H_UM)[res_H_UM$padj < 0.05]

shared    <- intersect(sig_IM, sig_H)
unique_IM <- setdiff(sig_IM, sig_H)
unique_H  <- setdiff(sig_H, sig_IM)

cat("Shared significant (padj < 0.05):", length(shared), "\n")
cat("IM-unique significant:", length(unique_IM), "\n")
cat("H-unique significant:", length(unique_H), "\n")
cat("Total IM sig:", length(sig_IM), "\n")
cat("Total H sig:", length(sig_H), "\n")

# 2. Merged results for plotting
merged_res <- data.frame(
  Gene             = rownames(res_IM_UM),
  log2FC_IM_vs_UM  = res_IM_UM$log2FoldChange,
  padj_IM_vs_UM    = res_IM_UM$padj,
  log2FC_H_vs_UM   = res_H_UM$log2FoldChange,
  padj_H_vs_UM     = res_H_UM$padj
)

merged_res$category <- ifelse(
  rownames(merged_res) %in% shared, "Shared",
  ifelse(rownames(merged_res) %in% unique_IM, "IM-unique",
         ifelse(rownames(merged_res) %in% unique_H, "H-unique", "NS"))
)

# 3. Log2FC scatter (IM vs H concordance)
p1 <- ggplot(merged_res, aes(x = log2FC_IM_vs_UM, y = log2FC_H_vs_UM, color = category)) +
  geom_point(alpha = 0.6, size = 0.8) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black") +
  scale_color_manual(values = c("Shared" = "red", "IM-unique" = "blue", 
                                "H-unique" = "green", "NS" = "grey")) +
  labs(title = "IM vs UM vs H vs UM: Concordance", 
       x = "IM vs UM log2FC", y = "H vs UM log2FC") +
  theme_minimal() + theme(legend.position = "bottom")
print(p1)

# 4. Volcano plot (IM vs UM)
p2 <- EnhancedVolcano(
  deseq_all,
  lab = deseq_all$GeneID,
  x = 'IM_vs_UM_log2FC', y = 'IM_vs_UM_padj',
  pCutoff = 0.05, FCcutoff = 1,
  title = 'IM vs UM Volcano'
)
print(p2)

# 5. Heatmap: Top SHARED genes (haustoria candidates)
# Debug (run this first):
setdiff(top_shared_genes, rownames(dds_UM))
sum(top_shared_genes %in% rownames(dds_UM))  # Should be 50

# Fix: Only use genes that exist in dds_UM
top_shared_genes <- intersect(top_shared_genes, rownames(dds_UM))
length(top_shared_genes)  # Confirm we have enough

# Replace the heatmap section with:
top_shared_genes <- head(shared, 50)
top_shared_genes <- intersect(top_shared_genes, rownames(dds_UM))  # Safe subset
if(length(top_shared_genes) > 0) {
  pheatmap(
    assay(dds_UM)[top_shared_genes, ],
    scale = "row",
    annotation_col = sample_info1[, c("Groups", "Condition"), drop = FALSE],
    main = paste("Top", length(top_shared_genes), "SHARED DE genes"),
    show_rownames = FALSE
  )
} else {
  cat("No shared genes found in dds_UM\n")
}

# 6. Top shared table
merged_res[shared, ] %>%
  dplyr::mutate(avg_lfc = (log2FC_IM_vs_UM + log2FC_H_vs_UM) / 2) %>%
  dplyr::arrange(dplyr::desc(avg_lfc)) %>%
  head(20) %>%
  print()

```


```{r pca-samples}
library(ggplot2)
library(ggrepel)
library(DESeq2)

# ===============================
# Sample clustering: VST + PCA
# ===============================

# VST transform (variance-stabilizing normalization for PCA)
vsd <- vst(dds_UM, blind = TRUE)  # blind=TRUE ignores design for unbiased PCA

# Normalized counts for other plots (if needed)
norm_counts <- assay(dds_UM)

# PCA plot data (DESeq2 built-in function)
pca_data <- DESeq2::plotPCA(
  vsd, 
  intgroup = c("Groups", "Condition"),  # Use Groups + Condition
  returnData = TRUE
)
percentVar <- round(100 * attr(pca_data, "percentVar"))

# PCA plot with improved aesthetics
p <- ggplot(pca_data, aes(PC1, PC2, color = Groups)) +
  geom_point(aes(shape = Condition), size = 4, stroke = 1) +
  scale_color_manual(values = c(
    "UM" = "#00BFC4", "IM" = "#FF9933", 
    "H"  = "#CC6677", "UT" = "#4477AA", 
    "IT" = "#88CCEE"
  )) +
  scale_shape_manual(values = c("Uninfected" = 16, "Infected" = 17)) +
  labs(
    title = "Sample Clustering: VST PCA",
    subtitle = "TRAP-seq (IM/H/UM/UT/IT samples)"
  ) +
  theme_classic() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5, face = "bold")
  )

# Add sample labels (repel avoids overlap)
p2 <- p + 
  geom_text_repel(
    aes(label = name),  # 'name' from plotPCA()
    box.padding = 0.3, 
    max.overlaps = Inf,  # Show all labels
    size = 3, 
    segment.color = "grey50",
    segment.size = 0.2
  ) +
  xlab(paste0("PC1: ", percentVar[1], "% variance")) +
  ylab(paste0("PC2: ", percentVar[2], "% variance"))

print(p2)

# ===============================
# Optional: Save high-res plot
# ===============================
# ggsave("TRAP_PCA_vst.pdf", plot = p2, width = 12, height = 10, dpi = 300)
```


```{r ma-plots}
# ===============================
# DESeq2 MA Plots (mean vs log2FC)
# ===============================

# Set y-axis limits for consistent comparison
ylim <- c(-3, 3)

# IM vs UM MA plot
DESeq2::plotMA(res_IM_UM, ylim = ylim, main = "IM vs UM")

# H vs UM MA plot  
DESeq2::plotMA(res_H_UM, ylim = ylim, main = "H vs UM")

# IT vs UT MA plot (if you ran the UT baseline)
# DESeq2::plotMA(res_IT_UT, ylim = ylim, main = "IT vs UT")

# ===============================
# Combined: Overlay IM + H on same plot
# ===============================
par(mfrow = c(1, 2), las = 1, cex.axis = 0.8)

plotMA(res_IM_UM, ylim = ylim, main = "IM vs UM")
plotMA(res_H_UM, ylim = ylim, main = "H vs UM")

# Reset layout
par(mfrow = c(1, 1))

# ===============================
# Key interpretation:
# - Red points = significant (padj < 0.05)
# - Horizontal spread = log2FC magnitude  
# - Vertical = mean expression
# - H plot should show strongest haustoria signal!
```

```{r volcano-plots}
library(EnhancedVolcano)

# ===============================
# Basic volcano plots
# ===============================

# IM vs UM (mesophyll haustoria contamination)
p1 <- EnhancedVolcano(
  res_IM_UM,
  lab = rownames(res_IM_UM),
  x = 'log2FoldChange', y = 'padj',
  pCutoff = 0.05, FCcutoff = 1,
  pointSize = 1.5, labSize = 3.0,
  title = 'IM vs UM (TRAP Mesophyll)',
  subtitle = "padj < 0.05, |log2FC| > 1",
  colAlpha = 0.7,
  legendLabels = c('NS', 'Log2FC', 'padj', 'padj & Log2FC'),
  legendPosition = 'right',
  col = c('grey30', 'forestgreen', 'royalblue', 'red2')
)
print(p1)

# H vs UM (pure haustoria signal - expect strongest DE!)
p2 <- EnhancedVolcano(
  res_H_UM,
  lab = rownames(res_H_UM),
  x = 'log2FoldChange', y = 'padj',
  pCutoff = 0.05, FCcutoff = 1,
  pointSize = 1.5, labSize = 3.0,
  title = 'H vs UM (Pure Haustoria)',
  subtitle = "padj < 0.05, |log2FC| > 1"
)
print(p2)

# ===============================
# Highlight top shared genes (from previous chunk)
# ===============================

top_shared <- head(shared, 10)  # Top 10 shared haustoria candidates
p3 <- EnhancedVolcano(
  res_IM_UM,
  lab = rownames(res_IM_UM),
  x = 'log2FoldChange', y = 'padj',
  selectLab = top_shared,  # Label your haustoria candidates!
  pCutoff = 0.05, FCcutoff = 1,
  title = 'IM vs UM: Top Shared Genes Highlighted'
)
print(p3)

# ===============================
# Export high-res PNGs
# ===============================
png("Volcano_IM_vs_UM.png", width = 10, height = 8, units = "in", res = 300)
print(p1)
dev.off()

png("Volcano_H_vs_UM.png", width = 10, height = 8, units = "in", res = 300)
print(p2)
dev.off()


```



```{r}
library(brew)
  library(dplyr)
  library(dendextend)# Calculate sample distances and create hierarchical clustering
sample_dist <- norm.counts [complete.cases (norm.counts), ] 
correlation_matrix <- cor (sample_dist, method = "spearman")
dist_matrix <- as.dist (1 - correlation_matrix)

# Hierarchical clustering
clustering_result <- hclust (dist_matrix, method = "complete")
dendrogram_object <- as.dendrogram (clustering_result) %>% color_branches (k = 3)
 
library(ggplot2)
library(ggdendro)
  library(RColorBrewer)
  library(dplyr)
  library(dendextend)
  library(pheatmap)
dendro_data <- ggdendro::dendro_data(dendrogram_object)
# Plot dendrogram using ggplot2
ggplot() +
  geom_segment(data = dendro_data$segments, 
               aes(x = x, y = y, xend = xend, yend = yend), 
               color = "black") +
  geom_text(data = dendro_data$labels, 
            aes(x = x, y = y, label = label), 
            angle = 60, hjust = 1, vjust = 0.1, size = 4) +  # Rotate labels
  scale_y_continuous(expand = expansion(mult = c(0.2, 0.1))) +
  theme_minimal() +
  labs(title = "VST Read Counts - Distance: Spearman Correlation", y = "Height") +
  theme(axis.text.x = element_blank(),  # Hide x-axis text
        axis.ticks.x = element_blank(),
        plot.margin = margin(10, 10, 40, 10))  # Hide x-axis ticks
# Plot dendrogram
#plot (dendrogram_object, type = "rectangle", ylab = "Height", main = "VST Read Counts - Distance: Spearman Correlation")
#dev.copy2pdf(file = "./1_deseq/1_Dend_trapCLE.pdf", width = 12, height = 8)

# Create heatmap of distance matrix using pheatmap package  
DistMatrix <- as.matrix (dist_matrix)
rownames (DistMatrix) <- paste (vsd$Replicate, sep = "-")
colnames (DistMatrix) <- paste (vsd$Replicate, sep = "-")
color_scheme <- colorRampPalette (rev (brewer.pal (9, "Blues")))(255)

pheatmap (DistMatrix, clustering_distance_rows = dist_matrix, clustering_distance_cols = dist_matrix, 
         color = color_scheme, main = "Sample Distance Matrix Heatmap")
#dev.copy2pdf(file = "./1_deseq/1_DistMat_trapCLE.pdf", width = 12, height = 8)
```


```{r}
library(pheatmap)
library(RColorBrewer)
# rlog transformation
rld <- rlog(dds_UM, blind = TRUE)

# Extract matrix
mat <- assay(rld)
deg_genes <- rownames(res_IM_UM)[which(res_IM_UM$padj < 0.05 & abs(res_IM_UM$log2FoldChange) > 1)]

# Subset the matrix
mat_deg <- mat[deg_genes, ]
mat_scaled <- t(scale(t(mat_deg)))  # scale by row (gene)
# Optional: colors
hm_colors <- colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100)

pheatmap(
  mat_scaled,
  cluster_rows = TRUE,        # cluster genes
  cluster_cols = TRUE,        # cluster samples
  show_rownames = TRUE,
  show_colnames = TRUE,
  color = hm_colors,
  fontsize_row = 6,
  fontsize_col = 10,
  main = "DEGs Heatmap: IM vs UM"
)
annotation_col <- as.data.frame(colData(dds_UM)[, "Groups", drop=FALSE])
pheatmap(
  mat_scaled,
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  show_rownames = TRUE,
  show_colnames = TRUE,
  annotation_col = annotation_col,
  color = hm_colors,
  main = "DEGs Heatmap: IM vs UM"
)
topN <- 50
top_genes <- rownames(res_IM_UM)[order(abs(res_IM_UM$log2FoldChange), decreasing = TRUE)][1:topN]
mat_top <- mat[top_genes, ]
png("DEGs_heatmap_IM_vs_UM.png", width = 2000, height = 1500, res = 150)
pheatmap(mat_scaled, cluster_rows = TRUE, cluster_cols = TRUE, color = hm_colors)
dev.off()

```

```{r}
# Load required libraries
library(DESeq2)
library(pheatmap)
library(RColorBrewer)

# -------------------------
# 1. Prepare normalized counts
# -------------------------
# rlog transformation for variance stabilization
rld <- rlog(dds_UM, blind = TRUE)
mat <- assay(rld)

# -------------------------
# 2. Select DEGs from both comparisons
# -------------------------
# Define thresholds
padj_cutoff <- 0.05
lfc_cutoff  <- 1

deg_IM <- rownames(res_IM_UM)[which(res_IM_UM$padj < padj_cutoff &
                                     abs(res_IM_UM$log2FoldChange) > lfc_cutoff)]
deg_H  <- rownames(res_H_UM)[which(res_H_UM$padj < padj_cutoff &
                                    abs(res_H_UM$log2FoldChange) > lfc_cutoff)]

# Combine DEGs (union of both sets)
deg_genes <- union(deg_IM, deg_H)

# Subset normalized counts matrix
mat_deg <- mat[deg_genes, ]

# -------------------------
# 3. Scale rows (genes)
# -------------------------
mat_scaled <- t(scale(t(mat_deg)))  # scale by row

# -------------------------
# 4. Prepare sample annotation
# -------------------------
annotation_col <- as.data.frame(colData(dds_UM)[, "Groups", drop = FALSE])
colnames(annotation_col) <- "Group"

# Optional: choose colors for groups
group_colors <- list(Group = c("UM"="grey", "IM"="forestgreen", "H"="royalblue", "UT"="orange", "IT"="purple"))

# -------------------------
# 5. Define heatmap colors
# -------------------------
hm_colors <- colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100)

# -------------------------
# 6. Plot heatmap
# -------------------------
pheatmap(
  mat_scaled,
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  show_rownames = TRUE,
  show_colnames = TRUE,
  annotation_col = annotation_col,
  annotation_colors = group_colors,
  color = hm_colors,
  fontsize_row = 6,
  fontsize_col = 10,
  main = "Top DEGs: IM vs UM & H vs UM"
)

# -------------------------
# 7. Save heatmap to file
# -------------------------
png("DEGs_heatmap_IM_H_vs_UM.png", width = 2500, height = 1800, res = 150)
pheatmap(
  mat_scaled,
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  show_rownames = TRUE,
  show_colnames = TRUE,
  annotation_col = annotation_col,
  annotation_colors = group_colors,
  color = hm_colors,
  fontsize_row = 6,
  fontsize_col = 10,
  main = "Top DEGs: IM vs UM & H vs UM"
)
dev.off()

```






```{r}
# ==========================
# Load required packages
# ==========================
library(DESeq2)
library(pheatmap)
library(RColorBrewer)
library(ggplot2)
library(EnhancedVolcano)
library(VennDiagram)
library(clusterProfiler)   # For GO/KEGG enrichment
library(org.At.tair.db)    # Arabidopsis annotation
library(fgsea)             # Optional for GSEA
library(writexl)           # Optional for saving results

# ==========================
# 1. Heatmap of top DEGs (Fig 4)
# ==========================
# rlog transformation
rld <- rlog(dds_UM, blind = TRUE)
mat <- assay(rld)

# Select top DEGs from IM vs UM and H vs UM
padj_cutoff <- 0.05
lfc_cutoff  <- 1

deg_IM <- rownames(res_IM_UM)[which(res_IM_UM$padj < padj_cutoff &
                                     abs(res_IM_UM$log2FoldChange) > lfc_cutoff)]
deg_H  <- rownames(res_H_UM)[which(res_H_UM$padj < padj_cutoff &
                                    abs(res_H_UM$log2FoldChange) > lfc_cutoff)]

deg_genes <- union(deg_IM, deg_H)
mat_deg <- mat[deg_genes, ]

# Scale rows
mat_scaled <- t(scale(t(mat_deg)))

# Sample annotation
annotation_col <- as.data.frame(colData(dds_UM)[, "Groups", drop = FALSE])
colnames(annotation_col) <- "Group"
group_colors <- list(Group = c("UM"="grey", "IM"="forestgreen", "H"="royalblue", "UT"="orange", "IT"="purple"))

# Heatmap colors
hm_colors <- colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100)

# Plot heatmap
pheatmap(
  mat_scaled,
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  show_rownames = TRUE,
  show_colnames = TRUE,
  annotation_col = annotation_col,
  annotation_colors = group_colors,
  color = hm_colors,
  fontsize_row = 6,
  fontsize_col = 10,
  main = "Top DEGs: IM vs UM & H vs UM"
)

# ==========================
# 2. Scatterplot / Venn diagram of DEGs (Fig 5)
# ==========================
# Scatterplot of log2FC IM vs UM vs H vs UM
deg_overlap <- intersect(deg_IM, deg_H)
merged_res <- data.frame(
  Gene = rownames(res_IM_UM),
  log2FC_IM_vs_UM = res_IM_UM$log2FoldChange,
  padj_IM_vs_UM   = res_IM_UM$padj,
  log2FC_H_vs_UM  = res_H_UM$log2FoldChange,
  padj_H_vs_UM    = res_H_UM$padj
)

ggplot(merged_res, aes(x = log2FC_IM_vs_UM, y = log2FC_H_vs_UM)) +
  geom_point(alpha = 0.5) +
  geom_point(data = merged_res[merged_res$Gene %in% deg_overlap, ], color = "red") +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  xlab("IM vs UM log2FC") + ylab("H vs UM log2FC") +
  theme_minimal() +
  ggtitle("Comparison of DEGs: IM vs UM vs H vs UM")

# Venn diagram of DEGs
venn.plot <- venn.diagram(
  x = list(IM_vs_UM = deg_IM, H_vs_UM = deg_H),
  filename = NULL,
  fill = c("forestgreen","royalblue"),
  alpha = 0.5,
  cex = 2,
  cat.cex = 1.5,
  main = "Overlap of DEGs IM vs UM and H vs UM"
)
grid.draw(venn.plot)
```


```{r}
# ==========================
# 3. GO / KEGG enrichment (Fig 6)
# ==========================
# Example using clusterProfiler
# Convert gene symbols to Entrez IDs
library(org.At.tair.db)
gene_list <- deg_genes
library(clusterProfiler)
library(org.At.tair.db)

# Convert TAIR IDs to Entrez IDs
entrez_ids <- bitr(gene_list,
                   fromType = "TAIR",
                   toType = "ENTREZID",
                   OrgDb = org.At.tair.db)
entrez_ids <- entrez_ids$ENTREZID


# GO enrichment (Biological Process)
ego <- enrichGO(
  gene = entrez_ids,
  OrgDb = org.At.tair.db,
  keyType = "ENTREZID",
  ont = "BP",
  pAdjustMethod = "BH",
  qvalueCutoff = 0.05,
  readable = TRUE
)

# Plot top 15 GO terms
barplot(ego, showCategory=15, title="GO Enrichment of DEGs")


# ==========================
# 4. Selected gene expression plots (Fig 7)
# ==========================
# Example: plot normalized counts for top DEGs
top_genes <- head(deg_genes, 6)  # pick top 6 DEGs
for (gene in top_genes){
  df <- data.frame(
    gene = rep(gene, ncol(mat)),
    expression = mat[gene, ],
    group = colData(dds_UM)$Groups
  )
  
  p <- ggplot(df, aes(x=group, y=expression)) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(width=0.1, size=1.5, alpha=0.7) +
    ylab("rlog-normalized counts") +
    xlab("Group") +
    ggtitle(paste("Expression of", gene)) +
    theme_minimal()
  
  print(p)
}

```

```{r}
plotDispEsts(results_object1)

plot(res1$baseMean+1,
-log10(res1$pvalue),
log="x", xlab="mean of normalized counts",
ylab=expression(-log[10](pvalue)),
ylim=c(0,30),
cex=.4, col=rgb(0,0,0,.3))
```


```{r}
  library(clusterProfiler)
  library(org.At.tair.db)
  library(tibble)
  library(magrittr)

UMVsIM$entrez = mapIds (org.At.tair.db, keys = row.names (UMVsIM) , keytype = "TAIR" , column = "ENTREZID" , multiVals = "first" )
UMVsIM$symbol <- mapIds (org.At.tair.db, keys = row.names (UMVsIM), keytype = "TAIR", column = "SYMBOL", multiVals = "first")

UMVsIM <- UMVsIM %>% as.data.frame() %>% rownames_to_column (., var = "rowname") %>% as_tibble() %>% na.omit() 

#write.csv(HvIM.UM, file = "./DerivedData/1_Diag_DEG/1_DEG_HvIMvum_NoFilters.csv", quote = FALSE, row.names = TRUE)
write.xlsx (UMVsIM, file = "./DerivedData/6_DEG_TRAPCLE_nofilters.xlsx", sheetName = "IMvsUM", col.names = TRUE, row.names = TRUE, append = FALSE)


pad = 0.05
UMVsIM_DEG_table1 <- UMVsIM %>% mutate (diffexpressed = case_when (
  log2FoldChange > 1 &   padj < pad ~ 'UP',
  log2FoldChange < -1 &   padj < pad ~ 'DOWN',
  padj > pad ~ 'NO' )) %>% na.omit() 
#view(HIM_DEG_table)

UMVsIM_DEG_table1 <- UMVsIM_DEG_table1 [UMVsIM_DEG_table1$diffexpressed != 'NO', ] 
unique (UMVsIM_DEG_table1$diffexpressed)
#write.csv(UMVsIM_DEG_table1, file = "./DerivedData/1_Diag_DEG/1_DEG_TRAPCLE.csv", quote = FALSE, row.names = TRUE)

write.xlsx (UMVsIM_DEG_table1, file = "./DerivedData/6_DEGp05LFC1_TRAPCLE.xlsx", sheetName = "IMvsUM", col.names = TRUE, row.names = TRUE, append = FALSE)
 
UMVsIM_table_split1 <- split (UMVsIM_DEG_table1, UMVsIM_DEG_table1$diffexpressed)

UMVsIMDFDOWN.UM1 <- c(UMVsIM_table_split1$DOWN)
UMVsIMDFDOWN.UM1 <-as.data.frame(UMVsIMDFDOWN.UM1, row.names = UMVsIMDFDOWN.UM1$entrez)
UMVsIMDFUP.UM1 <- c (UMVsIM_table_split1$UP)
UMVsIMDFUP.UM1 <- as.data.frame (UMVsIMDFUP.UM1, row.names = UMVsIMDFUP.UM1$entrez)
#write.csv(DFUP.UM, file = "./DerivedData/1_Diag_DEG/1_DEG_HIMvumUP_LFC1p05.csv", quote = FALSE, row.names = TRUE)
```


```{r}

UMVsH$entrez = mapIds (org.At.tair.db, keys = row.names (UMVsH) , keytype = "TAIR" , column = "ENTREZID" , multiVals = "first" )
UMVsH$symbol <- mapIds (org.At.tair.db, keys = row.names (UMVsH), keytype = "TAIR", column = "SYMBOL", multiVals = "first")

UMVsH <- UMVsH %>% as.data.frame() %>% rownames_to_column (., var = "rowname") %>% as_tibble() %>% na.omit() 
#write.xlsx (UMVsH, file = "./DerivedData/6_DEG_TRAPCLE_nofilters.xlsx", sheetName = "UM vs H", row.names = TRUE, append = TRUE)

#write.csv(HvIM.UM, file = "./DerivedData/1_Diag_DEG/1_DEG_HvIMvum_NoFilters.csv", quote = FALSE, row.names = TRUE)
 
pad = 0.05
UMVsH_DEG_table1 <- UMVsH %>% mutate (diffexpressed = case_when (
  log2FoldChange > 1 &   padj < pad ~ 'UP',
  log2FoldChange < -1 &   padj < pad ~ 'DOWN',
  padj > pad ~ 'NO' )) %>% na.omit() 
#view(HIM_DEG_table)

UMVsH_DEG_table1 <- UMVsH_DEG_table1 [UMVsH_DEG_table1$diffexpressed != 'NO', ] 
unique (UMVsH_DEG_table1$diffexpressed)
write.xlsx (UMVsH_DEG_table1, file = "./DerivedData/6_DEGp05LFC1_TRAPCLE.xlsx", sheetName = "IMvsH", col.names = TRUE, row.names = TRUE, append = TRUE)

 
UMVsH_table_split1 <- split (UMVsH_DEG_table1, UMVsH_DEG_table1$diffexpressed)

UMVsHDFDOWN <- c(UMVsH_table_split1$DOWN)
UMVsHDFDOWN <-as.data.frame(UMVsHDFDOWN, row.names = UMVsHDFDOWN$entrez)
UMVsHDFUP <- c (UMVsH_table_split1$UP)
UMVsHDFUP <- as.data.frame (UMVsHDFUP, row.names = UMVsHDFUP$entrez)
#write.csv(DFUP.UM, file = "./DerivedData/1_Diag_DEG/1_DEG_HIMvumUP_LFC1p05.csv", quote = FALSE, row.names = TRUE)
```


```{r}
UTvsIT$entrez = mapIds (org.At.tair.db, keys = row.names (UTvsIT) , keytype = "TAIR" , column = "ENTREZID" , multiVals = "first" )
UTvsIT$symbol <- mapIds (org.At.tair.db, keys = row.names (UTvsIT), keytype = "TAIR", column = "SYMBOL", multiVals = "first")

UTvsIT <- UTvsIT %>% as.data.frame() %>% rownames_to_column (., var = "rowname") %>% as_tibble() %>% na.omit() 

#write.xlsx (UTvsIT, file = "./DerivedData/6_DEG_TRAPCLE_nofilters.xlsx", sheetName = "IT vs UT", row.names = TRUE, append = TRUE)
#write.csv(HvIM.UM, file = "./DerivedData/1_Diag_DEG/1_DEG_HvIMvum_NoFilters.csv", quote = FALSE, row.names = TRUE)
 
pad = 0.05
UTvsIT_DEG_table <- UTvsIT %>% mutate (diffexpressed = case_when (
  log2FoldChange > 1 &   padj < pad ~ 'UP',
  log2FoldChange < -1 &   padj < pad ~ 'DOWN',
  padj > pad ~ 'NO' )) %>% na.omit() 
#view(HIM_DEG_table)

UTvsIT_DEG_table <-UTvsIT_DEG_table [UTvsIT_DEG_table$diffexpressed != 'NO', ] 
unique (UTvsIT_DEG_table$diffexpressed)
#write.xlsx (UTvsIT_DEG_table, file = "./DerivedData/6_DEGp05LFC1_TRAPCLE.xlsx", sheetName = "UTvsIT", col.names = TRUE, row.names = TRUE, append = TRUE)
#write.csv(HIMum_DEG_table, file = "./DerivedData/1_Diag_DEG/1_DEG_HIMvUM_LFC1p05.csv", quote = FALSE, row.names = TRUE)
 
UTvsIT_table_split <- split (UTvsIT_DEG_table, UTvsIT_DEG_table$diffexpressed)

UTvsITDFDOWN.UM <- c(UTvsIT_table_split$DOWN)
UTvsITDFDOWN.UM <-as.data.frame(UTvsITDFDOWN.UM, row.names = UTvsITDFDOWN.UM$entrez)
UTvsITDFUP.UM <- c (UTvsIT_table_split$UP)
UTvsITDFUP.UM <- as.data.frame (UTvsITDFUP.UM, row.names = UTvsITDFUP.UM$entrez)
#write.csv(DFUP.UM, file = "./DerivedData/1_Diag_DEG/1_DEG_HIMvumUP_LFC1p05.csv", quote = FALSE, row.names = TRUE)
```


```{r}
HVsUT$entrez = mapIds (org.At.tair.db, keys = row.names (HVsUT) , keytype = "TAIR" , column = "ENTREZID" , multiVals = "first" )
HVsUT$symbol <- mapIds (org.At.tair.db, keys = row.names (HVsUT), keytype = "TAIR", column = "SYMBOL", multiVals = "first")

HVsUT <- HVsUT %>% as.data.frame() %>% rownames_to_column (., var = "rowname") %>% as_tibble() %>% na.omit() 

write.xlsx (HVsUT, file = "./DerivedData/6_DEG_TRAPCLE_nofilters.xlsx", sheetName = "H vs UT", row.names = TRUE, append = TRUE)
#write.csv(HvIM.UM, file = "./DerivedData/1_Diag_DEG/1_DEG_HvIMvum_NoFilters.csv", quote = FALSE, row.names = TRUE)
 
pad = 0.05
HVsUT_DEG_table <- HVsUT %>% mutate (diffexpressed = case_when (
  log2FoldChange > 1 &   padj < pad ~ 'UP',
  log2FoldChange < -1 &   padj < pad ~ 'DOWN',
  padj > pad ~ 'NO' )) %>% na.omit() 
#view(HIM_DEG_table)

HVsUT_DEG_table <-HVsUT_DEG_table [HVsUT_DEG_table$diffexpressed != 'NO', ] 
unique (HVsUT_DEG_table$diffexpressed)

write.xlsx (HVsUT_DEG_table, file = "./DerivedData/6_DEGp05LFC1_TRAPCLE.xlsx", sheetName = "HvsUT", col.names = TRUE, row.names = TRUE, append = TRUE)
#write.csv(HIMum_DEG_table, file = "./DerivedData/1_Diag_DEG/1_DEG_HIMvUM_LFC1p05.csv", quote = FALSE, row.names = TRUE)
 
HVsUT_DEG_table_split <- split (HVsUT_DEG_table, HVsUT_DEG_table$diffexpressed)

HVsUTDOWN <- c(HVsUT_DEG_table_split$DOWN)
HVsUTDFDOWN <-as.data.frame(HVsUTDOWN, row.names = HVsUTDOWN$entrez)
HVsUTDFUP <- c (HVsUT_DEG_table_split$UP)
HVsUTDFUP.UM <- as.data.frame (HVsUTDFUP, row.names = HVsUTDFUP$entrez)
#write.csv(DFUP.UM, file = "./DerivedData/1_Diag_DEG/1_DEG_HIMvumUP_LFC1p05.csv", quote = FALSE, row.names = TRUE)
```

```{r}
IMVsUT$entrez = mapIds (org.At.tair.db, keys = row.names (IMVsUT) , keytype = "TAIR" , column = "ENTREZID" , multiVals = "first" )
IMVsUT$symbol <- mapIds (org.At.tair.db, keys = row.names (IMVsUT), keytype = "TAIR", column = "SYMBOL", multiVals = "first")

IMVsUT <- IMVsUT %>% as.data.frame() %>% rownames_to_column (., var = "rowname") %>% as_tibble() %>% na.omit() 

#write.csv(HvIM.UM, file = "./DerivedData/1_Diag_DEG/1_DEG_HvIMvum_NoFilters.csv", quote = FALSE, row.names = TRUE)
 
pad = 0.05
IMVsUT_DEG_table <- IMVsUT %>% mutate (diffexpressed = case_when (
  log2FoldChange > 1 &   padj < pad ~ 'UP',
  log2FoldChange < -1 &   padj < pad ~ 'DOWN',
  padj > pad ~ 'NO' )) %>% na.omit() 
#view(HIM_DEG_table)

IMVsUT_DEG_table <-IMVsUT_DEG_table [IMVsUT_DEG_table$diffexpressed != 'NO', ] 
unique (IMVsUT_DEG_table$diffexpressed)
#write.csv(HIMum_DEG_table, file = "./DerivedData/1_Diag_DEG/1_DEG_HIMvUM_LFC1p05.csv", quote = FALSE, row.names = TRUE)
 
IMVsUT_DEG_table_split <- split (IMVsUT_DEG_table, IMVsUT_DEG_table$diffexpressed)

IMVsUTDOWN <- c(IMVsUT_DEG_table_split$DOWN)
IMVsUTDOWN <-as.data.frame(IMVsUTDOWN, row.names = IMVsUTDOWN$entrez)
IMVsUTUP <- c (IMVsUT_DEG_table_split$UP)
IMVsUTUP.UM <- as.data.frame (IMVsUTUP, row.names = IMVsUTUP$entrez)
#write.csv(DFUP.UM, file = "./DerivedData/1_Diag_DEG/1_DEG_HIMvumUP_LFC1p05.csv", quote = FALSE, row.names = TRUE)
```

```{r}
ITvsUT$entrez = mapIds (org.At.tair.db, keys = row.names (ITvsUT) , keytype = "TAIR" , column = "ENTREZID" , multiVals = "first" )
ITvsUT$symbol <- mapIds (org.At.tair.db, keys = row.names (ITvsUT), keytype = "TAIR", column = "SYMBOL", multiVals = "first")

ITvsUT <- ITvsUT %>% as.data.frame() %>% rownames_to_column (., var = "rowname") %>% as_tibble() %>% na.omit() 

#write.csv(HvIM.UM, file = "./DerivedData/1_Diag_DEG/1_DEG_HvIMvum_NoFilters.csv", quote = FALSE, row.names = TRUE)
 
pad = 0.05
ITvsUT_DEG_table <- ITvsUT %>% mutate (diffexpressed = case_when (
  log2FoldChange > 1 &   padj < pad ~ 'UP',
  log2FoldChange < -1 &   padj < pad ~ 'DOWN',
  padj > pad ~ 'NO' )) %>% na.omit() 
#view(HIM_DEG_table)

ITvsUT_DEG_table <-ITvsUT_DEG_table [ITvsUT_DEG_table$diffexpressed != 'NO', ] 
unique (ITvsUT_DEG_table$diffexpressed)
#write.csv(HIMum_DEG_table, file = "./DerivedData/1_Diag_DEG/1_DEG_HIMvUM_LFC1p05.csv", quote = FALSE, row.names = TRUE)
 
ITvsUT_DEG_table_split <- split (ITvsUT_DEG_table, ITvsUT_DEG_table$diffexpressed)

ITvsUTDOWN <- c(ITvsUT_DEG_table_split$DOWN)
ITvsUTDFDOWN <-as.data.frame(ITvsUTDOWN, row.names = ITvsUTDOWN$entrez)
ITvsUTDFUP <- c (ITvsUT_DEG_table_split$UP)
ITvsUTUP.UM <- as.data.frame (ITvsUTDFUP, row.names = ITvsUTDFUP$entrez)
```



```{r}
UMvsUT$entrez = mapIds (org.At.tair.db, keys = row.names (UMvsUT) , keytype = "TAIR" , column = "ENTREZID" , multiVals = "first" )
UMvsUT$symbol <- mapIds (org.At.tair.db, keys = row.names (UMvsUT), keytype = "TAIR", column = "SYMBOL", multiVals = "first")

UMvsUT <- UMvsUT %>% as.data.frame() %>% rownames_to_column (., var = "rowname") %>% as_tibble() %>% na.omit() 

#write.csv(HvIM.UM, file = "./DerivedData/1_Diag_DEG/1_DEG_HvIMvum_NoFilters.csv", quote = FALSE, row.names = TRUE)
 
pad = 0.05
UMvsUT_DEG_table <- UMvsUT %>% mutate (diffexpressed = case_when (
  log2FoldChange > 1 &   padj < pad ~ 'UP',
  log2FoldChange < -1 &   padj < pad ~ 'DOWN',
  padj > pad ~ 'NO' )) %>% na.omit() 
#view(HIM_DEG_table)

UMvsUT_DEG_table <-UMvsUT_DEG_table [UMvsUT_DEG_table$diffexpressed != 'NO', ] 
unique (UMvsUT_DEG_table$diffexpressed)
#write.csv(HIMum_DEG_table, file = "./DerivedData/1_Diag_DEG/1_DEG_HIMvUM_LFC1p05.csv", quote = FALSE, row.names = TRUE)
 
UMvsUT_DEG_table_split <- split (UMvsUT_DEG_table, UMvsUT_DEG_table$diffexpressed)

UMvsUTDOWN <- c(UMvsUT_DEG_table_split$DOWN)
UMvsUTDFDOWN <-as.data.frame(UMvsUTDOWN, row.names = UMvsUTDOWN$entrez)
UMvsUTDFUP <- c (UMvsUT_DEG_table_split$UP)
UMvsUTDFUP.UM <- as.data.frame (UMvsUTDFUP, row.names = UMvsUTDFUP$entrez)
#write.csv(DFUP.UM, file = "./DerivedData/1_Diag_DEG/1_DEG_HIMvumUP_LFC1p05.csv", quote = FALSE, row.names = TRUE)
```


#write.xlsx (eGO1, file = "./DerivedData/6_NMET_GO.xlsx", sheetName = "IM UP", col.names = TRUE, row.names = FALSE, append = FALSE)

# Add a second data set in a new worksheet
#write.xlsx (eGO2, file = "./DerivedData/6_NMET_GO.xlsx", sheetName = "H UP", row.names = FALSE, append = TRUE)

#write.xlsx (eGO3, file = "./DerivedData/6_NMET_GO.xlsx", sheetName = "HIM UP", row.names = FALSE, append = TRUE)

#write.xlsx (eGO4, file = "./DerivedData/6_NMET_GO.xlsx", sheetName = "IM DOWN", row.names = FALSE, append = TRUE)

#write.xlsx(eGO5, file = "./DerivedData/6_NMET_GO.xlsx", sheetName = "H DOWN", row.names = FALSE, append = TRUE)

#write.xlsx(eGO6, file = "./DerivedData/6_NMET_GO.xlsx", sheetName = "HIM DOWN", row.names = FALSE, append = TRUE)

```{r}
#length (H_DF$rowname) <- length (HvIM.UM$rowname)
ven <- VennDetail::venndetail (list (UMvsIM = UMVsIM1$entrez, UMVsH = UMVsH1$entrez, UTvsIT= UTvsIT2$entrez))
#plot(ven, type = "venn", order = TRUE, textsize = 3)
plot(ven, type = "venn", col = c("#1b9e77", "#d95f02","pink"), sep = "_",
mycol = c("#1b9e77", "#d95f02","pink"), cat.cex = 1.5, alpha = 0.5, cex = 2,
cat.fontface = "bold", margin = 0.05, text.scale = c(1.5, 1.5), filename = NULL, piecolor = NULL,
revcolor = "blue", any = NULL, show.number = TRUE,
show.x = TRUE, log = FALSE, base = NULL, percentage = FALSE,
sets.x.label = "Set Size", mainbar.y.label = "Intersection Size",
nintersects = 3, abbr = TRUE, abbr.method = "both.sides",
minlength = 3)
dev.copy2pdf(file="./1_deseq/1_Venn_trapCLE_LFC1p05.pdf")
```
```{r}
VennDetail::detail(ven)
VennDetail::dplot(ven)
#dev.copy2pdf(file="./1_deseq/1_Venn_trapCLE_LFC1p05_2.pdf")

HIM_venlist<- VennDetail::getSet(ven, "HIM")
VennDetail::make.subset(ven, "HIM")
VennDetail::result(ven)
VennDetail::vennpie(ven)
```



```{r Gene Expression}
d <- plotCounts(results_object, 
                 gene = "AT5G49630", 
                 intgroup = "Groups", 
                 returnData = TRUE)

# Create plot with jittered points and gene labels
ggplot (d, aes (x = Groups, y = count, color = Groups)) +
  geom_point (position = position_jitter (w = 0.1, h = 0)) +
  geom_text_repel (aes (label = rownames (d))) +
  theme_bw () +
  ggtitle ("AT5G49630 Expression") +
  theme (plot.title = element_text (hjust = 0.5))
#ggsave("./SumData/1_Diag_DEG/1_countData_AT1G21890.pdf")

d <- plotCounts(results_object, 
                 gene = "AT3G18780", 
                 intgroup = "Groups", 
                 returnData = TRUE)

# Create plot with jittered points and gene labels
ggplot (d, aes (x = Groups, y = count, color = Groups)) +
  geom_point (position = position_jitter (w = 0.1, h = 0)) +
  geom_text_repel (aes (label = rownames (d))) +
  theme_bw () +
  ggtitle ("	AT3G18780 Expression") +
  theme (plot.title = element_text (hjust = 0.5))
```


```{r}
k <- pheatmap (hm.mat_DGEgenes, scale = "row", kmeans_k = 10)
clusterDF <- as.data.frame (factor (k$kmeans$cluster))
colnames (clusterDF) <- "Cluster"
clusterDF [1:10, , drop = FALSE]

OrderByCluster <- hm.mat_DGEgenes [order (clusterDF$Cluster), ]
pheatmap (OrderByCluster, scale = "row", annotation_row = clusterDF, show_rownames = FALSE,
    cluster_rows = FALSE)
```


```{r}
library (NbClust)
rowScaledMat <- t(scale (t(OrderByCluster)))
clusterNum <- NbClust (rowScaledMat, distance = "euclidean", min.nc = 2, max.nc = 12,
    method = "kmeans", index = "silhouette")
clusterNum$Best.nc
clusterNum$Best.partition[1:10]
orderedCluster <- sort(clusterNum$Best.partition)
OrderByCluster <- OrderByCluster [match(names(orderedCluster), rownames(OrderByCluster)), ]
pheatmap(OrderByCluster, scale = "row", annotation_row = clusterDF, show_rownames = FALSE,
    cluster_rows = FALSE)
```


```{r H v UM DEGS}
pad <- 0.05
UMvsH <- results (results_object, c( "Groups", "H", "UM" ))

# Map TAIR IDs to ENTREZ IDs
UMvsH$entrez <- mapIds (org.At.tair.db, keys = row.names (UMvsH), keytype = "TAIR", column = "ENTREZID", multiVals = "first") 
UMvsH$symbol <- mapIds (org.At.tair.db, keys = row.names (UMvsH), keytype = "TAIR", column = "SYMBOL", multiVals = "first")

H_DF <- UMvsH %>% 
  as.data.frame() %>% rownames_to_column (., var = "rowname") %>% as_tibble() %>% na.omit()
#write.csv (H_DF, file = "./DerivedData/1_Diag_DEG/1_DEG_HvUM_NoFilters.csv", quote = FALSE, row.names = TRUE)
 
H_DEG_table <- H_DF %>% 
  mutate (diffexpressed = case_when (
  log2FoldChange > 1 &   padj < pad ~ 'H_UP',
  log2FoldChange < -1 &   padj < pad ~ 'H_DOWN',
  padj > pad ~ 'NO' ))  %>%  na.omit()

H_DEG_table <- H_DEG_table [H_DEG_table$diffexpressed != 'NO', ] # Remove non-significant genes

# Substitute names so they are annotated nicely in the heat map later
unique (H_DEG_table$diffexpressed)
#write.csv (H_DEG_table, file = "./DerivedData/1_Diag_DEG/1_DEG_HvUM_LFC1p05.csv", quote = FALSE, row.names = TRUE)

# Split the data frame into sub-data frames: up/down regulated genes
H_results_split <- split (H_DEG_table, H_DEG_table$diffexpressed)
HDOWN <- c (H_results_split$H_DOWN)
HDOWN <- as.data.frame (HDOWN, row.names = HDOWN$entrez)
HUP <- c (H_results_split$H_UP)
HUP <- as.data.frame (HUP, row.names = HUP$entrez)


write.xlsx(as.data.frame(H_DEG_table), file = "./DerivedData/6_vsUTandUM.xlsx", sheetName = "H vs UM", col.names = TRUE, row.names = FALSE, append = FALSE)
# Add a second data set in a new worksheet
#write.xlsx (as.data.frame(submod2), file = "./DerivedData/6_NMET_DEG.xlsx", sheetName = "H UP", row.names = FALSE, append = TRUE)
#write.xlsx (as.data.frame(submod3), file = "./DerivedData/6_NMET_DEG.xlsx", sheetName = "HIM UP", row.names = FALSE, append = TRUE)
#write.xlsx (as.data.frame(submod4), file = "./DerivedData/6_NMET_DEG.xlsx", sheetName = "IM DOWN",row.names = FALSE, append = TRUE)
#write.xlsx(as.data.frame(submod5), file = "./DerivedData/6_NMET_DEG.xlsx", sheetName = "H DOWN", row.names = FALSE, append = TRUE)
#write.xlsx(as.data.frame(submod6), file = "./DerivedData/6_NMET_DEG.xlsx", sheetName = "HIM DOWN", row.names = FALSE, append = TRUE)
```


```{r IM V UM DEG}
UMVsIM <- results (results_object, c('Groups', 'IM', 'UM'))

# Map TAIR IDs to ENTREZ IDs
UMVsIM$entrez <- mapIds(org.At.tair.db, keys = row.names(UMVsIM), keytype = "TAIR", column = "ENTREZID", multiVals = "first")
UMVsIM$symbol <- mapIds (org.At.tair.db, keys = row.names (UMVsIM), keytype = "TAIR", column = "SYMBOL", multiVals = "first")

IM_DF <- UMVsIM %>% as.data.frame() %>% rownames_to_column (., var = "rowname") %>% as_tibble() %>%  na.omit()

#write.csv(IM_DF, file = "./DerivedData/1_Diag_DEG/1_DEG_IMvUM_NoFilters.csv", quote = FALSE, row.names = TRUE)
 
IM_DEG_table <- IM_DF %>% mutate (diffexpressed = case_when (
  log2FoldChange > 1 &   padj < pad ~ 'IM_UP',
  log2FoldChange < -1 &   padj < pad ~ 'IM_DOWN',
  padj > pad ~ 'NO' )) %>%  na.omit()

IM_DEG_table <- IM_DEG_table [IM_DEG_table$diffexpressed != 'NO', ] # Remove non-significant genes

# Substitute names so they are annotated nicely in the heat map later
unique (IM_DEG_table$diffexpressed)

#write.csv(IM_DEG_table, file = "./DerivedData/1_Diag_DEG/1_DEG_IMvUM_LFC1p05.csv", quote = FALSE, row.names = TRUE)
 
# Split the data frame into a list of sub-data frames: up-regulated, down regulated genes
IM_results_split <- split (IM_DEG_table, IM_DEG_table$diffexpressed)
IMDOWN <- c(IM_results_split$IM_DOWN)
IMDOWN <- as.data.frame (IMDOWN, row.names = IMDOWN$entrez)
IMUP <- c (IM_results_split$IM_UP)
IMUP <- as.data.frame (IMUP, row.names = IMUP$entrez)

#write.csv (IMUP, file = "./DerivedData/1_Diag_DEG/1_DEG_IMUP_LFC1p05.csv", quote = FALSE, row.names = TRUE)
```


```{r H Vs IM}
HvIM.UM <- results (results_object, contrast = c('Groups', 'H', 'IM'))

HvIM.UM$entrez = mapIds (org.At.tair.db, keys = row.names (HvIM.UM) , keytype = "TAIR" , column = "ENTREZID" , multiVals = "first" )
HvIM.UM$symbol <- mapIds (org.At.tair.db, keys = row.names (HvIM.UM), keytype = "TAIR", column = "SYMBOL", multiVals = "first")

HvIM.UM <- HvIM.UM %>% as.data.frame() %>% rownames_to_column (., var = "rowname") %>% as_tibble() %>% na.omit() 

#write.csv(HvIM.UM, file = "./DerivedData/1_Diag_DEG/1_DEG_HvIMvum_NoFilters.csv", quote = FALSE, row.names = TRUE)
 
HIMum_DEG_table <- HvIM.UM %>% mutate (diffexpressed = case_when (
  log2FoldChange > 1 &   padj < pad ~ 'UP',
  log2FoldChange < -1 &   padj < pad ~ 'DOWN',
  padj > pad ~ 'NO' )) %>% na.omit() 
#view(HIM_DEG_table)

HIMum_DEG_table <- HIMum_DEG_table [HIMum_DEG_table$diffexpressed != 'NO', ] 
unique (HIMum_DEG_table$diffexpressed)
#write.csv(HIMum_DEG_table, file = "./DerivedData/1_Diag_DEG/1_DEG_HIMvUM_LFC1p05.csv", quote = FALSE, row.names = TRUE)
 
DEGum_table_split <- split (HIMum_DEG_table, HIMum_DEG_table$diffexpressed)

DFDOWN.UM <- c(DEGum_table_split$DOWN)
DFDOWN.UM <-as.data.frame(DFDOWN.UM, row.names = DFDOWN.UM$entrez)
DFUP.UM <- c (DEGum_table_split$UP)
DFUP.UM <- as.data.frame (DFUP.UM, row.names = DFUP.UM$entrez)
#write.csv(DFUP.UM, file = "./DerivedData/1_Diag_DEG/1_DEG_HIMvumUP_LFC1p05.csv", quote = FALSE, row.names = TRUE)
```


```{r}
# Average normalized read counts for different conditions
Havg <- as.data.frame(hm.mat_DGEgenes[, c("H-107", "H-108", "H-109", "H-110", "H-111")])
IMavg <- as.data.frame(hm.mat_DGEgenes[, c("IM-206", "IM-207", "IM-208", "IM-209", "IM-210")])
UMavg <- as.data.frame(hm.mat_DGEgenes[, c("UM-204", "UM-208", "UM-213", "UM-214", "UM-215")])
H_means <- rowMeans(Havg)
IM_means <- rowMeans(IMavg)
UM_means <- rowMeans(UMavg)

mlist <- cbind(H_means, IM_means, UM_means) %>% as.data.frame()
set.seed(123)
pheatmap::pheatmap(
  mlist,
  show_rownames = TRUE,
  angle_col = 45,
  color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdYlBu")))(100),
  cluster_rows = TRUE,
  clustering_distance_rows = "correlation",
  cluster_cols = TRUE,
  clustering_distance_cols = "correlation",
  clustering_method = "complete",
  scale = "row",
  kmeans_k = 4
)
# dev.copy2pdf(file = "./SumData/1_hmap_av_clustering_IMvHvUM_v2.pdf")
```

```{r}
# Cluster analysis
set.seed(123)
names(k$kmeans)
str(k)

clusterDF <- as.data.frame(factor(k$kmeans$cluster))
colnames(clusterDF) <- "Cluster"
clusterDF[1:10, , drop = FALSE]
OrderByCluster <- clusterDF %>% arrange(Cluster)

```

```{r}
module_df <- data.frame(
  gene_id = row.names (OrderByCluster),
  clust = clusterDF)  %>% arrange (clusterDF$Cluster)
#view(module_df)
#write.csv(module_df, file= "./DerivedData/1_IMvH2Kclusters_test1.csv", quote=F, row.names=FALSE)
```


```{r CODE CHUNK 9 DEG NUmbers}
plotMA (dds.ds, alpha = 0.01)
plotMA (dds.ds, alpha = 0.05)

#to see how many genes are < to 0.05
table (res$padj < 0.05) 
print (res)

#to see how many genes are < to 0.001
table (res$padj < 0.01) 
print (res)
```


```{r}
#length (H_DF$rowname) <- length (HvIM.UM$rowname)
ven <- VennDetail::venndetail (list (HvsUM = H_DEG_table$entrez, IMvsUM = IM_DEG_table$entrez, HvsIM = HIMum_DEG_table$entrez))
plot(ven, type = "venn", order = TRUE, textsize = 3)
plot(ven, type = "venn", col = c("#1b9e77", "#d95f02", "orchid3"), sep = "_",
mycol = c("#1b9e77", "#d95f02", "orchid3"), cat.cex = 1.5, alpha = 0.5, cex = 2,
cat.fontface = "bold", margin = 0.05, text.scale = c(1.5, 1.5, 1.5), filename = NULL, piecolor = NULL,
revcolor = "blue", any = NULL, show.number = TRUE,
show.x = TRUE, log = FALSE, base = NULL, percentage = FALSE,
sets.x.label = "Set Size", mainbar.y.label = "Intersection Size",
nintersects = 40, abbr = TRUE, abbr.method = "both.sides",
minlength = 3)
#dev.copy2pdf(file = "./SumData/1_Diag_DEG/1_Upset_IMvHvUM.pdf")

```

```{r}
VennDetail::detail(ven)
VennDetail::dplot(ven)

HIM_venlist<- VennDetail::getSet(ven, "HIM")
VennDetail::make.subset(ven, "HIM")
VennDetail::result(ven)
VennDetail::vennpie(ven)
```

```{r}
HIM_uniq_genes <- HIMum_DEG_table %>%
  subset (HIMum_DEG_table$entrez %in% HIM_venlist$Detail) %>%
  as_tibble() %>% 
  na.omit() 

#write.csv(HIM_uniq_genes, file= "./DerivedData/1_Diag_DEG/1_HIM_uniq.csv", quote=F, row.names=FALSE)
```



```{r}

him_uniq<- read_csv("./DerivedData/1_Diag_DEG/1_HIM_uniq.csv")
him_uniq_table <- him_uniq %>% 
  mutate (diffexpressed = case_when (
  log2FoldChange > 1 &   padj < pad ~ 'H_UP',
  log2FoldChange < -1 &   padj < pad ~ 'H_DOWN',
  padj > pad ~ 'NO' ))  %>%  na.omit()

H_DEG_table <- him_uniq_table [him_uniq_table$diffexpressed != 'NO', ] # Remove non-significant genes

# Substitute names so they are annotated nicely in the heat map later
unique (H_DEG_table$diffexpressed)
#write.csv (H_DEG_table, file = "./DerivedData/1_Diag_DEG/1_DEG_HvUM_LFC1p05.csv", quote = FALSE, row.names = TRUE)

# Split the data frame into sub-data frames: up/down regulated genes
H_results_split <- split (H_DEG_table, H_DEG_table$diffexpressed)
HDOWN <- c (H_results_split$H_DOWN)
HDOWN <- as.data.frame (HDOWN, row.names = HDOWN$entrez)
HUP <- c (H_results_split$H_UP)
HUP <- as.data.frame (HUP, row.names = HUP$entrez)
```





