---
title: "TRAP_CLE"
author: "Lili Castillo"
date: "`r Sys.Date()`"touch
output:
  html_notebook:
    toc: true
    toc_depth: 2
    number_sections: true
    theme: readable
---


```{r}
# Clean environment
rm (list = ls (all.names = TRUE)) # will clear all objects including hidden objects
gc () # free up memory and report the memory usage
options (max.print = .Machine$integer.max, scipen = 0, stringsAsFactors = F, dplyr.summarise.inform = F) # avoid truncated output in R console and keep scientific notation

```

```{r setup, message=FALSE}
# Load libraries
library(tidyverse)
library(here)
library(DESeq2)
library(ggrepel)
library(tibble)

# Source scripts
source("scripts/01_read_counts.R")
read.count <- read_counts()
source("scripts/02_sample_metadata.R")
source("scripts/03_deseq_analysis.R")
print(pca_plot)
source("scripts/04_process_DEGs.R")
```


```{r}
source("scripts/05_GO_KEGG.R")
dotplot(combined_GO_all, showCategory=15, title="Combined GO Enrichment") +
  theme(axis.text.y = element_text(size=10))
```


```{r}
library(dplyr)
library(AnnotationDbi)
library(org.At.tair.db)
library(clusterProfiler)
library(GO.db)

extract_transporter_genes_full <- function(deg_df, group_name) {
  
  if(!"Gene_ID" %in% colnames(deg_df)) stop("deg_df must have Gene_ID column")
  
  # ---- GO annotations ----
  go_df <- AnnotationDbi::select(
    org.At.tair.db,
    keys = deg_df$Gene_ID,
    columns = c("GO", "ONTOLOGY"),
    keytype = "TAIR"
  ) %>%
    rowwise() %>%
    mutate(GO_TERM = if(!is.na(GO)) AnnotationDbi::Term(GOTERM[[GO]]) else NA_character_) %>%
    ungroup()
  
  # ---- Gene descriptions ----
  desc_df <- AnnotationDbi::select(
    org.At.tair.db,
    keys = deg_df$Gene_ID,
    columns = c("GENENAME", "SYMBOL"),
    keytype = "TAIR"
  )
  
  # ---- Combine annotations ----
  ann_df <- go_df %>%
    left_join(desc_df, by = c("TAIR" = "TAIR"))
  
  # ---- Transporter keywords ----
  transporter_keywords <- c("transporter", "transport", "symporter", "antiporter", "channel", "pump", "carrier")
  
  ann_df <- ann_df %>%
    rowwise() %>%
    mutate(
      Matched_GO = paste(transporter_keywords[sapply(transporter_keywords, function(k) grepl(k, GO_TERM, ignore.case=TRUE))], collapse="; "),
      Matched_Gene = paste(transporter_keywords[sapply(transporter_keywords, function(k) grepl(k, GENENAME, ignore.case=TRUE))], collapse="; "),
      Matched_Term = paste(c(Matched_GO, Matched_Gene)[c(Matched_GO, Matched_Gene) != ""], collapse="; "),
      Match_Source = paste(
        if(Matched_GO != "") "GO" else NULL,
        if(Matched_Gene != "") "GENENAME" else NULL,
        collapse="; "
      ),
      Group = group_name
    ) %>%
    ungroup() %>%
    filter(Matched_Term != "")
  
  # ---- Join with DEG info safely ----
  transporter_df <- ann_df %>%
    left_join(deg_df, by = c("TAIR" = "Gene_ID"))
  
  # ---- Return without final select to avoid errors ----
  return(transporter_df)
}

# ---- Apply to all DEG lists ----
transporter_genes_DEG_full <- bind_rows(
  lapply(names(deg_lists), function(x) extract_transporter_genes_full(deg_lists[[x]], x))
)

# ---- Save results ----
write.csv(transporter_genes_DEG_full, "results/Transporter_genes_DEG_full.csv", row.names = FALSE)
cat("✅ Transporter gene table saved: results/Transporter_genes_DEG_full.csv\n")

```


```{r}
# ========================================
# Transporter DEG Visualizations
# ========================================

library(dplyr)
library(ggplot2)
library(ggrepel)
library(pheatmap)
library(clusterProfiler)
library(UpSetR)

# transporter_genes_DEG_full
# Must include columns: Gene_ID, Group, log2FoldChange, padj, GO_TERM, Match_Source

# ========================================
# 1. Volcano Plots for each group
# ========================================

groups <- unique(transporter_genes_DEG_full$Group)

for (grp in groups) {

  # Filter the group
  df <- transporter_genes_DEG_full %>% filter(Group == grp)
  
  if(nrow(df) == 0) {
    cat("⚠️ No data for group:", grp, "\n")
    next
  }

  # Remove rows with missing values in key columns
  df <- df %>% filter(!is.na(log2FoldChange) & !is.na(padj))
  if(nrow(df) == 0) {
    cat("⚠️ No valid log2FC/padj for group:", grp, "\n")
    next
  }

  gene_col <- if("Gene_ID" %in% colnames(df)) "Gene_ID" else "TAIR"

  # Add a column for significance
  df <- df %>%
    mutate(Significance = case_when(
      log2FoldChange > 1 & padj <= 0.05  ~ "Up",
      log2FoldChange < -1 & padj <= 0.05 ~ "Down",
      TRUE                               ~ "NS"
    ))

  # Subset for labeling
  df_label <- df %>% filter(abs(log2FoldChange) > 2)

  # Only plot if there is variation in both axes
  if(length(unique(df$log2FoldChange)) < 2) df$log2FoldChange <- df$log2FoldChange + runif(nrow(df), -0.01, 0.01)
  if(length(unique(df$padj)) < 2) df$padj <- df$padj + runif(nrow(df), 0, 0.01)

  # Build plot
  p <- ggplot(df, aes(x = log2FoldChange, y = -log10(padj))) +
    geom_point(aes(color = Significance), size = 2) +
    scale_color_manual(values = c("Up" = "#E41A1C", "Down" = "#377EB8", "NS" = "grey")) +
    labs(title = paste0("Volcano plot: ", grp),
         x = "log2 Fold Change", y = "-log10(padj)") +
    theme_classic()

  if(nrow(df_label) > 0){
    p <- p + geom_text_repel(data = df_label, aes(label = .data[[gene_col]]), size = 3)
  }

  # Save plot
  ggsave(filename = paste0("results/Volcano_", grp, ".png"),
         plot = p, width = 6, height = 5, units = "in", dpi = 150)

  cat("✅ Volcano plot saved for group:", grp, "\n")
}




# ========================================
# 2. Heatmap of normalized counts for transporter genes
# ========================================
library(pheatmap)

# Get unique transporter genes
transporter_genes <- unique(transporter_genes_DEG_full$TAIR)

# Subset normalized counts
heat_counts <- norm.counts[rownames(norm.counts) %in% transporter_genes, ]

# Check if there are enough genes
if(nrow(heat_counts) < 2) {
  cat("⚠️ Not enough transporter genes for heatmap (need at least 2). Only", nrow(heat_counts), "found.\n")
} else {
  # Scale by row
  heat_counts_scaled <- t(scale(t(heat_counts)))
  
  # Plot heatmap
  pheatmap(heat_counts_scaled,
           cluster_rows = TRUE, cluster_cols = TRUE,
           show_rownames = TRUE, show_colnames = TRUE,
           main = "Heatmap: Transporter DEGs",
           filename = "results/Heatmap_Transporter_DEGs.png",
           width = 7, height = 10)
  cat("✅ Heatmap saved: results/Heatmap_Transporter_DEGs.png\n")
}


# ========================================
# 3. GO Dotplot for transporter genes
# ========================================
# Make sure GO enrichment object is available for transporter DEGs
# Example: ego_transporter <- enrichGO(transporter_genes_DEG_full$Gene_ID,
#                                     OrgDb=org.At.tair.db, keyType="TAIR",
#                                     ont="ALL", pAdjustMethod="BH",
#                                     pvalueCutoff=0.05, readable=TRUE)

ego_transporter <- enrichGO(transporter_genes_DEG_full$TAIR,
                            OrgDb=org.At.tair.db, keyType="TAIR",
                            ont="ALL", pAdjustMethod="BH",
                            pvalueCutoff=0.05, readable=TRUE)

dotplot(ego_transporter, showCategory = 15, title = "GO enrichment: Transporter DEGs") +
  theme(axis.text.y = element_text(size = 10))

#ggsave("results/GO_Dotplot_Transporter_DEGs.png", width = 7, height = 6)

# ========================================
# 4. Venn / UpSet plot to compare groups
# ========================================
# Create a list of genes per group
gene_sets <- lapply(groups, function(grp) {
  transporter_genes_DEG_full %>% filter(Group == grp) %>% pull(TAIR) %>% unique()
})
names(gene_sets) <- groups

# UpSet plot
pdf("results/UpSet_Transporter_DEGs.pdf", width = 7, height = 5)
upset(fromList(gene_sets), nsets = length(groups), order.by = "freq")
dev.off()

```


```{r}
source("scripts/06_transporter_DEGs.R")
source("scripts/07vsFourway.R")




```

```{r}


```

```{r}


```

