---
title: "Haustoria TRAP-seq Index"
author: "Iliana Castillo-Machuca | Virginia Tech SPES"
date: "`r Sys.Date()`"
output: 
  html_document:  # Creates HTML (not PDF/Word)
    toc: true # Table of contents (clickable headers)
    toc_float: true # TOC floats/stays visible when scrolling
    toc_depth: 3 # Headers 1-3 included in TOC (#### excluded)  
    code_folding: hide # Collapse code chunks (click to expand)
    theme: flatly  # Clean dark theme (vs 'default', 'cerulean')
    highlight: tango # Code syntax colors (vs 'default', 'zenburn')
    df_print: paged # Data frames = paginated tables (vs 'kable')
---

## 1.Clean Environment
```{r CLEAN ENVIRONMENT}
## CLean Environment
rm(list = ls(all.names = TRUE)) # Remove all objects from the workspace
gc()  # Garbage collection to free memory

options(
  max.print = .Machine$integer.max, # Avoid truncation of large outputs
  scipen = 0, # Use standard scientific notation
  stringsAsFactors = FALSE, # Do not auto-convert strings to factors
  dplyr.summarise.inform = FALSE, # Suppress dplyr's summaries
  digits = 3 # Number of digits when printing numbers
)

## Print Info
cat("\n")
cat(strrep("=", 80), "\n")
cat("SPLIT-GFP TRAP ANALYSIS + HAUSTORIAL ESTIMATION\n")
cat(strrep("=", 80), "\n")
cat("R Version:", R.version$version.string, "\n")
cat("Initial working directory:", getwd(), "\n")
cat("Timestamp:", format(Sys.time(), "%Y-%m-%d %H:%M:%S"), "\n\n")
```

## 2. Install & Load Packages
```{r packages, message=FALSE, warning=FALSE}
## INSTALL PACKAGES
#install.packages("gt")

## LOAD PACKAGES
suppressPackageStartupMessages({
#library(readr)      # read_table, read_csv
library(tidyverse)  # dplyr, ggplot2, tidyr, purrr, stringr, readr 
#library(ggplot2)
library(gridExtra)
library(readxl)     # read_excel for DESeq2 summary
#library(dplyr)
#library(purrr)
library(DESeq2)
#library(tidyr)
#  library(stringr)
  library(gt)
  library(patchwork)
  library(ggrepel)
})

## SET WKD
cat("Working directory:", getwd(), "\n")
```

## 3. Establish Directories
```{r Directories}
## Replace params with hardcoded paths
graphics_dir <- file.path("Results/Graphics")
tables_dir   <- file.path("Results/Tables") 
procdata_dir <- file.path("Results/Processed_data")

## Create directories
dir_create <- function(x) if (!dir.exists(x)) dir.create(x, recursive = TRUE)
dir_create(graphics_dir)
dir_create(tables_dir) 
dir_create(procdata_dir)

## PRINT
cat("✅ Directories ready:\n")
cat("- Graphics: ", graphics_dir, "\n")
cat("- Tables:   ", tables_dir, "\n") 
cat("- Proc ", procdata_dir, "\n")
```

## 4. Load Files
```{r load-data}
## GFP Summaries
gfp1_9_summary  <- read.table("../Bowtie/GFP1_9_mapping_summary.tsv",  header=TRUE, sep="\t")
gfp10_11_summary <- read.table("../Bowtie/GFP10_11_mapping_summary.tsv", header=TRUE, sep="\t")
### maybe change this to readr::read_tsv() for safer load


## featureCounts
featcount <- read_tsv("../HvIM/Data_Repository/featcount.txt", skip = 1)
gene_ids <- featcount[[1]]
read.count <- as.matrix(featcount[, 7:ncol(featcount)]) ##this line may break
rownames(read.count) <- gene_ids
```

## 5. Clean Data
```{r Clean-Data}
## Clean colnames (remove .bam paths)
colnames(read.count) <- gsub(".*\\/|\\..*Aligned.*", "", colnames(read.count))
sample_names <- c(
  "IT-107","IT-108","IT-109","IT-110",
  "H-107","H-108","H-109","H-110","H-111",
  "UT-106","UT-108","UT-114",
  "IT-206","IT-207","IT-208","IT-209",
  "IM-206","IM-207","IM-208","IM-209","IM-210",
  "UT-204","UT-208","UT-213","UT-214",
  "UM-204","UM-208","UM-213","UM-214","UM-215"
)
stopifnot(
  length(sample_names) == ncol(read.count),
  nrow(gfp1_9_summary) == length(sample_names),
  nrow(gfp10_11_summary) == length(sample_names)
)
colnames(read.count) <- sample_names
gfp1_9_summary$sample_id  <- sample_names
gfp10_11_summary$sample_id <- sample_names

cat("Counts:", nrow(read.count), "genes x", ncol(read.count), "samples\n")

## METADATA
sample_info <- tibble(sample_id = colnames(read.count)) %>%
  mutate(
    extraction = if_else(str_detect(sample_id, "^(H|IM|UM)-"), "TRAP", "CLE"),
    trt = case_when(
      str_detect(sample_id, "^H-")  ~ "H",
      str_detect(sample_id, "^IM-") ~ "IM",
      str_detect(sample_id, "^UM-") ~ "UM",
      str_detect(sample_id, "^IT-") ~ "IT",
      str_detect(sample_id, "^UT-") ~ "UT",
      TRUE ~ NA_character_
    ),
    line = case_when(
      str_detect(sample_id, "^H-") ~ "DMR6pPETEp",
      str_detect(sample_id, "^(IM|UM)-") ~ "35SpPETEp",
      TRUE ~ "bulk"
    )
  )

sample_info$trt <- factor(sample_info$trt, levels = c("UM","UT","IM","IT","H"))
sample_info <- as.data.frame(sample_info)
rownames(sample_info) <- sample_info$sample_id

stopifnot(all(rownames(sample_info) == colnames(read.count)))
table(sample_info$trt, sample_info$extraction)

## WRITE EXCEL
#writexl::write_xlsx(gfp1_9_summary, file.path(tables_dir, "gfp1_9_summary.xlsx"))
#writexl::write_xlsx(gfp10_11_summary, file.path(tables_dir, "gfp10_11_summary.xlsx"))

## SUBSET
subset_groups <- function(df) df %>% filter(str_detect(sample_id, "^(H|IM|UM)-"))
gfp1_9_h_im_um  <- subset_groups(gfp1_9_summary)
gfp10_11_h_im_um <- subset_groups(gfp10_11_summary)

subset_info <- function(sample_info) sample_info %>% filter(str_detect(sample_id, "^(H|IM|UM)-"))
HvUMvIM_info <- subset_info(sample_info)
```

## 6. QC Barplot
```{r}
## ADD PERCENTS
add_pct <- function(df, mapped_col) {
  stopifnot("total_reads" %in% colnames(df))
  stopifnot(mapped_col %in% colnames(df))

  df %>%
    mutate(mapped_pct = .data[[mapped_col]] / total_reads * 100)
}

gfp1_9_percent <- add_pct(gfp1_9_h_im_um, "GFP1_9_mapped_reads") 
gfp10_11_percent <- add_pct(gfp10_11_h_im_um, "GFP10_11_mapped_reads")

# Define Colors
colors <- c(
  "H"  = "#56B4E9",
  "IM" = "#E69FBC",
  "UM" = "#8C8C8C",
  "UT" = "gray",
  "IT" = "gray"
)

# Extract sample group for each sample
gfp1_9_percent <- gfp1_9_percent %>%
  mutate(trt = str_extract(sample_id, "^(H|IM|UM)"))
gfp10_11_percent <- gfp10_11_percent %>%
  mutate(trt = str_extract(sample_id, "^(H|IM|UM)"))

## PLOTTING
ggplot(gfp1_9_percent,
       aes(x = sample_id, y = mapped_pct, fill = trt)) +
  geom_col() +
  scale_fill_manual(values = colors) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(
    title = "GFP1-9 Mapping Summary",
    y = "Percent of reads mapping to GFP1-9",
    x = NULL,
    fill = "Sample type"
  )
ggsave(file.path(graphics_dir, "GFP1-9_percentage.png"), width = 10, height = 8, dpi = 300)

ggplot(gfp10_11_percent,
       aes(x = sample_id, y = mapped_pct, fill = trt)) +
  geom_col() +
  scale_fill_manual(values = colors) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(
    title = "GFP10-11 Mapping Summary",
    y = "Percent of reads mapping to GFP10-11",
    x = NULL,
    fill = "Sample type"
  )
ggsave(file.path(graphics_dir, "GFP10_11_percentage.png"), width = 10, height = 8, dpi = 300)

## COMBINED PLOT
df_combined <- bind_rows(
  gfp1_9_percent  %>% mutate(GFP = "GFP1-9"),
  gfp10_11_percent %>% mutate(GFP = "GFP10-11")
)
df_combined$trt <- factor(df_combined$trt, levels = c("UM","IM","H"))

ggplot(df_combined, aes(x = trt, y = mapped_pct, fill = trt)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(aes(color = trt), width = 0.2, size = 2, alpha = 0.8) +
  facet_wrap(~GFP, scales = "free_y") +
  scale_fill_manual(values = colors) +
  scale_color_manual(values = colors) +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(
    title = "H vs IM vs UM: GFP mapping",
    y = "Percent of reads mapping",
    x = "Condition"
  )

ggsave(file.path(graphics_dir, "combined_percentage.png"), width = 10, height = 8, dpi = 300)

```

## 7. Boxplot
```{r}
add_condition <- function(df, mapped_col, gfp_label){
  stopifnot(mapped_col %in% colnames(df))
  stopifnot("total_reads" %in% colnames(df))
  stopifnot("sample_id" %in% colnames(df))
  df %>%
    mutate(
      condition = case_when(
        str_detect(sample_id, "^H-")  ~ "H",
        str_detect(sample_id, "^IM-") ~ "IM",
        str_detect(sample_id, "^UM-") ~ "UM",
        TRUE ~ NA_character_
      ),
      GFP = gfp_label,
      mapped_pct = .data[[mapped_col]] / total_reads * 100
    )
}

gfp1_9_long  <- add_condition(gfp1_9_h_im_um,  "GFP1_9_mapped_reads",  "GFP1-9")   # fixed label
gfp10_11_long <- add_condition(gfp10_11_h_im_um, "GFP10_11_mapped_reads", "GFP10-11")

gfp_long <- bind_rows(gfp1_9_long, gfp10_11_long) %>%
  mutate(condition = factor(condition, levels = c("UM", "IM", "H")))
#levels(gfp_long$condition)


ggplot(gfp_long, aes(condition, mapped_pct, fill = GFP)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_jitter(aes(color = GFP), width = 0.2, size = 2, alpha = 0.8) +
  facet_wrap(~GFP, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(title = "H vs IM vs UM: GFP mapping", y = "Percent of reads mapping", x = "Condition")

gfp_stats <- gfp_long %>%
  group_by(GFP, condition) %>%
  summarise(
    n = n(),
    median_pct = median(mapped_pct, na.rm = TRUE),
    mean_pct   = mean(mapped_pct, na.rm = TRUE),
    q25 = quantile(mapped_pct, 0.25, na.rm = TRUE),
    q75 = quantile(mapped_pct, 0.75, na.rm = TRUE),
    .groups = "drop"
  )

gt(gfp_stats)
ggsave(file.path(graphics_dir, "GFP_mapping_stats.png"), width = 10, height = 8, dpi = 300)
```

## 9. IM Clean Up by GFP-DMR6 Reads
```{r IM Clean Up}
# Subset TRAP
trap_cols <- grep("^(H|IM|UM)-", colnames(read.count), value = TRUE)
trap.count <- read.count[, trap_cols, drop = FALSE]

# Indices
h_idx  <- grep("^H-",  colnames(trap.count))
im_idx <- grep("^IM-", colnames(trap.count))

# H profile
h_mat     <- trap.count[, h_idx, drop = FALSE]
h_profile <- rowMeans(h_mat, na.rm = TRUE)
h_comp    <- h_profile / sum(h_profile, na.rm = TRUE)

# Ensure h_comp matches trap.count row order
h_comp_vec <- h_comp[rownames(trap.count)]
h_comp_vec[is.na(h_comp_vec)] <- 0  # safety

# GFP fractions
gfp_h  <- gfp1_9_percent$mapped_pct[str_detect(gfp1_9_percent$sample_id, "^H-")]
gfp_im <- gfp1_9_percent$mapped_pct[str_detect(gfp1_9_percent$sample_id, "^IM-")]
gfp_um <- gfp1_9_percent$mapped_pct[str_detect(gfp1_9_percent$sample_id, "^UM-")]

# UM baseline
um_ref <- median(gfp_um, na.rm = TRUE)

# Baseline-corrected fractions
gfp_h_corr  <- pmax(0, gfp_h - um_ref)   # H baseline-corrected
gfp_im_corr <- pmax(0, gfp_im - um_ref)  # IM baseline-corrected

# H reference
h_ref <- median(gfp_h_corr, na.rm = TRUE)

# Compute contamination fractions for IM
im_extra   <- gfp_im_corr
haust_frac <- pmin(im_extra / h_ref, 1)  # Cap at 100%
stopifnot(length(haust_frac) == length(im_idx))

trap.count.clean <- trap.count
```


```{r IM Clean Up}
## Clean Up
# IM cleanup: subtract H contamination per replicate
im_lib_sizes <- colSums(trap.count.clean[, im_idx, drop = FALSE])

im_subtract <- sweep(
  matrix(h_comp_vec, nrow = nrow(trap.count.clean), ncol = length(im_idx)),
  2,
  im_lib_sizes * haust_frac,
  `*`
) 
trap.count.clean[, im_idx] <- pmax(
  0,
  trap.count.clean[, im_idx] - im_subtract
)

# H cleanup: subtract UM baseline
h_lib_sizes <- colSums(trap.count.clean[, h_idx, drop = FALSE])

h_subtract <- sweep(
  matrix(h_comp_vec, nrow = nrow(trap.count.clean), ncol = length(h_idx)),
  2,
  (um_ref / 100) * h_lib_sizes,
  `*`
)

trap.count.clean[, h_idx] <- pmax(
  0,
  trap.count.clean[, h_idx] - h_subtract
)

# Validation: check top100 H genes in IM
top100 <- names(sort(h_profile, decreasing = TRUE))[1:100]

cat("Top100 H genes in IM:", 
    round(mean(rowMeans(read.count[top100, im_idx, drop = FALSE])), 2),
    "→", 
    round(mean(rowMeans(trap.count[top100, im_idx, drop = FALSE])), 2), "\n")
```
```{r}
## EXTRACT TRAP for DESeq2
HvUMvIM_info <- HvUMvIM_info[match(colnames(trap.count), rownames(HvUMvIM_info)), , drop=FALSE]

dds_trap <- DESeqDataSetFromMatrix(
  countData = round(trap.count.clean),
  colData   = HvUMvIM_info,
  design    = ~ trt
)

dds_trap <- DESeq(dds_trap)
resultsNames(dds_trap)
```

```{r}
resultsNames(dds_trap)  # Lists contrasts
summary(results(dds_trap, name="trt_IM_vs_UM"))

res_IM_UM <- results(dds_trap, name="trt_IM_vs_UM", alpha=0.05)
res_H_UM  <- results(dds_trap, name="trt_H_vs_UM", alpha=0.05)

cat("IM vs UM DEGs (padj<0.05):", sum(res_IM_UM$padj < 0.05, na.rm=TRUE), "\n")
cat("H vs UM DEGs (padj<0.05):", sum(res_H_UM$padj < 0.05, na.rm=TRUE), "\n")
```


```{r}
vsd <- vst(dds_trap, blind=TRUE)

# Sample distances
dists <- dist(t(assay(vsd)))
mat   <- as.matrix(dists)
pheatmap::pheatmap(mat, annotation_col=as.data.frame(colData(vsd)))

# Add sample names to DESeq2 PCA
pca_data <- plotPCA(vsd, intgroup="trt", returnData=TRUE)
percentVar <- round(100 * attr(pca_data, "percentVar"))

pca_data$label <- colnames(vsd)  # or gsub("-","_", colnames(vsd))

ggplot(pca_data, aes(PC1, PC2, color=trt, shape=trt)) +
  geom_point(size=4) +
  geom_text_repel(aes(label=label), size=3, box.padding=0.3) +
  labs(x=paste0("PC1: ", round(percentVar[1]), "%"), 
       y=paste0("PC2: ", round(percentVar[2]), "%"))  +
  ggtitle("TRAP-seq PCA (H vs IM vs UM)") +
  theme_minimal()
ggsave("TRAP_PCA_labeled.pdf", width=10, height=8)
```
```


```{r}
## GFP Table
im_data <- data.frame(
  Sample = paste0("IM-", 206:210),
  GFP1_9_raw = round(gfp_im * 100, 2),
  UM_baseline = round(um_ref * 100, 2),
  H_ref = round(h_ref * 100, 2),
  Excess = round((gfp_im - um_ref) * 100, 2),
  Haust_frac = paste0(round(haust_frac * 100, 1), "%")
)


# Library sizes (working)
lib_sizes <- colSums(trap.count[, grep("^IM-", colnames(trap.count))])
print(data.frame(Sample=names(lib_sizes), LibSize=round(lib_sizes/1e6, 1), Haust_frac=round(haust_frac*100,1)))

# FIXED: Cosine similarity per SAMPLE (not per gene)
cos_sim_sample <- function(sample_col, ref_vec) {
  x <- sample_col[is.finite(sample_col)]
  ref <- ref_vec[is.finite(ref_vec)]
  common <- intersect(names(x), names(ref))
  if(length(common) < 10) return(NA)
  x <- x[common]
  ref <- ref[common]
  if(sum(x^2) < 1e-6 || sum(ref^2) < 1e-6) return(NA)
  sum(x * ref) / sqrt(sum(x^2) * sum(ref^2))
}

# Exact gene match
common_genes <- intersect(names(h_profile), rownames(read.count))
common_genes <- intersect(common_genes, rownames(assay(vsd))) ##broke???
h_ref_safe <- h_profile[common_genes][1:100]  # Top 100 genes

im_cols <- grep("^IM-", colnames(read.count), value=TRUE)

# Compute similarity PER SAMPLE (correct!)
before_sim <- sapply(im_cols, function(col) {
  cos_sim_sample(read.count[names(h_ref_safe), col], h_ref_safe)
})

after_sim <- sapply(im_cols, function(col) {
  cos_sim_sample(trap.count[names(h_ref_safe), col], h_ref_safe)
})


# Results
results_table <- data.frame(
  Sample = im_cols,
  GFP_pct = round(gfp_im * 100, 1),
  Cleanup_pct = round(haust_frac * 100, 1),
  Raw_Hsim = round(before_sim, 3),
  Clean_Hsim = round(after_sim, 3),
  Drop = round(before_sim - after_sim, 3)
)

print(results_table[order(results_table$Clean_Hsim), ])


```


## 10. DESeq
```{r}
## EXTRACT TRAP for DESeq2
HvUMvIM_inf <- HvUMvIM_inf[match(colnames(trap.count), rownames(HvUMvIM_inf)), , drop=FALSE]
# simply:
HvUMvIM_inf <- HvUMvIM_inf[trap_samples, , drop=FALSE]

dds_trap <- DESeqDataSetFromMatrix(
  countData = round(trap.count),
  colData   = sample_info_trap,
  design    = ~ trt
)

dds_trap <- DESeq(dds_trap)
resultsNames(dds_trap)
```


```{r}
resultsNames(dds_trap)  # Lists contrasts
summary(results(dds_trap, name="trt_IM_vs_UM"))

res_IM_UM <- results(dds_trap, name="trt_IM_vs_UM", alpha=0.05)
res_H_UM  <- results(dds_trap, name="trt_H_vs_UM", alpha=0.05)

cat("IM vs UM DEGs (padj<0.05):", sum(res_IM_UM$padj < 0.05, na.rm=TRUE), "\n")
cat("H vs UM DEGs (padj<0.05):", sum(res_H_UM$padj < 0.05, na.rm=TRUE), "\n")
```


```{r}
vsd <- vst(dds_trap, blind=TRUE)

# Sample distances
dists <- dist(t(assay(vsd)))
mat   <- as.matrix(dists)
pheatmap::pheatmap(mat, annotation_col=as.data.frame(colData(vsd)))
```

```{r}
# Add sample names to DESeq2 PCA
pca_data <- plotPCA(vsd, intgroup="trt", returnData=TRUE)
percentVar <- round(100 * attr(pca_data, "percentVar"))

pca_data$label <- colnames(vsd)  # or gsub("-","_", colnames(vsd))

ggplot(pca_data, aes(PC1, PC2, color=trt, shape=trt)) +
  geom_point(size=4) +
  geom_text_repel(aes(label=label), size=3, box.padding=0.3) +
  labs(x=paste0("PC1: ", round(percentVar[1]), "%"), 
       y=paste0("PC2: ", round(percentVar[2]), "%"))  +
  ggtitle("TRAP-seq PCA (H vs IM vs UM)") +
  theme_minimal()
ggsave("TRAP_PCA_labeled.pdf", width=10, height=8)
```



```{r}
library(ggplot2)

# Volcano (IM vs UM)
res_df <- as.data.frame(res_IM_UM) %>%
  mutate(sig = padj < 0.05 & !is.na(padj))

ggplot(res_df, aes(log2FoldChange, -log10(pvalue), color=sig)) +
  geom_point(alpha=0.6) +
  scale_color_manual(values=c("grey", "red")) +
  labs(title="IM vs UM (cleaned TRAP)") +
  theme_minimal()

```

```{r}
# H-marker heatmap (before/after cleanup)
library(pheatmap)
top100_h <- names(sort(rowMeans(counts(dds_trap)[,grep("^H-", colnames(dds_trap))]), decreasing=TRUE))[1:100]
pheatmap(assay(vsd)[top100_h,], scale="row", main="Top100 H genes (cleaned TRAP)")

library(clusterProfiler)
library(org.At.tair.db)

deg_h_UM <- rownames(res_H_UM)[res_H_UM$padj < 0.05 & !is.na(res_H_UM$padj)]
ego_h <- enrichGO(deg_h_UM, OrgDb="org.At.tair.db", keyType="TAIR", ont="BP")
dotplot(ego_h)

# Your cleanup metrics as publication table
#frac_table <- data.frame(
#  Sample = paste0("IM-",206:210),
#  haust_frac = round(haust_frac, 3),
#  GFP_extra = round(im_extra, 3),
#  removed_pct = round(100*haust_frac, 1)
#)
#write_csv(frac_table, "haustoria_fractions.csv")

```




```{r}
dds_clean <- DESeqDataSetFromMatrix(round(read.count), sample_info, ~ extraction + trt)
dds_clean <- DESeq(dds_clean)

# Key contrasts
res_haus <- results(dds_clean, contrast = c("trt", "H", "UM"))  # Haustoria vs mock mesophyll
res_im_it <- results(dds_clean, contrast = c("trt", "IM", "IT")) # Cleaned mesophyll effect

plotPCA(vst(dds_clean), intgroup = "trt")  # Cleaned IM near IT
volcanoPlot(res_haus)

```



```{r}
## EXTRACT TRAP for DESeq2
trap_samples <- sample_info$extraction == "TRAP"
trap_cols <- rownames(sample_info)[trap_samples]

counts_trap <- round(as.matrix(read.count[, trap_cols, drop = FALSE]))
col_data_trap <- sample_info[trap_samples, , drop = FALSE]

## DESeq2
dds_trap <- DESeqDataSetFromMatrix(
  countData = counts_trap,
  colData = col_data_trap,
  design = ~ trt
)

dds_trap$trt <- relevel(dds_trap$trt, ref = "UM")
dds_trap <- DESeq(dds_trap)
rld_trap <- rlog(dds_trap)
```


```{r}
res_H_UM <- results(dds_trap, contrast=c("trt","H","UM"))
vsd <- vst(dds_trap, blind=FALSE) 

# Define H samples by name
h_samples <- grep("H-", colnames(vsd), value=TRUE)

# Get markers
markers <- rownames(res_H_UM)[res_H_UM$padj < 0.05 & 
                             res_H_UM$log2FoldChange > 1 &
                             rowSums(assay(vsd)[,h_samples]) > 50]

head(sort(res_H_UM$log2FoldChange[res_H_UM$padj < 0.01], decreasing = TRUE), 20)

# Top 50 haustoria markers (highest log2FC)
top_markers <- rownames(res_H_UM)[order(res_H_UM$log2FoldChange, decreasing = TRUE)[1:50]]

# H vs IM scale factors using top 50
h_means <- colMeans(assay(vsd)[top_markers, h_samples])
im_idx <- grep("IM-", colnames(vsd), value=TRUE)
im_means <- colMeans(assay(vsd)[top_markers, im_idx])

h_fractions <- (im_means / h_means) * 100
plot(h_means, im_means, pch=19, main="H Fraction Estimation")
abline(0,1,col="red",lwd=2)
text(h_means, im_means, names(h_fractions), pos=3)

#print(h_fractions)  # H estimates!


plot(h_means, im_means, pch=19, cex=1.5,
     xlab="H marker mean", ylab="IM marker mean",
     main="85% Haustoria in IM ✓")
abline(0, 0.85, col="red", lwd=3)  #  fit line
text(im_means, h_means, names(h_fractions), pos=3)

## H %
print(round(h_means, 3))      # Pure H baseline
print(round(im_means, 3))     # Your IM observations  
print(im_means / h_means * 100)  # 84-91% ✓

```


```{r}
# Show IM vs H GFP1-9
gfp1_9_summary[grep("IM-|H-", gfp1_9_summary$sample_id), 
               c("sample_id", "GFP1_9_mapped_reads", "mapped_pct")]


```


```{r}
# haustoria genes
haustoria_genes <- c(
  "AT5G24530",  # DMR6 
  "AT2G14610",  # PR1
  "AT3G04720",  # PR2 
  "AT4G02380",  # PR5
  "AT1G57520",  # CYP81D8
  "AT2G38470"   # WRKY33
)


haustoria_genes <- intersect(haustoria_genes, rownames(rld_trap))
cat("Using", length(haustoria_genes), "markers\n")

h_mat   <- assay(rld_trap)[haustoria_genes, , drop = FALSE]
h_index <- colMeans(h_mat)

sample_info_trap <- sample_info[trap_samples, ]
sample_info_trap$h_index <- h_index


keep_um <- sample_info_trap$trt == "UM"  # Pure mock mesophyll
h_um_baseline <- mean(sample_info_trap$h_index[keep_um])

h_summary_um <- sample_info_trap %>%
  mutate(H_index_UM = h_index / h_um_baseline) %>%
  group_by(line) %>%
  summarise(mean_H_UM = mean(H_index_UM))


h_summary <- sample_info_trap %>%
  group_by(trt) %>%
  summarise(
    mean_h = mean(h_index),
    se_h = sd(h_index) / sqrt(n()),
    n = n(),
    .groups = "drop"
  ) %>%
  mutate(
    baseline = mean_h[trt == "UM"],  # Store 35S value
    H_index = mean_h / baseline
  ) %>%
  select(-baseline)  # Clean up

print(" Raw H-index (H/IM/UM):")
print(h_summary)
print("UM-baseline H-index (H vs UM):")
print(h_summary_um)


# Export key results
#write_csv(h_summary, file.path(tables_dir, "HAUSTORIA_INDEX.csv"))
#write_csv(sample_info_trap, file.path(tables_dir, "TRAP_METADATA.csv"))


# FIXED p2 plot (use h_summary_um data)
p2_data <- h_summary_um %>%
  mutate(line = as.character(line)) %>%
  bind_rows(data.frame(line = "35SpPETEp", mean_H_UM = 1, se = 0))  # Add baseline

p2 <- ggplot(p2_data, aes(line, mean_H_UM, fill = line)) +
  geom_col(alpha = 0.8) +
  geom_errorbar(aes(ymin = mean_H_UM - se, ymax = mean_H_UM + se), width = 0.2) +
  labs(title = "UM-normalized H-index", y = "H-index (vs UM)") +
  theme_minimal()

grid.arrange(p1, p2, ncol = 2)


```



```{r}
# % GFP1-9 reads = estimated contamination in IM
gfp_contam <- mean(gfp1_9_summary$gfp1_9_pct[gfp1_9_summary$sample == "IM-206"])  # Example
cat("IM H-contamination:", gfp_contam, "\n")

# Raw IM + UM
im_raw <- colMeans(h_mat[, grepl("^IM-", colnames(h_mat))])
um_raw <- mean(h_mat[, grepl("^UM-", colnames(h_mat))])

# Clean IM = (IM - H_contam * H_signal) / (1 - H_contam)
h_signal <- colMeans(h_mat[, grepl("^H-", colnames(h_mat))])
im_clean <- (im_raw - gfp_contam * h_signal) / (1 - gfp_contam)

# Baseline = clean IM + UM average
baseline_clean <- mean(c(im_clean, um_raw))
h_raw <- colMeans(h_mat[, grepl("^H-", colnames(h_mat))])
H_index_clean <- h_raw / baseline_clean

cat("Clean H-index:", H_index_clean, "\n")
h_results <- data.frame(
  Metric = c("Raw IM+UM baseline", "Clean IM+UM baseline", "H-index (raw)", "H-index (clean)"),
  Value = c(1.0, baseline_clean / mean(c(im_raw, um_raw)), h_raw / mean(c(im_raw, um_raw)), H_index_clean)
)
print(h_results)

```



```{r}
## RECALCULATE PERCENT MAPPED AND FLAG LOW-QUALITY SAMPLES 
library(dplyr)
library(ggplot2)

# Recalculate percentages correctly (numeric)
gfp1_9_summary <- gfp1_9_summary %>%
  mutate(mapped_pct_correct = (GFP1_9_mapped_reads / total_reads) * 100)

gfp10_11_summary <- gfp10_11_summary %>%
  mutate(mapped_pct_correct = (GFP10_11_mapped_reads / total_reads) * 100)

# Flag samples with very low mapping (<0.01%)
low_quality_gfp1_9 <- gfp1_9_summary %>% filter(mapped_pct_correct < 0.01)
low_quality_gfp10_11 <- gfp10_11_summary %>% filter(mapped_pct_correct < 0.01)

cat("Low-quality GFP1-9 samples:\n"); print(low_quality_gfp1_9$sample_id)
cat("\nLow-quality GFP10-11 samples:\n"); print(low_quality_gfp10_11$sample_id)

# visualize mapped percentages
gfp_summary_long <- bind_rows(
  gfp1_9_summary %>% select(sample_id, mapped_pct_correct) %>% mutate(Construct = "GFP1-9"),
  gfp10_11_summary %>% select(sample_id, mapped_pct_correct) %>% mutate(Construct = "GFP10-11")
)

ggplot(gfp_summary_long, aes(x = Construct, y = mapped_pct_correct)) +
  geom_boxplot(alpha = 0.6, fill = "lightblue") +
  geom_jitter(width = 0.2, alpha = 0.5, color = "gray30") +
  scale_y_continuous(trans = "log10") +
  theme_minimal() +
  labs(title = "Mapped percentages per construct", y = "Mapped % (log10 scale)", x = "Construct")

```


```{r}
# 4. CLEAN AND MERGE GFP1-9 AND GFP10-11 COUNTS ------------------------------
# Rename columns to consistent names and compute GFP10-11 / GFP1-9 ratio

gfp1_9_clean <- gfp1_9_summary %>%
  rename(
    GFP1_9_mapped     = GFP1_9_mapped_reads,  # mapped GFP1-9 reads
    GFP1_9_total      = total_reads,          # total reads in library
    GFP1_9_pct_mapped = mapped_pct            # % of reads mapping to GFP1-9
  ) %>%
 dplyr::select(sample_id, GFP1_9_mapped, GFP1_9_total, GFP1_9_pct_mapped)

gfp10_11_clean <- gfp10_11_summary %>%
  rename(
    GFP10_11_mapped     = GFP10_11_mapped_reads, # mapped GFP10-11 reads
    GFP10_11_total      = total_reads,           # total reads in library
    GFP10_11_pct_mapped = mapped_pct             # % of reads mapping to GFP10-11
  ) %>%
  dplyr::select(sample_id, GFP10_11_mapped, GFP10_11_total, GFP10_11_pct_mapped)

gfp_combined <- gfp1_9_clean %>%
  inner_join(gfp10_11_clean, by = "sample_id") %>%
  mutate(
    GFP10_11_GFP1_9_ratio = GFP10_11_mapped / pmax(GFP1_9_mapped, 1)
  )


cat("\n=== Combined GFP counts (first 8 rows) ===\n")
print(head(gfp_combined, 8))
cat("\nTotal Bowtie samples:", nrow(gfp_combined), "\n\n")
```


```{r}
# 5. MAP sample_id -> Original name -> NewName -------------------------------
# Bowtie sample_id looks like DIC1_S22_L002; we keep DIC1 and map to IT-107, etc.

name_map <- data.frame(
  Original = c(
    "DIC1","DIC2","DIC3","DIC4","DIC5",
    "DIT1","DIT2","DIT3","DIT4","DIT5",
    "DMC1","DMC2","DMC3",
    "PIC1","PIC2","PIC3","PIC4","PIC5",
    "PIT1","PIT2","PIT3","PIT4","PIT5",
    "PMC1","PMC2","PMC3","PMC4","PMC5",
    "PMT1","PMT2","PMT3","PMT4","PMT5"
  ),
  NewName = c(
    "IT-107","IT-108","IT-109","IT-110","IT-111",
    "H-107","H-108","H-109","H-110","H-111",
    "UT-106","UT-108","UT-114",
    "IT-206","IT-207","IT-208","IT-209","IT-210",
    "IM-206","IM-207","IM-208","IM-209","IM-210",
    "UT-204","UT-208","UT-213","UT-214","UT-215",
    "UM-204","UM-208","UM-213","UM-214","UM-215"
  ),
  stringsAsFactors = FALSE
)

# Strip lane/index suffix from sample_id (e.g. "DIC1_S22_L002" -> "DIC1")
gfp_combined <- gfp_combined %>%
  mutate(Original = sub("_S.*$", "", sample_id)) %>%   # keep prefix before "_S"
  inner_join(name_map, by = "Original") %>%            # attach NewName
  rename(Sample = NewName)                             # final biological sample ID

cat("\n=== gfp_combined with Sample names (first 8 rows) ===\n")
print(head(gfp_combined, 8))

# 6. DEFINE SAMPLE METADATA (sample_info1) -----------------------------------
# Sample -> Group (IT/H/IM/UT/UM), Condition (Infected/Uninfected), Replicate

sample_info1 <- data.frame(
  Sample = c(
    "IT-107","IT-108","IT-109","IT-110",
    "H-107","H-108","H-109","H-110","H-111",
    "UT-106","UT-108","UT-114",
    "IT-206","IT-207","IT-208","IT-209",
    "IM-206","IM-207","IM-208","IM-209","IM-210",
    "UT-204","UT-208","UT-213","UT-214",
    "UM-204","UM-208","UM-213","UM-214","UM-215"
  ),
  Groups = c(
    "IT","IT","IT","IT",
    "H","H","H","H","H",
    "UT","UT","UT",
    "IT","IT","IT","IT",
    "IM","IM","IM","IM","IM",
    "UT","UT","UT","UT",
    "UM","UM","UM","UM","UM"
  ),
  Condition = c(
    "Infected","Infected","Infected","Infected",
    "Infected","Infected","Infected","Infected","Infected",
    "Uninfected","Uninfected","Uninfected",
    "Infected","Infected","Infected","Infected",
    "Infected","Infected","Infected","Infected","Infected",
    "Uninfected","Uninfected","Uninfected","Uninfected",
    "Uninfected","Uninfected","Uninfected","Uninfected","Uninfected"
  ),
  Replicate = c(
    "IT-107","IT-108","IT-109","IT-110",
    "H-107","H-108","H-109","H-110","H-111",
    "UT-106","UT-108","UT-114",
    "IT-206","IT-207","IT-208","IT-209",
    "IM-206","IM-207","IM-208","IM-209","IM-210",
    "UT-204","UT-208","UT-213","UT-214",
    "UM-204","UM-208","UM-213","UM-214","UM-215"
  ),
  stringsAsFactors = FALSE
)

sample_info1$Groups    <- factor(sample_info1$Groups,
                                 levels = c("IT","H","IM","UT","UM"))
sample_info1$Condition <- factor(sample_info1$Condition,
                                 levels = c("Uninfected","Infected"))

cat("\n=== sample_info1 (first 15 rows) ===\n")
print(head(sample_info1, 15))
cat("\nSummary of Groups:\n");    print(table(sample_info1$Groups))
cat("\nSummary of Condition:\n"); print(table(sample_info1$Condition))
```


```{r}
# 7. BUILD gfp_df (MAPPING STATS + METADATA) ---------------------------------
# Join mapping stats and sample metadata by Sample ID

gfp_df <- gfp_combined %>%
  full_join(sample_info1, by = "Sample")

cat("\n=== gfp_df (first 8 rows) ===\n")
print(head(gfp_df, 8))
cat("\nCondition counts in gfp_df:\n")
print(table(gfp_df$Condition))


setdiff(sample_info1$Sample, gfp_combined$Sample)

```


```{r}
# 8. BASIC TESTS ON MAPPED READS --------------------------------------------

cat(strrep("=", 80), "\n")
cat("T-TESTS: Infected vs Uninfected (GFP-mapped reads)\n")
cat(strrep("=", 80), "\n")

cat("\nGFP1-9: Infected vs Uninfected\n")
print(t.test(GFP1_9_mapped ~ Condition, data = gfp_df))

cat("\nGFP10-11: Infected vs Uninfected\n")
print(t.test(GFP10_11_mapped ~ Condition, data = gfp_df))

wilcox.test(GFP1_9_mapped ~ Condition, data = gfp_df)
wilcox.test(GFP10_11_mapped ~ Condition, data = gfp_df)

```


```{r}
# 9. PLOTS: MAPPED READ DISTRIBUTIONS ---------------------------------------

cat(strrep("=", 80), "\n")
cat("PLOTS\n")
cat(strrep("=", 80), "\n")

# Boxplot of GFP1-9 mapped reads by Condition and Group
p1 <- ggplot(gfp_df, aes(x = Condition, y = GFP1_9_mapped, fill = Groups)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(width = 0.2, alpha = 0.5, size = 2, color = "gray30") +
  theme_minimal() +
  labs(
    title = "GFP1-9 mapped reads by Condition and Group",
    x = "Condition",
    y = "GFP1-9 mapped reads",
    fill = "Group"
  )

# Boxplot of GFP10-11 mapped reads
p2 <- ggplot(gfp_df, aes(x = Condition, y = GFP10_11_mapped, fill = Groups)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(width = 0.2, alpha = 0.5, size = 2, color = "gray30") +
  theme_minimal() +
  labs(
    title = "GFP10-11 mapped reads by Condition and Group",
    x = "Condition",
    y = "GFP10-11 mapped reads",
    fill = "Group"
  )

# Scatter: GFP1-9 vs GFP10-11 per sample
p3 <- ggplot(gfp_df, aes(x = GFP1_9_mapped, y = GFP10_11_mapped,
                         color = Condition, shape = Groups)) +
  geom_point(size = 3, alpha = 0.6) +
  theme_minimal() +
  labs(
    title = "GFP1-9 vs GFP10-11 mapped reads",
    x = "GFP1-9 mapped reads",
    y = "GFP10-11 mapped reads"
  )

# Percent mapped to each GFP construct, faceted by Group
p4 <- gfp_df %>%
  dplyr::select(Sample, GFP1_9_pct_mapped, GFP10_11_pct_mapped, Condition, Groups) %>%
  pivot_longer(cols = c(GFP1_9_pct_mapped, GFP10_11_pct_mapped),
               names_to = "Construct", values_to = "pct_mapped") %>%
  mutate(Construct = ifelse(Construct == "GFP1_9_pct_mapped", "GFP1-9", "GFP10-11")) %>%
  ggplot(aes(x = Condition, y = pct_mapped, fill = Construct)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(width = 0.2, alpha = 0.3, size = 1.5) +
  facet_wrap(~ Groups) +
  theme_minimal() +
  labs(
    title = "Percent of reads mapping to split-GFP constructs",
    x = "Condition",
    y = "% of total reads mapped",
    fill = "Construct"
  )

# Print to screen
print(p1); print(p2); print(p3); print(p4)

# Save each plot to PDF
pdf("results/p1.pdf", width = 12, height = 10); print(p1); dev.off()
pdf("results/p2.pdf", width = 12, height = 10); print(p2); dev.off()
pdf("results/p3.pdf", width = 12, height = 10); print(p3); dev.off()
pdf("results/p4.pdf", width = 12, height = 10); print(p4); dev.off()

cat("\nIndividual plots saved to results/p1.pdf, p2.pdf, p3.pdf, p4.pdf\n")

# ============================================================================
# PART 2: HAUSTORIAL GFP1-9 ESTIMATION FROM FEATURECOUNTS + DESEQ2
# ============================================================================

cat("\n")
cat(strrep("=", 80), "\n")
cat("PART 2: HAUSTORIAL GFP1-9 ESTIMATION\n")
cat(strrep("=", 80), "\n")

# 10. BUILD GFP1_9 GENE-LEVEL MATRIX FROM FEATURECOUNTS ---------------------
# featcount.txt is the featureCounts gene x sample output for all libraries

fc <- read.table(
  "~/Desktop/Lab/TRAPseq/HvIM/Data_Repository/featcount.txt",
  header = TRUE, sep = "\t", stringsAsFactors = FALSE
)

# Identify IM and H columns by BAM name patterns (IM: DMC*, H: DIC* with S21-24)
im_cols <- grep("DMC|S19|S20", colnames(fc), value = TRUE)
h_cols  <- grep("DIC|S21|S22|S23|S24", colnames(fc), value = TRUE)

# Rename those columns to match biological names used in sample_info1
colnames(fc)[colnames(fc) %in% im_cols] <- c("IM-206", "IM-207", "IM-208")
colnames(fc)[colnames(fc) %in% h_cols]  <- c("H-107", "H-108", "H-109", "H-110")

# Extract only Geneid and IM/H columns for GFP1-9 haustorial analysis
gfp_counts <- fc[, c("Geneid", "IM-206", "IM-207", "IM-208", "H-107", "H-108", "H-109", "H-110")]

# Save gene x sample GFP1-9 count matrix
write.csv(gfp_counts, "GFP1_9_gene_counts.csv", row.names = FALSE)
cat("Created GFP1_9_gene_counts.csv with", nrow(gfp_counts), "genes\n")

# 11. ESTIMATE HAUSTORIAL GFP1-9 PER GENE (IM - scaled H) -------------------

cat("\n")
cat(strrep("-", 80), "\n")
cat("11. Estimating haustorial GFP1-9 reads (IM minus scaled H)\n")
cat(strrep("-", 80), "\n")

# Load GFP1-9 counts; first column is gene ID
gfp19_counts_file <- "GFP1_9_gene_counts.csv"
gfp19_counts <- read_csv(gfp19_counts_file)
colnames(gfp19_counts)[1] <- "gene_id"

# 11.1 library sizes (total GFP1-9 counts per sample)
lib_sizes <- gfp19_counts %>%
  pivot_longer(-gene_id, names_to = "Sample", values_to = "counts") %>%
  group_by(Sample) %>%
  summarize(lib_gfp19 = sum(counts), .groups = "drop")

cat("\n=== GFP1-9 library sizes (first 10 rows) ===\n")
print(head(lib_sizes, 10))

# 11.2 define IM and H sample vectors from sample_info1
im_samples <- sample_info1 %>%
  filter(Groups == "IM") %>%
  arrange(Replicate) %>%
  pull(Sample)

h_samples <- sample_info1 %>%
  filter(Groups == "H") %>%
  arrange(Replicate) %>%
  pull(Sample)

if (length(im_samples) != length(h_samples)) {
  stop("IM and H sample counts differ; adjust pairing logic.")
}

# Pair IM and H samples in order
pairing <- tibble(
  IM = im_samples,
  H  = h_samples
)

# 11.3 add library sizes per pair; compute scaling factor s = lib(IM)/lib(H)
pairing <- pairing %>%
  left_join(lib_sizes %>% rename(lib_IM = lib_gfp19, IM = Sample), by = "IM") %>%
  left_join(lib_sizes %>% rename(lib_H  = lib_gfp19, H  = Sample), by = "H") %>%
  mutate(scale_s = lib_IM / lib_H)

cat("\n=== IM-H pairing and scale factors ===\n")
print(pairing)

# 11.4 compute G_haust = G_IM - s * G_H for each gene and IM-H pair
counts_long <- gfp19_counts %>%
  pivot_longer(-gene_id, names_to = "Sample", values_to = "counts")

haust_counts_list <- list()  # will collect per-IM haustorial counts

for (i in seq_len(nrow(pairing))) {
  im_name <- pairing$IM[i]
  h_name  <- pairing$H[i]
  s       <- pairing$scale_s[i]

  # Extract IM counts for this IM sample
  im_vec <- counts_long %>%
    filter(Sample == im_name) %>%
    dplyr::select(gene_id, counts) %>%
    rename(im_counts = counts)

  # Extract H counts for the paired H sample
  h_vec <- counts_long %>%
    filter(Sample == h_name) %>%
    dplyr::select(gene_id, counts) %>%
    rename(h_counts = counts)

  # Combine, scale H counts, and compute haustorial GFP1-9
  pair_df <- im_vec %>%
    left_join(h_vec, by = "gene_id") %>%
    mutate(
      h_scaled        = s * h_counts,                 # scaled H counts
      g_haust_raw     = im_counts - h_scaled,         # IM minus scaled H
      g_haust_clamped = pmax(g_haust_raw, 0)          # clamp negatives to 0
    ) %>%
   dplyr::select(gene_id, g_haust_clamped)

  # Name this haustorial column by IM sample
  colname <- paste0("haust_", im_name)
  colnames(pair_df)[2] <- colname

  haust_counts_list[[im_name]] <- pair_df
}

# 11.5 merge haustorial counts from all IM samples and compute mean per gene
haust_counts <- haust_counts_list %>%
  purrr::reduce(dplyr::full_join, by = "gene_id") %>%
  mutate(
    haust_mean = rowMeans(dplyr::select(., starts_with("haust_")), na.rm = TRUE)
  )

cat("\n=== haustorial GFP1-9 counts (first 10 genes) ===\n")
print(head(haust_counts, 10))

# 12. LOAD DESEQ2 SUMMARY AND COMPUTE HAUSTORIA INDEX -----------------------

cat("\n")
cat(strrep("-", 80), "\n")
cat("12. Computing per-gene haustoria index from DESeq2 contrasts\n")
cat(strrep("-", 80), "\n")

# DESeq2 summary from separate script; contains IT vs UT, IM vs UM, H vs UM, IM vs H
deseq_file <- "~/Desktop/Lab/TRAPseq/Deseq2_all_info.xlsx"
deseq_summary <- read_excel(deseq_file, sheet = "Sheet1")

# Rename columns to simpler names (must match what you wrote out)
deseq_summary <- deseq_summary %>%
  rename(
    gene_id       = GeneID,
    lfc_IT_vs_UT  = IT_vs_UT_log2FC,
    p_IT_vs_UT    = IT_vs_UT_padj,
    lfc_IM_vs_UM  = IM_vs_UM_log2FC,
    p_IM_vs_UM    = IM_vs_UM_padj,
    lfc_H_vs_UM   = H_vs_UM_log2FC,
    p_H_vs_UM     = H_vs_UM_padj,
    lfc_H_vs_IM   = IM_vs_H_log2FC,
    p_H_vs_IM     = IM_vs_H_padj
  ) %>%
  mutate(
    # Haustoria index: how much more IM is enriched vs UM than H is vs UM
    haustoria_index_LFC = lfc_IM_vs_UM - lfc_H_vs_UM
  )

cat("\n=== DESeq2 summary with haustoria_index_LFC (first 10 rows) ===\n")
print(head(deseq_summary, 10))

# 13. MERGE HAUSTORIAL COUNTS WITH DESEQ2 AND FILTER GENES ------------------

# 13.1 combined haustorial table
final_haust_table <- haust_counts %>%
  left_join(deseq_summary, by = "gene_id") %>%
  dplyr::select(
    gene_id,
    starts_with("haust_"), haust_mean,
    lfc_IM_vs_UM, p_IM_vs_UM,
    lfc_H_vs_UM, p_H_vs_UM,
    haustoria_index_LFC,
    everything()
  )

cat("\n=== final haustorial table (first 10 rows) ===\n")
print(head(final_haust_table, 10))

# 13.2 example: high-confidence haustorial genes (IM-biased by index)
good_haust_genes <- final_haust_table %>%
  filter(
    lfc_IM_vs_UM > 1,
    p_IM_vs_UM < 0.05,
    haustoria_index_LFC > 0
  ) %>%
  arrange(desc(haustoria_index_LFC))

cat("\n=== high-confidence haustorial genes (IM-biased; first 20) ===\n")
print(head(good_haust_genes, 20))

# 13.3 stricter list: truly haustoria-enriched vs mesophyll
haustoria_enriched_genes <- final_haust_table %>%
  filter(
    haust_mean > 0,                # has haustorial GFP1-9 signal
    lfc_H_vs_UM > 1,               # up in H vs UM
    p_H_vs_UM < 0.05,              # significant in H vs UM
    lfc_IM_vs_UM < lfc_H_vs_UM - 1 # H at least 2-fold more enriched than IM
    # optional: uncomment to require IM not significantly up
    # !(p_IM_vs_UM < 0.05 & lfc_IM_vs_UM > 0)
  ) %>%
  arrange(desc(haust_mean))

cat("\n=== haustoria-enriched vs mesophyll genes (first 20) ===\n")
print(head(haustoria_enriched_genes, 20))

# 13.4 write outputs
write_csv(final_haust_table,            "results/haustorial_GFP1-9_table.csv")
write_csv(good_haust_genes,            "results/haustorial_GFP1-9_high_confidence.csv")
write_csv(haustoria_enriched_genes,    "results/haustorial_GFP1-9_haustoria_enriched_vs_mesophyll.csv")

cat("\nHaustorial GFP1-9 estimation and haustoria index computation complete.\n")
cat("Output tables written to ./results\n")

```

