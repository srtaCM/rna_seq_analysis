---
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    theme: flatly
params:
  data_dir: "data/"
  graphics_dir: "Results/Graphics/"
  tables_dir: "Results/Tables/"

---
# ICM 2024MAY15 DESeq2 Script
# UM v IM v H

```{r clear-env}
# Clean environment
rm (list = ls (all.names = TRUE)) # will clear all objects including hidden objects
gc () # free up memory and report the memory usage
options (max.print = .Machine$integer.max, scipen = 0, stringsAsFactors = F, dplyr.summarise.inform = F) # avoid truncated output in R console and keep scientific notation
```


```{r load-install-packages}
# ===========
# Management
# ===========

# Install missing Bioconductor pkgs if needed (uncomment to run once)
#if (!require("BiocManager", quietly = TRUE)) install.packages("BiocManager")
#BiocManager::install(c("DESeq2", "apeglm", "clusterProfiler", "org.At.tair.db"), update = FALSE, ask = FALSE)

# CRAN pkgs (tidyverse handles most)
#install_if_missing <- function(dplyr) {
#  if (!require(dplyr, character.only = TRUE, quietly = TRUE)) {
#   install.packages(dplyr, dependencies = TRUE)
#    library(dplyr, character.only = TRUE, quietly = TRUE)
#  }
#}

#pkgs_cran <- c("readr", "tidyverse", "ggplot2", "ggrepel", "pheatmap", "writexl", 
#               "dplyr", "RColorBrewer", "gplots", "dendextend", "reshape2", "xlsx")

#invisible(sapply(pkgs_cran, install_if_missing))

# Bioc pkgs (quiet load)
suppressPackageStartupMessages({
  library(DESeq2)
  library(apeglm)
  library(clusterProfiler)
  library(org.At.tair.db)
  library(RColorBrewer)
  library(reshape2)
  library(dendextend)
  library(pheatmap)
  library(dplyr)
  library(readr)
  library(ggplot2)
  library(ggrepel)
  library(tidyr)
  library(writexl)
  library(tidyverse)
  library(tibble)
})

# Confirm loaded
cat("âœ… Packages ready:", length(search()[grepl("package:", search())]), "loaded\n")
cat("- Key: DESeq2, tidyverse, pheatmap, EnhancedVolcano, clusterProfiler\n")

```

```{r}
# making sure you are routing to the right ROOT
if (rstudioapi::isAvailable()) {
  project_root <- normalizePath(rstudioapi::getActiveProject()[[1]])
}# else 


# Define paths relative to PROJECT ROOT
results_dir   <- file.path(project_root, "HvIM/Results")
graphics_dir  <- file.path(results_dir, "Graphics")
tables_dir    <- file.path(results_dir, "Tables")
procdata_dir  <- file.path(results_dir, "Processed_data")

# Create directories
dir.create(results_dir,   recursive = TRUE, showWarnings = FALSE)
dir.create(graphics_dir,  recursive = TRUE, showWarnings = FALSE)
dir.create(tables_dir,    recursive = TRUE, showWarnings = FALSE)
dir.create(procdata_dir,  recursive = TRUE, showWarnings = FALSE)

# Confirmation
cat("âœ… Project root:", project_root, "\n")
cat(sprintf("âœ… Dirs ready for exports/plots\n"))
```


```{r read-couts, message=FALSE}
# Read featureCounts (preserve Geneid)
featcount <- read_tsv("./Data_Repository/featcount.txt", skip = 1)

# Set Geneid as column
gene_ids <- featcount[[1]]

# Count matrix: columns 7+ (samples), rownames = Geneid
read.count <- as.matrix(featcount[, 7:ncol(featcount)])
rownames(read.count) <- gene_ids

# Clean colnames (remove .bam paths)
colnames(read.count) <- gsub(".*\\/|\\..*Aligned.*", "", colnames(read.count))

# Check
#dim(read.count) #check dimensions 
#head(rownames(read.count))  # AT1G00010 etc.
#head(colnames(read.count))  # DIC1_S21, DIT1_S5 etc.

```


```{r read-couts, message=FALSE}
# Standardize colnames
sample_names <- c("IT-107", "IT-108", "IT-109", "IT-110", 
                  "H-107", "H-108", "H-109", "H-110", "H-111",
                  "UT-106", "UT-108", "UT-114", 
                  "IT-206", "IT-207", "IT-208", "IT-209",
                  "IM-206", "IM-207", "IM-208", "IM-209", "IM-210",
                  "UT-204", "UT-208", "UT-213", "UT214",
                  "UM-204", "UM-208", "UM-213", "UM-214", "UM-215")

colnames(read.count) <- sample_names #save naming system

# Verify structure
cat("ðŸ“Š Counts loaded:", nrow(read.count), "genes x", ncol(read.count), "samples\n")
cat("Range:", format(min(read.count), scientific = TRUE), "â†’", max(read.count), "\n") #printing the range of counts per gene
summary(colSums(read.count))  # Lib sizes (total reads mapped per sample)


library(writexl)

# Convert matrix â†’ data frame with gene IDs
raw_counts_df <- as.data.frame(read.count)
raw_counts_df <- tibble::rownames_to_column(raw_counts_df, "GeneID")

# Export both CSV and Excel
#write_csv(raw_counts_df, file.path(tables_dir, "raw_counts_clean.csv"))
#writexl::write_xlsx(raw_counts_df, file.path(tables_dir, "raw_counts_clean.xlsx"))
```



```{r Subsetting-im-h}
# =============
# IM + H + UM 
# ============

# Columns to DROP: IT(1:4,13:16), UT(10:12,22:25) â†’ KEEP 5-9,17-21,26-30
keep_cols <- c(5:9, 17:21, 26:30)
ImvHvUM <- read.count[, keep_cols]
colnames(ImvHvUM)  # Confirm order

sample_info<- data.frame(
  row.names = c("H-107", "H-108", "H-109", "H-110", "H-111", 
                "IM-206", "IM-207", "IM-208", "IM-209", "IM-210", 
                "UM-204", "UM-208", "UM-213", "UM-214", "UM-215"),
  Groups = factor(c(rep("H",5), rep("IM",5), rep("UM",5)), levels=c("UM","IM","H")),
  Condition = factor(c(rep("Infected",10), rep("Uninfected",5)))
)

stopifnot(all(rownames(sample_info) == colnames(ImvHvUM)))

stopifnot(all(rownames(sample_info) == colnames(ImvHvUM)))

#write_csv(ImvHvUM, file.path(tables_dir, "counts_IM_H_UM_subset.csv"))
#write_csv(sample_info, file.path(tables_dir, "sample_metadata_IM_H_UM.csv"))

cat("âœ… IM/H/UM subset ready:", ncol(ImvHvUM), "samples\n")
table(sample_info$Groups)
```


```{r DESeq-run}
# Create DESeqDataSet (IM/H/UM subset)
dds_UM <- DESeqDataSetFromMatrix(
  countData = ImvHvUM,
  colData = sample_info,
  design = ~ Groups
)

# Prefilter low-count genes
keep <- rowSums(counts(dds_UM)) >= 10
dds_UM <- dds_UM[keep, ]
cat("Filtered:", sum(keep), "genes kept\n")

# UM reference (relevel confirms)
dds_UM$Groups <- relevel(dds_UM$Groups, ref = "UM")

# Run DESeq2
dds_UM <- DESeq(dds_UM)
print(dds_UM)

# Results names
resultsNames(dds_UM)

# Core contrasts: vs UM reference
res_IM_UM <- results(dds_UM, name = "Groups_IM_vs_UM", alpha = 0.05)
res_H_UM  <- results(dds_UM, name = "Groups_H_vs_UM", alpha = 0.05)

cat("IM vs UM DEGs (padj<0.05):", sum(res_IM_UM$padj < 0.05, na.rm = TRUE), "\n")
cat("H vs UM DEGs (padj<0.05): ", sum(res_H_UM$padj < 0.05, na.rm = TRUE), "\n")

# Save full DESeq object
saveRDS(dds_UM, file.path(procdata_dir, "dds_IM_H_UM.rds"))
```

```{r Normalization}
# Variance stabilizing transformation
vsd <- vst(dds_UM, blind = TRUE, nsub = 1000)  # blind ignores design; subsample for speed

# Sample names (match colData) - safer matching
colnames(vsd) <- rownames(sample_info)
stopifnot(all(colnames(vsd) == rownames(colData(dds_UM))))  # Check

# Normalized counts matrix (size factors applied)
norm_counts <- counts(dds_UM, normalized = TRUE)

cat("VST dims:", nrow(vsd), "genes Ã—", ncol(vsd), "samples\n")
cat("Norm counts dims:", nrow(norm_counts), "Ã—", ncol(norm_counts), "\n")

# Export both formats
write_csv(as.data.frame(norm_counts), 
          file.path(tables_dir, "normalized_counts_H_IM_UM.csv"))

writexl::write_xlsx(
  list(
    Normalized = as.data.frame(round(norm_counts, 2)),  # Round for readability
    VST        = as.data.frame(assay(vsd))
  ), 
  path = file.path(tables_dir, "H_IM_UM_normalized_VST.xlsx")
)

cat("âœ… Exported Normalized + VST matrices to Tables/\n")

# Enhanced quality checks
summary(colSums(assay(vsd)))  # VST lib sizes should be ~equal (~1e6 range)

# Better visualization
boxplot(log2(assay(vsd)[1:25, ] + 1), 
        main = "VST Top 25 Genes by Sample", 
        las = 2, cex.axis = 0.8)
plotPCA(vsd, intgroup = "Condition") + theme_minimal()  # DESeq2 built-in PCA

```


```{r clustering-heatmeps}

#Sample correlation heatmap (Spearman, raw counts >=1)
sim_mat <- ImvHvUM[rowSums(ImvHvUM) >= 1, ]
cor_samps <- round(cor(sim_mat, method = "spearman"), 2)
melted_cor <- melt(cor_samps)

p_cor <- ggplot(melted_cor, aes(Var1, Var2, fill = value)) +
  geom_tile(color = "white", linewidth = 0.5) +
  geom_text(aes(label = value), color = "black", size = 3.2) +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0.9,
                       limits = c(0.5, 1), name = "Spearman Ï") +
  labs(title = "Sample Correlation (Raw Counts, Spearman)", x = "", y = "") +
  theme_minimal(base_size = 11) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text.y = element_text(size = 9),
        panel.grid = element_blank(),
        legend.position = "bottom")
print(p_cor)
ggsave(file.path(graphics_dir, "sample_correlation_spearman.png"), p_cor, width = 10, height = 8, dpi = 300)

# Hierarchical clustering (VST normalized, Euclidean distance)
sample_dist <- dist(t(assay(vsd)))  # Transpose: samples as rows
hc <- hclust(sample_dist, method = "ward.D2")

# Colored dendrogram (3 clusters: UM/IM/H groups)
dend <- as.dendrogram(hc) %>% color_branches(k = 3) %>% 
  set("branches_lwd", 2) %>% set("labels_cex", 0.9) %>% set("leaves_pch", 19) %>% set("leaves_cex", 1.1)

plot(dend, main = "Sample Clustering (VST, Ward.D2)", ylab = "Euclidean Distance")
#ggsave(file.path(graphics_dir, "sample_clustering_dendrogram.png"), 
#       width = 10, height = 8, dpi = 300)

# Sample distance matrix heatmap
dist_mat <- as.matrix(sample_dist)
colnames(dist_mat) <- rownames(sample_info)  # Clean labels
rownames(dist_mat) <- rownames(sample_info)

colors_dist <- colorRampPalette(rev(RColorBrewer::brewer.pal(9, "Blues")))(255)

p_dist <- pheatmap(dist_mat,
  clustering_distance_rows = sample_dist,
  clustering_distance_cols = sample_dist,
  color = colors_dist,
  main = "Sample Euclidean Distances (VST)",
  show_rownames = TRUE, show_colnames = TRUE,
  filename = file.path(graphics_dir, "sample_distance_heatmap.png"),
  width = 10, height = 9
)

```



```{r}

#d <- plotCounts(results_object, 
#                 gene = "AT1G21890", 
#                 intgroup = "Groups", 
#                 returnData = TRUE)

# Create plot with jittered points and gene labels
#ggplot (d, aes (x = Groups, y = count, color = Groups)) +
#  geom_point (position = position_jitter (w = 0.1, h = 0)) +
#  geom_text_repel (aes (label = rownames (d))) +
#  theme_bw () +
#  ggtitle ("AT1G21890 Expression") +
#  theme (plot.title = element_text (hjust = 0.5))
#ggsave("./SumData/1_Diag_DEG/1_countData_AT1G21890.pdf")

```

```{r PCA}
pca_data <- DESeq2::plotPCA(vsd, 
                           intgroup = c("Groups", "Condition"), 
                           returnData = TRUE)
percentVar <- round(100 * attr(pca_data, "percentVar"))

# Plot
p_pca <- ggplot(pca_data, aes(PC1, PC2, color = Groups, shape = Condition)) +
  geom_point(size = 4.5, stroke = 1.5, alpha = 0.85) +
  scale_color_manual(values = c("UM" = "#E31A1C", 
                                "IM" = "#1F78B4", 
                                "H"  = "#33A02C"),
                     name = "Tissue") +
  scale_shape_manual(values = c("Uninfected" = 16,    # Circle
                                "Infected"   = 17),  # Triangle
                     name = "Status") +
  geom_text_repel(aes(label = name),                 
                  box.padding = 0.35, 
                  max.overlaps = Inf,  # Show all labels
                  size = 3.5, 
                  segment.color = "grey60",
                  segment.size = 0.3,
                  bg.color = "white", 
                  bg.r = 0.1) +
  labs(title = "TRAP-seq PCA: Haustoria vs Mesophyll (VST)",
       subtitle = paste("PC1:", round(percentVar[1],1), "% variance |",
                       "PC2:", round(percentVar[2],1), "% variance"),
       caption = "Groups: UM (uninfected mesophyll), IM (infected mesophyll), H (haustoria)") +
  xlab(paste0("PC1 (", round(percentVar[1],1), "%)")) +
  ylab(paste0("PC2 (", round(percentVar[2],1), "%)")) +
  theme_classic(base_size = 13) +
  theme(legend.position = "bottom", 
        legend.title = element_text(face = "bold"),
        plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
        plot.subtitle = element_text(hjust = 0.5, size = 12),
        panel.grid.minor = element_blank())

print(p_pca)

# High-res export + PDF for papers
#ggsave(file.path(graphics_dir, "TRAPseq_PCA_vst_final.png"), 
#       p_pca, width = 11, height = 8, dpi = 300, bg = "white")
```


```{r DESeq-results-lfc}
resultsNames(dds_UM)

# Base results (padj sorted)
res_H_UM <- results(dds_UM, contrast = c("Groups", "H", "UM"), alpha = 0.05)
print(res_H_UM)
res_IM_UM <- results(dds_UM, contrast = c("Groups", "IM", "UM"), alpha = 0.05)

# LFC shrinkage (apeglm, more accurate for rankings)
lfc_H_UM <- tryCatch({
  lfcShrink(dds_UM, contrast = c("Groups", "H", "UM"), type = "apeglm")
}, error = function(e) {
  warning("apeglm failed for H_vs_UM, using normal: ", e$message)
  lfcShrink(dds_UM, contrast = c("Groups", "H", "UM"), type = "normal")
})

lfc_IM_UM <- tryCatch({
  lfcShrink(dds_UM, contrast = c("Groups", "IM", "UM"), type = "apeglm")
}, error = function(e) {
  warning("apeglm failed for IM_vs_UM, using normal: ", e$message)
  lfcShrink(dds_UM, contrast = c("Groups", "IM", "UM"), type = "normal")
})

# Padj-ordered (ascending, remove NA padj)
res_H_UM <- res_H_UM[order(res_H_UM$padj), ]
res_H_UM <- res_H_UM[!is.na(res_H_UM$padj), ]  # Clean NAs
res_IM_UM <- res_IM_UM[order(res_IM_UM$padj), ]
res_IM_UM <- res_IM_UM[!is.na(res_IM_UM$padj), ]

lfc_H_UM <- lfc_H_UM[order(lfc_H_UM$padj), ]
lfc_H_UM <- lfc_H_UM[!is.na(lfc_H_UM$padj), ]
lfc_IM_UM <- lfc_IM_UM[order(lfc_IM_UM$padj), ]
lfc_IM_UM <- lfc_IM_UM[!is.na(lfc_IM_UM$padj), ]

# QC summaries
alpha <- 0.05
lfc_cutoff <- 1.0

sig_H_UM <- sum(res_H_UM$padj < alpha & abs(res_H_UM$log2FoldChange) >= lfc_cutoff, na.rm = TRUE)
sig_IM_UM <- sum(res_IM_UM$padj < alpha & abs(res_IM_UM$log2FoldChange) >= lfc_cutoff, na.rm = TRUE)

cat("\nðŸ”¬ DEGs (padj <", alpha, "|LFC| â‰¥", lfc_cutoff, "):\n")
cat("H vs UM:  ", sig_H_UM, " (", round(100*sig_H_UM/nrow(res_H_UM),1), "%)\n")
cat("IM vs UM: ", sig_IM_UM, " (", round(100*sig_IM_UM/nrow(res_IM_UM),1), "%)\n")
cat("H > IM confirms haustoria enrichment!\n\n")

# Comprehensive export (base + shrunk LFC)
#write_csv(as.data.frame(res_H_UM), file.path(tables_dir, "05_DESeq2_H_vs_UM_base.csv"))
#write_csv(as.data.frame(lfc_H_UM), file.path(tables_dir, "05_DESeq2_H_vs_UM_LFCshrink.csv"))
#write_csv(as.data.frame(res_IM_UM), file.path(tables_dir, "05_DESeq2_IM_vs_UM_base.csv"))
#write_csv(as.data.frame(lfc_IM_UM), file.path(tables_dir, "05_DESeq2_IM_vs_UM_LFCshrink.csv"))

#cat("âœ… Exported 4 result tables (base + LFC-shrunk)\n")
```

```{r}
# Single wide tibble (LFC shrunk preferred)
deseq_all <- full_join(
  as_tibble(lfc_IM_UM, rownames = "GeneID") %>% 
    dplyr::select(GeneID, log2FoldChange, padj, pvalue)
  #%>% mutate(contrast = "IM_vs_UM")
  ,
  as_tibble(lfc_H_UM, rownames = "GeneID") %>% 
    dplyr::select(GeneID, log2FoldChange, padj, pvalue)
  #%>% mutate(contrast = "H_vs_UM")
  ,
  by = "GeneID",
  suffix = c("_IM_vs_UM", "_H_vs_UM")
) %>%
dplyr::select(GeneID, ends_with("log2FoldChange"), ends_with("padj"), 
                ends_with("pvalue"), everything()) %>%
  arrange(padj_IM_vs_UM, padj_H_vs_UM)

# Add significance flags
deseq_all <- deseq_all %>%
  mutate(
    sig_IM = ifelse(padj_IM_vs_UM < 0.05 & abs(log2FoldChange_IM_vs_UM) > 1, 
                    "Significant", "NS"),
    sig_H  = ifelse(padj_H_vs_UM < 0.05 & abs(log2FoldChange_H_vs_UM) > 1, 
                    "Significant", "NS")
  )
#write_csv(deseq_all, file.path(tables_dir, "DESeq2_LFC_shrunk_all_contrasts.csv"))

head(deseq_all)
# Quick volcano previews (pre-EnhancedVolcano)
deseq_all %>%
  ggplot(aes(log2FoldChange_IM_vs_UM, -log10(padj_IM_vs_UM))) +
  geom_point(aes(color = padj_IM_vs_UM < 0.05 & abs(log2FoldChange_IM_vs_UM) > 1), alpha = 0.6) +
  scale_color_manual(values = c("grey", "red")) +
  labs(title = "IM vs UM (Quick Preview)") +
  theme_minimal()

deseq_all %>%
  ggplot(aes(log2FoldChange_H_vs_UM, -log10(padj_H_vs_UM))) +
  geom_point(aes(color = padj_H_vs_UM < 0.05 & abs(log2FoldChange_H_vs_UM) > 1), alpha = 0.6) +
  scale_color_manual(values = c("grey", "red")) +
  labs(title = "H vs UM (Haustoria Signal)") +
  theme_minimal()

# Full DE summary table
de_summary <- tibble(
  contrast = c("IM_vs_UM", "H_vs_UM"),
  n_DEG_IM = map_int(list(res_IM_UM, res_H_UM), ~sum(.$padj < 0.05, na.rm = TRUE)),
  n_DEG_H  = c(sum(res_H_UM$padj < 0.05, na.rm = TRUE), NA),
  n_LFC1_IM = map_int(list(lfc_IM_UM, lfc_H_UM), ~sum(abs(.$log2FoldChange) > 1, na.rm = TRUE))
) %>% print()

```


```{r deg-heatmap}
set.seed(123)

# DE genes from BOTH contrasts (intersect for haustoria candidates)
sig_IM <- rownames(res_IM_UM)[res_IM_UM$padj < 0.05 & !is.na(res_IM_UM$padj) & abs(res_IM_UM$log2FoldChange) >= 1]
sig_H  <- rownames(res_H_UM)[res_H_UM$padj < 0.05 & !is.na(res_H_UM$padj) & abs(res_H_UM$log2FoldChange) >= 1]
top_DE_genes <- head(intersect(sig_IM, sig_H), 100)  # Shared top 100

cat("Shared DE genes (padj<0.05, |LFC|â‰¥1):", length(top_DE_genes), "\n")

# Subset normalized counts - ensure genes exist
if(length(top_DE_genes) > 0) {
  top_DE_genes <- intersect(top_DE_genes, rownames(norm_counts))  # Safety intersect
  if(length(top_DE_genes) > 0) {
    deg_mat <- norm_counts[top_DE_genes, ]
    
    # Sample annotation - ensure rownames match colnames
    ann_col <- data.frame(Groups = sample_info$Groups)
    rownames(ann_col) <- colnames(deg_mat)  # Critical for pheatmap

    p_deg <- pheatmap(deg_mat,
      scale = "row",  # Z-score per gene for DE visualization
      color = colorRampPalette(rev(RColorBrewer::brewer.pal(n = 7, "RdYlBu")))(100),  # Explicit namespace
      cluster_rows = TRUE, 
      cluster_cols = TRUE,
      clustering_distance_rows = "correlation",
      clustering_distance_cols = "euclidean",
      clustering_method = "complete",
      annotation_col = ann_col,
      show_rownames = ifelse(length(top_DE_genes) < 30, TRUE, FALSE),
      show_colnames = FALSE,
      main = paste("Top", length(top_DE_genes), "Shared DE Genes\n(padj<0.05, |LFC|â‰¥1: IM & H vs UM)"),
      fontsize_row = 8,
      filename = file.path(graphics_dir, "heatmap_top_shared_DE_genes.png"),
      width = 12, height = 10
    )
    
    # Export gene list
    write.csv(data.frame(Gene = top_DE_genes), 
              file.path(tables_dir, "top_shared_DE_genes.csv"), row.names = FALSE)
    
  } else {
    cat("No shared DE genes in norm_counts\n")
  }
} else {
  cat("No shared DE genes found\n")
}
```


```{r H v UM DEGS}

padj_thresh <- 0.05
lfc_thresh <- 1

## DESeq2 â†’ DEG TABLES
# H vs UM (haustoria - enriched)
deg_H <- res_H_UM %>%
  as.data.frame() %>%                    # S4 â†’ data.frame preserves rownames
  rownames_to_column("TAIR") %>%
  as_tibble() %>%
  filter(padj < padj_thresh & !is.na(padj) & abs(log2FoldChange) >= lfc_thresh) %>%
  mutate(direction = case_when(
    log2FoldChange > lfc_thresh ~ "H_UP",
    log2FoldChange < -lfc_thresh ~ "H_DOWN",
    TRUE ~ "NS"
  )) %>%
  filter(direction != "NS") %>%
  mutate(
    symbol = mapIds(org.At.tair.db, keys = TAIR, column = "SYMBOL", keytype = "TAIR", multiVals = "first"),
    entrez = mapIds(org.At.tair.db, keys = TAIR, column = "ENTREZID", keytype = "TAIR", multiVals = "first")
  )

# IM vs UM (infected mesophyll)
deg_IM <- res_IM_UM %>%
  as.data.frame() %>%
  rownames_to_column("TAIR") %>%
  as_tibble() %>%
  filter(padj < padj_thresh & !is.na(padj) & abs(log2FoldChange) >= lfc_thresh) %>%
  mutate(direction = case_when(
    log2FoldChange > lfc_thresh ~ "IM_UP",
    log2FoldChange < -lfc_thresh ~ "IM_DOWN",
    TRUE ~ "NS"
  )) %>%
  filter(direction != "NS") %>%
  mutate(
    symbol = mapIds(org.At.tair.db, keys = TAIR, column = "SYMBOL", keytype = "TAIR", multiVals = "first"),
    entrez = mapIds(org.At.tair.db, keys = TAIR, column = "ENTREZID", keytype = "TAIR", multiVals = "first")
  )


## SHARED HAUSTORIA CANDIDATES
shared_tair <- intersect(deg_H$TAIR, deg_IM$TAIR)
deg_shared <- deg_H %>%
  filter(TAIR %in% shared_tair) %>%
  left_join(select(deg_IM, TAIR, log2FoldChange_IM = log2FoldChange, padj_IM = padj), by = "TAIR") %>%
  mutate(avg_lfc = (log2FoldChange + coalesce(log2FoldChange_IM, 0)) / 2) %>%
  arrange(desc(avg_lfc))

# SPLIT UP/DOWN FOR HEATMAPS
H_UP <- deg_H %>% filter(direction == "H_UP")
H_DOWN <- deg_H %>% filter(direction == "H_DOWN")
IM_UP <- deg_IM %>% filter(direction == "IM_UP")
IM_DOWN <- deg_IM %>% filter(direction == "IM_DOWN")

cat("DE Genes (|LFC| â‰¥", lfc_thresh, ", padj <", padj_thresh, "):\n")
cat("- H vs UM:    ", nrow(deg_H), " (UP:", nrow(H_UP), " DOWN:", nrow(H_DOWN), ")\n")
cat("- IM vs UM:   ", nrow(deg_IM), " (UP:", nrow(IM_UP), " DOWN:", nrow(IM_DOWN), ")\n")
cat("- Shared:     ", nrow(deg_shared), "\n")

## EXCEL
deg_workbook <- list(
  H_vs_UM_All   = deg_H %>% arrange(padj),
  H_vs_UM_UP    = H_UP,
  H_vs_UM_DOWN  = H_DOWN,
  IM_vs_UM_All  = deg_IM %>% arrange(padj),
  IM_vs_UM_UP   = IM_UP,
  IM_vs_UM_DOWN = IM_DOWN,
  Shared        = deg_shared
)

#write_xlsx(deg_workbook, file.path(tables_dir, "DE_genes_all_directions.xlsx"))

# Summary stats
summary_stats <- tibble(
  Contrast = c("H vs UM UP", "H vs UM DOWN", "IM vs UM UP", "IM vs UM DOWN", "Shared"),
  n_genes = c(nrow(H_UP), nrow(H_DOWN), nrow(IM_UP), nrow(IM_DOWN), nrow(deg_shared))
)
#write_xlsx(list(Summary = summary_stats), file.path(tables_dir, "DE_summary.xlsx"))
#cat("âœ“ Excel files saved to", tables_dir, "\n")

```


```{r IM V UM DEG}
UMVsIM <- results (results_object, c('Groups', 'IM', 'UM'))

# Map TAIR IDs to ENTREZ IDs
UMVsIM$entrez <- mapIds(org.At.tair.db, keys = row.names(UMVsIM), keytype = "TAIR", column = "ENTREZID", multiVals = "first")
UMVsIM$symbol <- mapIds (org.At.tair.db, keys = row.names (UMVsIM), keytype = "TAIR", column = "SYMBOL", multiVals = "first")

IM_DF <- UMVsIM %>% as.data.frame() %>% rownames_to_column (., var = "rowname") %>% as_tibble() %>%  na.omit()

#write.csv(IM_DF, file = "./DerivedData/1_Diag_DEG/1_DEG_IMvUM_NoFilters.csv", quote = FALSE, row.names = TRUE)
 
IM_DEG_table <- IM_DF %>% mutate (diffexpressed = case_when (
  log2FoldChange > 1 &   padj < pad ~ 'IM_UP',
  log2FoldChange < -1 &   padj < pad ~ 'IM_DOWN',
  padj > pad ~ 'NO' )) %>%  na.omit()

IM_DEG_table <- IM_DEG_table [IM_DEG_table$diffexpressed != 'NO', ] # Remove non-significant genes

# Substitute names so they are annotated nicely in the heat map later
unique (IM_DEG_table$diffexpressed)

#write.csv(IM_DEG_table, file = "./DerivedData/1_Diag_DEG/1_DEG_IMvUM_LFC1p05.csv", quote = FALSE, row.names = TRUE)
 
# Split the data frame into a list of sub-data frames: up-regulated, down regulated genes
IM_results_split <- split (IM_DEG_table, IM_DEG_table$diffexpressed)
IMDOWN <- c(IM_results_split$IM_DOWN)
IMDOWN <- as.data.frame (IMDOWN, row.names = IMDOWN$entrez)
IMUP <- c (IM_results_split$IM_UP)
IMUP <- as.data.frame (IMUP, row.names = IMUP$entrez)

#write.csv (IMUP, file = "./DerivedData/1_Diag_DEG/1_DEG_IMUP_LFC1p05.csv", quote = FALSE, row.names = TRUE)

#write.xlsx(as.data.frame(IM_DF), file = "./DerivedData/1_Diag_DEG/1_HvIMvUM_nofilter.xlsx", sheetName = "IMvUM", col.names = TRUE, row.names = FALSE, append = TRUE)
```


```{r H Vs IM}
#length (H_DF$rowname) <- length (HvIM.UM$rowname)
ven <- VennDetail::venndetail (list (HvsUM = HUM_df$Gene_ID, IMvsUM = IMUM_df$Gene_ID))
plot(ven, type = "venn", order = TRUE, textsize = 3)
plot(ven, type = "venn", col = c("orchid", "#d95f02"), sep = "_",
mycol = c("orchid", "#d95f02"), cat.cex = 1.5, alpha = 0.5, cex = 2,
cat.fontface = "bold", margin = 0.05, text.scale = c(1.5, 1.5), filename = NULL, piecolor = NULL,
revcolor = "blue", any = NULL, show.number = TRUE,
show.x = TRUE, log = FALSE, base = NULL, percentage = FALSE,
sets.x.label = "Set Size", mainbar.y.label = "Intersection Size",
nintersects = 40, abbr = TRUE, abbr.method = "both.sides",
minlength = 3)
#dev.copy2pdf(file = "./SumData/1_Diag_DEG/1_Upset_IMvHvUM.pdf")
ven

HUM_venlist<- as.data.frame(VennDetail::getSet(ven, "HvsUM"))
IMUM_venlist<- as.data.frame(VennDetail::getSet(ven, "IMvsUM"))
#VennDetail::make.subset(ven, "HvsUM")
VennDetail::result(ven)
VennDetail::vennpie(ven)
```



```{r CODE CHUNK 9 DEG NUmbers}
plotMA (results_object, alpha = 0.01)
plotMA (results_object, alpha = 0.05)

#to see how many genes are < to 0.05
table (results_object$padj < 0.05) 
print (results_object)

#to see how many genes are < to 0.001
table (results_object$padj < 0.01) 
print (results_object)
```


```{r}
#length (H_DF$rowname) <- length (HvIM.UM$rowname)
ven <- VennDetail::venndetail (list (HvsUM = H_DEG_table$rowname, IMvsUM = IM_DEG_table$rowname, HvsIM = HIMum_DEG_table$rowname))
plot(ven, type = "venn", order = TRUE, textsize = 3)
plot(ven, type = "venn", col = c("#1b9e77", "#d95f02", "orchid3"), sep = "_",
mycol = c("#1b9e77", "#d95f02", "orchid3"), cat.cex = 1.5, alpha = 0.5, cex = 2,
cat.fontface = "bold", margin = 0.05, text.scale = c(1.5, 1.5, 1.5), filename = NULL, piecolor = NULL,
revcolor = "blue", any = NULL, show.number = TRUE,
show.x = TRUE, log = FALSE, base = NULL, percentage = FALSE,
sets.x.label = "Set Size", mainbar.y.label = "Intersection Size",
nintersects = 40, abbr = TRUE, abbr.method = "both.sides",
minlength = 3)
#dev.copy2pdf(file = "./SumData/1_Diag_DEG/1_Upset_IMvHvUM.pdf")

```


```{r}
VennDetail::detail(ven)
VennDetail::dplot(ven)

HIM_venlist<- as.data.frame(VennDetail::getSet(ven, "HvsIM"))
VennDetail::make.subset(ven, "HvsIM")
VennDetail::result(ven)
VennDetail::vennpie(ven)
```

```{r}
HIM_detail<- as.data.frame(HIM_venlist, row.names = HIM_venlist$Detail)

HIM_detail$ENTREZ = mapIds (org.At.tair.db, keys = row.names (HIM_detail) , keytype = "TAIR" , column = "ENTREZID" , multiVals = "first" )

HIM_detail$symbol <- mapIds (org.At.tair.db, keys = row.names (HIM_detail), keytype = "TAIR", column = "SYMBOL", multiVals = "first")

#write.csv(HIM_detail, file= "./DerivedData/1_Diag_DEG/1_HIM_167uniq.csv", quote=F, row.names=FALSE)


HIM_LFC_uniq <- HIMum_DEG_table %>%
  subset (HIMum_DEG_table$rowname %in% HIM_detail$Detail) %>%
  as_tibble() %>% 
  na.omit() 

HIM_LFC_uniq2 <- IM_DF %>%
  subset (IM_DF$rowname %in% HIM_detail$Detail) %>%
  as_tibble() %>% 
  na.omit() 

HIM_LFC_uniq3 <- H_DF %>%
  subset (H_DF$rowname %in% HIM_detail$Detail) %>%
  as_tibble() %>% 
  na.omit() 


#write.csv(HIM_uniq_genes, file= "./DerivedData/1_Diag_DEG/1_HIM_uniq.csv", quote=F, row.names=FALSE)
```


```{r}
results_object1 <- DESeq(data_set1, betaPrior = FALSE)

res5 <- lfcShrink(results_object, contrast = c('Groups','IM','UM'), res=UMVsIM1, type = 'normal')
res6 <- lfcShrink(results_object, contrast = c('Groups','H','UM'), res=UMVsH1, type = 'normal')
res7 <- lfcShrink(results_object, contrast = c('Groups','H','IM'), res=HvIM.UM, type = 'normal')
```


```{r}
library(EnhancedVolcano)
EnhancedVolcano (HvIM.UM,
    lab = HvIM.UM$rowname,
    x = 'log2FoldChange',
    y = 'pvalue',
     selectLab =  c('AT1G02010'),
     xlab = bquote(~Log[2]~ 'fold change'),
     xlim = c(-6, 6),
    title = 'IMvUM',
    pCutoff = 0.05,
    FCcutoff = 1,
    pointSize = 3.0,
    labSize = 6.0,
      shape = c(1, 4, 23, 8),
    col=c('black', 'yellow', 'blue', 'green'),
    colAlpha = 1,
    legendLabels=c('Not sig.','Log (base 2) FC','p-value',
      'p-value & Log (base 2) FC'),
    legendPosition = 'right',
    legendLabSize = 16,
    legendIconSize = 5.0,
    cutoffLineType = 'twodash',
    cutoffLineCol = 'black',
    cutoffLineWidth = 0.8,
    hline = c(0.05),
    hlineCol = c('pink'),
    hlineType = c('solid'),
    hlineWidth = c(1.0),
    gridlines.major = FALSE,
    gridlines.minor = FALSE)


EnhancedVolcano(IM_DF,
    lab = IM_DF$rowname,
    x = 'log2FoldChange',
    y = 'pvalue',
     selectLab =  c('AT1G02010'),
     xlab = bquote(~Log[2]~ 'fold change'),
     xlim = c(-6, 6),
    title = 'IMvUM',
    pCutoff = 0.05,
    FCcutoff = 1,
    pointSize = 3.0,
    labSize = 6.0,
      shape = c(1, 4, 23, 8),
    col=c('black', 'yellow', 'blue', 'green'),
    colAlpha = 1,
    legendLabels=c('Not sig.','Log (base 2) FC','p-value',
      'p-value & Log (base 2) FC'),
    legendPosition = 'right',
    legendLabSize = 16,
    legendIconSize = 5.0,
    cutoffLineType = 'twodash',
    cutoffLineCol = 'black',
    cutoffLineWidth = 0.8,
    hline = c(0.05),
    hlineCol = c('pink'),
    hlineType = c('solid'),
    hlineWidth = c(1.0),
    gridlines.major = FALSE,
    gridlines.minor = FALSE)

EnhancedVolcano(H_DF,
    lab = H_DF$rowname,
    x = 'log2FoldChange',
    y = 'pvalue',
     selectLab =  c('AT1G02010'),
     xlab = bquote(~Log[2]~ 'fold change'),
     xlim = c(-6, 6),
    title = 'UMvsH',
    pCutoff = 0.05,
    FCcutoff = 1,
    pointSize = 3.0,
    labSize = 6.0,
      shape = c(1, 4, 23, 8),
    col=c('black', 'yellow', 'blue', 'green'),
    colAlpha = 1,
    legendLabels=c('Not sig.','Log (base 2) FC','p-value',
      'p-value & Log (base 2) FC'),
    legendPosition = 'right',
    legendLabSize = 16,
    legendIconSize = 5.0,
    cutoffLineType = 'twodash',
    cutoffLineCol = 'black',
    cutoffLineWidth = 0.8,
    hline = c(0.05),
    hlineCol = c('pink'),
    hlineType = c('solid'),
    hlineWidth = c(1.0),
    gridlines.major = FALSE,
    gridlines.minor = FALSE)
```


```{r}
#if (!requireNamespace("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")

#BiocManager::install("vidger")
```

```{r}
library(vidger)
# DESeq2 example
#hl <- c(atguniq)

FW_df<- vsFourWay(
     x = "H", y = "IM",
     control = "UM", data = results_object,
     d.factor = "Groups", type = "deseq", padj = 0.05,
     x.lim = NULL, y.lim = NULL, lfc = 1, title = TRUE, grid = TRUE,
     legend = TRUE,
     data.return = TRUE, 
     #highlight = hl, 
     xaxis.text.size = 10,
yaxis.text.size = 10, xaxis.title.size = 10, yaxis.title.size = 10,
main.title.size = 10, legend.text.size = 10
)
FW_df
#ggsave("./SumData/1_Diag_DEG/1_LFC_IMVUMVH.pdf", width = 8, height = 8)

# Extract data frame from visualization

df_four <- FW_df$data ## or use tmp$data
#head(df_four)
```

```{r}
color_split <- split (df_four, df_four$color)
green_genes<- c (color_split$green)
green_genes_df <- as.data.frame (green_genes, row.names = green_genes$id)

red_genes<- c (color_split$red)
red_genes_df <- as.data.frame (red_genes, row.names = red_genes$id)
```

```{r}
pad = 0.05
eGO1 <- enrichGO(
  gene = green_genes_df$id, #3
  OrgDb = org.At.tair.db,
  keyType = 'TAIR',
  ont = "ALL",
  pAdjustMethod = "BH",
  qvalueCutoff = pad
)
s_eGO1 <- clusterProfiler::simplify(eGO1)
dotplot (s_eGO1, 
         showCategory = 8, 
         font.size = 14) + scale_size_continuous (range = c(1,10)) + ggtitle("sGO ORA of Green Genes")
#ggsave("./SumData/1_Diag_DEG/1_Green_dotplot.pdf", width = 8, height = 8)


eGO2 <- enrichGO(
  gene = red_genes_df$id, #3
  OrgDb = org.At.tair.db,
  keyType = 'TAIR',
  ont = "ALL",
  pAdjustMethod = "BH",
  qvalueCutoff = pad
)
s_eGO2 <- clusterProfiler::simplify(eGO2)
dotplot (s_eGO2, 
         showCategory = 8, 
         font.size = 14) + scale_size_continuous (range = c(1,10)) + ggtitle("sGO ORA of Red Genes")
#ggsave("./SumData/1_Diag_DEG/1_RED_dotplot.pdf", width = 8, height = 8)

```

```{r}
green_genes_tair<- as.data.frame(green_genes_df, row.names = green_genes_df$id)

green_genes_tair$ENTREZ = mapIds (org.At.tair.db, keys = row.names (green_genes_tair) , keytype = "TAIR" , column = "ENTREZID" , multiVals = "first" )

red_genes_tair<- as.data.frame(red_genes_df, row.names = red_genes_df$id)

red_genes_tair$ENTREZ = mapIds (org.At.tair.db, keys = row.names (red_genes_tair) , keytype = "TAIR" , column = "ENTREZID" , multiVals = "first" )
```


```{r}
ora_kegg1 <- enrichKEGG (gene = green_genes_tair$ENTREZ, #1
  organism = "ath", keyType = "ncbi-geneid", minGSSize = 10, maxGSSize = 500, pAdjustMethod = "BH", qvalueCutoff = pad, use_internal_data = FALSE) # force to use latest KEGG db
ora_kegg2 <- enrichKEGG (gene = red_genes_tair$ENTREZ, #1
  organism = "ath", keyType = "ncbi-geneid", minGSSize = 10, maxGSSize = 500, pAdjustMethod = "BH", qvalueCutoff = pad, use_internal_data = FALSE) # force to use latest KEGG db

edox1 <- pairwise_termsim (ora_kegg1)
edox2 <- pairwise_termsim (ora_kegg2)
dotplot (edox1, showCategory = 12, font.size = 15) + ggtitle("KEGG Enrichment")
```



```{r}
submod1_split <- split (FW_df, FW_df$Groups)

HUM<- c (submod1_split$HUM)
HUM_df <- as.data.frame (HUM, row.names = HUM$Gene_ID)

IMUM<- c (submod1_split$IMUM)
IMUM_df <- as.data.frame (IMUM, row.names = IMUM$Gene_ID)


#test1 <- HUM_df %>% 
#  inner_join(IMUM_df, by = "Gene_ID")

# Spread the data to get separate columns for HUM and IMUM regulation
spread_data <- exp_tbl %>%
  pivot_wider(names_from = Groups, values_from = ExpSig)

# Find genes that are Up in HUM and Down in IMUM
up_hum_down_imum <- spread_data %>% filter(HUM == "Up" & IMUM == "Down")

# Find genes that are Down in HUM and Up in IMUM
down_hum_up_imum <- spread_data %>% filter(HUM == "Down" & IMUM == "Up")



# Print the results
cat("Genes Up in HUM and Down in IMUM:\n")
print(up_hum_down_imum)

cat("\nGenes Down in HUM and Up in IMUM:\n")
print(down_hum_up_imum)
```


```{r}
color_split <- split (df_four, df_four$color)
green_genes<- c (color_split$green)
green_genes_df <- as.data.frame (green_genes, row.names = green_genes$id)

red_genes<- c (color_split$red)
red_genes_df <- as.data.frame (red_genes, row.names = red_genes$id)
```


```{r}
green_transporters = submod1 %>%
  subset (submod1$Gene_ID %in% green_genes_df$id) %>%
  as_tibble() %>% 
  na.omit() 

red_transporters<- submod1 %>%
  subset (submod1$Gene_ID %in% red_genes_df$id) %>%
  as_tibble() %>% 
  na.omit()


green_transporters = green_transporters %>%
  subset (green_transporters$Gene_ID %in% green_genes_df$id) %>%
  as_tibble() %>% 
  na.omit()
```


```{r}

#test1 <- HUM_df %>% 
#  inner_join(IMUM_df, by = "Gene_ID")


red_transporters_df<- as.data.frame(red_transporters, row.names = red_transporters$Gene_ID)
red_transporters_spread<- test1 %>%
  subset (test1$Gene_ID %in% red_transporters_df$Gene_ID) %>%
  as_tibble() %>% 
  na.omit()

#write.xlsx(as.data.frame(red_transporters_spread), file = "./DerivedData/1_red_transporters.xlsx", sheetName = "Unchanged in the H", col.names = TRUE, row.names = FALSE, append = FALSE)

green_transporters_df<- as.data.frame(green_transporters, row.names = green_transporters$Gene_ID)

green_transporters_spread = test1 %>%
  subset (test1$Gene_ID %in% green_transporters_df$Gene_ID) %>%
  as_tibble() %>% 
  na.omit() 

#write.xlsx(as.data.frame(green_transporters_spread), file = "./DerivedData/1_green_transporters.xlsx", sheetName = "Unchanged in the IM", col.names = TRUE, row.names = FALSE, append = FALSE)
```

```{r}
data("results_object")
vsBoxPlot(results_object, d.factor = "Groups", type = c("deseq"),
title = TRUE, legend = TRUE, grid = TRUE, aes = c("violin"), fill.color = NULL,
data.return = FALSE, xaxis.text.size = 10, yaxis.text.size = 10,
xaxis.title.size = 12, yaxis.title.size = 12, main.title.size = 15,
legend.text.size = 10, legend.title.size = 12)

vsDEGMatrix(results_object, padj = 0.05, d.factor = "Groups", type = c(
"deseq"), title = TRUE, legend = TRUE, grid = TRUE,
data.return = FALSE, grey.scale = FALSE, xaxis.text.size = 10,
yaxis.text.size = 10, main.title.size = 15, legend.text.size = 10,
legend.title.size = 12)

vsMAMatrix(results_object, d.factor = "Groups", type = c("deseq"),
padj = 0.05, y.lim = NULL, lfc = NULL, title = TRUE, legend = TRUE,
grid = TRUE, counts = TRUE, data.return = FALSE, xaxis.text.size = 9,
yaxis.text.size = 9, xaxis.title.size = 10, yaxis.title.size = 10,
main.title.size = 15, legend.text.size = 9, facet.title.size = 10)

vsScatterMatrix(results_object, d.factor = "Groups", type = c("deseq"), comp = NULL, title = TRUE, grid = TRUE, man.title = NULL,
data.return = FALSE, xaxis.text.size = 9, yaxis.text.size = 9,
xaxis.title.size = 10, yaxis.title.size = 10, main.title.size = 15,
facet.title.size = 10)

vsVolcanoMatrix(results_object, d.factor = "Groups", type = c("deseq"), padj = 0.05, x.lim = NULL, lfc = NULL, title = TRUE,
legend = TRUE, grid = TRUE, counts = TRUE, data.return = FALSE,
xaxis.text.size = 9, yaxis.text.size = 9, xaxis.title.size = 10,
yaxis.title.size = 10, main.title.size = 15, legend.text.size = 9,
facet.title.size = 10)
```







