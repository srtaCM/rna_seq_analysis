---
title: "Haustoria TRAP-seq Analysis"
author: "Iliana Castillo-Machuca | Virginia Tech SPES"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    code_folding: hide
    theme: flatly
    highlight: tango
    df_print: paged
params:
  data_dir: "data/"
  graphics_dir: "Results/Graphics/"
  tables_dir: "Results/Tables/"
---


```{r clear-env}
# Clean environment
rm (list = ls (all.names = TRUE)) # will clear all objects including hidden objects
gc () # free up memory and report the memory usage
options (max.print = .Machine$integer.max, scipen = 0, stringsAsFactors = F, dplyr.summarise.inform = F) # avoid truncated output in R console and keep scientific notation
```

```{r load-install-packages, eval=FALSE, include=TRUE}
# ===================
# Package Management
# ===================

## Bioconductor
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install(c(
  "DESeq2",           # RNA-seq DE
  "apeglm",           # LFC shrinkage  
  "clusterProfiler",  # GO/KEGG
  "org.At.tair.db",   # Arabidopsis mapping
  "enrichplot",       # Enrichment plots
  "vidger"            # 4-way plots
), update = FALSE, ask = FALSE)

## CRAN (tidyverse + viz)
cran_pkgs <- c(
  "RColorBrewer",     # Color palettes
  "reshape2",         # Data reshaping
  "dendextend",       # Dendrogram
  "pheatmap",         # Heatmaps
  "dplyr",            # Data manipulation
  "readr",            # Read data
  "ggplot2",          # Plotting
  "ggrepel",          # Label repel
  "tidyr",            # Data tidying
  "writexl",          # Excel export
  "tidyverse",        # Meta-package
  "tibble",           # Tibbles
  "patchwork",         # Plot layout
  "ggdendro"
)

install.packages(cran_pkgs[!(cran_pkgs %in% installed.packages()[,"Package"])], 
                 dependencies = TRUE)
cat("âœ… All packages installed!\n")


## Packages (quiet load)
suppressPackageStartupMessages({
  library(DESeq2)
  library(apeglm)
  library(clusterProfiler)
  library(org.At.tair.db)
  library(RColorBrewer)
  library(reshape2)
  library(dendextend)
  library(pheatmap)
  library(dplyr)
  library(readr)
  library(ggplot2)
  library(ggrepel)
  library(tidyr)
  library(writexl)
  library(tidyverse)
  library(tibble)
  library(enrichplot)
  library(patchwork)
  library(vidger)
  library(knitr)
  library(ggdendro)
})
```

```{r setup-paths, include=FALSE}
if (rstudioapi::isAvailable()) {
  project_root <- normalizePath(rstudioapi::getActiveProject()[[1]])
} else {
  project_root <- "."  # Fallback to current dir
}

## Establish directories
graphics_dir <- params$graphics_dir
if (!dir.exists(graphics_dir)) {
  graphics_dir <- file.path(project_root, "HvIM/Results/Graphics")
}

tables_dir <- params$tables_dir
if (!dir.exists(tables_dir)) {
  tables_dir <- file.path(project_root, "HvIM/Results/Tables")
}
procdata_dir <- params$procdata_dir %||% file.path(project_root, "HvIM/Results/Processed_data")

## Create if missing
dir.create(graphics_dir, recursive = TRUE, showWarnings = FALSE)
dir.create(tables_dir,   recursive = TRUE, showWarnings = FALSE)
dir.create(procdata_dir,   recursive = TRUE, showWarnings = FALSE)


cat("ðŸ“ Project root:", project_root, "\n")
cat("ðŸ“ Graphics:   ", graphics_dir, "\n") 
cat("ðŸ“ Tables:    ", tables_dir, "\n")
cat("ðŸ“ Processed: ", procdata_dir, "\n")
```

```{r read-couts, message=FALSE}

## Read in featureCounts
featcount <- read_tsv("./Data_Repository/featcount.txt", skip = 1)

## Set Geneid as column
gene_ids <- featcount[[1]]

## Count matrix
read.count <- as.matrix(featcount[, 7:ncol(featcount)])
rownames(read.count) <- gene_ids

## Clean colnames (remove .bam paths)
colnames(read.count) <- gsub(".*\\/|\\..*Aligned.*", "", colnames(read.count))

# Check
dim(read.count) #check dimensions 
head(rownames(read.count))  # AT1G00010 etc.
head(colnames(read.count))  # DIC1_S21, DIT1_S5 etc.
```

```{r read-couts, message=FALSE}
## Standardize colnames
sample_names <- c("IT-107", "IT-108", "IT-109", "IT-110", 
                  "H-107", "H-108", "H-109", "H-110", "H-111",
                  "UT-106", "UT-108", "UT-114", 
                  "IT-206", "IT-207", "IT-208", "IT-209",
                  "IM-206", "IM-207", "IM-208", "IM-209", "IM-210",
                  "UT-204", "UT-208", "UT-213", "UT214",
                  "UM-204", "UM-208", "UM-213", "UM-214", "UM-215")

colnames(read.count) <- sample_names #save naming system

## Verify structure
cat("ðŸ“Š Counts loaded:", nrow(read.count), "genes x", ncol(read.count), "samples\n")
cat("Range:", format(min(read.count), scientific = TRUE), "â†’", max(read.count), "\n") #printing the range of counts per gene
summary(colSums(read.count))  # Lib sizes (total reads mapped per sample)


## Convert matrix â†’ data frame with gene IDs
raw_counts_df <- as.data.frame(read.count)
raw_counts_df <- tibble::rownames_to_column(raw_counts_df, "GeneID")

# Export both CSV and Excel
write_csv(raw_counts_df, file.path(tables_dir, "raw_counts_clean.csv"))
writexl::write_xlsx(raw_counts_df, file.path(tables_dir, "raw_counts_clean.xlsx"))
```

```{r Subsetting-im-h}
# =============
# IM + H + UM 
# ============

## Columns to DROP: IT(1:4,13:16), UT(10:12,22:25) â†’ KEEP 5-9,17-21,26-30
keep_cols <- c(5:9, 17:21, 26:30)
ImvHvUM <- read.count[, keep_cols]
colnames(ImvHvUM)  # Confirm order

sample_info<- data.frame(
  row.names = c("H-107", "H-108", "H-109", "H-110", "H-111", 
                "IM-206", "IM-207", "IM-208", "IM-209", "IM-210", 
                "UM-204", "UM-208", "UM-213", "UM-214", "UM-215"),
  Groups = factor(c(rep("H",5), rep("IM",5), rep("UM",5)), levels=c("UM","IM","H")),
  Condition = factor(c(rep("Infected",10), rep("Uninfected",5)))
)
stopifnot(all(rownames(sample_info) == colnames(ImvHvUM)))

ImvHvUM_df <- tibble::rownames_to_column(as.data.frame(as.matrix(ImvHvUM)), "GeneID")

write_csv(ImvHvUM_df, file.path(tables_dir, "counts_IM_H_UM_cleansubset.csv"))
writexl::write_xlsx(ImvHvUM_df, file.path(tables_dir, "counts_IM_H_UM_cleansubset.xlsx"))

cat("âœ… IM/H/UM subset ready:", ncol(ImvHvUM), "samples\n")
table(sample_info$Groups)
```

```{r DESeq-run}
## Create DESeqDataSet (IM/H/UM subset)
dds_UM <- DESeqDataSetFromMatrix(
  countData = ImvHvUM,
  colData = sample_info,
  design = ~ Groups
)

## Prefilter low-count genes
keep <- rowSums(counts(dds_UM)) >= 10
dds_UM <- dds_UM[keep, ]
cat("Filtered:", sum(keep), "genes kept\n")

## UM reference (relevel confirms)
dds_UM$Groups <- relevel(dds_UM$Groups, ref = "UM")

## Run DESeq2
dds_UM <- DESeq(dds_UM)
print(dds_UM)

## Results names
resultsNames(dds_UM)

## Core contrasts: vs UM reference
res_IM_UM <- results(dds_UM, name = "Groups_IM_vs_UM", alpha = 0.05)
res_H_UM  <- results(dds_UM, name = "Groups_H_vs_UM", alpha = 0.05)

cat("IM vs UM DEGs (padj<0.05):", sum(res_IM_UM$padj < 0.05, na.rm = TRUE), "\n")
cat("H vs UM DEGs (padj<0.05): ", sum(res_H_UM$padj < 0.05, na.rm = TRUE), "\n")

## Save full DESeq object
saveRDS(dds_UM, file.path(procdata_dir, "dds_IM_H_UM.rds"))
```

```{r Normalization}
## Variance stabilizing transformation
vsd <- vst(dds_UM, blind = TRUE, nsub = 1000)  # blind ignores design; subsample for speed

## Sample names, match to colData
colnames(vsd) <- rownames(sample_info)
stopifnot(all(colnames(vsd) == rownames(colData(dds_UM))))  # Check

## Normalized counts matrix (size factors applied)
norm_counts <- counts(dds_UM, normalized = TRUE)

cat("VST dims:", nrow(vsd), "genes Ã—", ncol(vsd), "samples\n")
cat("Norm counts dims:", nrow(norm_counts), "Ã—", ncol(norm_counts), "\n")

## EXPORT
write_csv(as.data.frame(norm_counts), 
          file.path(tables_dir, "normalized_counts_H_IM_UM.csv"))

writexl::write_xlsx(
  list(
    Normalized = as.data.frame(round(norm_counts, 2)),  # Round for readability
    VST        = as.data.frame(assay(vsd))
  ), 
  path = file.path(tables_dir, "H_IM_UM_normalized_VST.xlsx")
)
cat("âœ… Exported Normalized + VST matrices to Tables/\n")

## Enhanced quality checks
summary(colSums(assay(vsd)))  # VST lib sizes should be ~equal (~1e6 range)

## Better visualization
boxplot(log2(assay(vsd)[1:25, ] + 1), 
        main = "VST Top 25 Genes by Sample", 
        las = 2, cex.axis = 0.8)
```

```{r clustering-heatmeps}
## Sample correlation heatmap (Spearman, raw counts >=1)
sim_mat <- ImvHvUM[rowSums(ImvHvUM) >= 1, ]
cor_samps <- round(cor(sim_mat, method = "spearman"), 2)
melted_cor <- melt(cor_samps)


## Correlation Plot
p_cor <- ggplot(melted_cor, aes(Var1, Var2, fill = value)) +
  geom_tile(color = "white", linewidth = 0.5) +
  geom_text(aes(label = value), color = "black", size = 3.2) +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0.9,
                       limits = c(0.5, 1), name = "Spearman Ï") +
  labs(title = "Sample Correlation (Raw Counts, Spearman)", x = "", y = "") +
  theme_minimal(base_size = 11) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text.y = element_text(size = 9),
        panel.grid = element_blank(),
        legend.position = "bottom")

print(p_cor)
ggsave(file.path(graphics_dir, "sample_correlation_spearman.png"), p_cor, width = 10, height = 8, dpi = 300)

## Hierarchical clustering (VST normalized, Euclidean distance)
sample_dist <- dist(t(assay(vsd)))  # (t) samples as rows
hc <- hclust(sample_dist, method = "ward.D2")
dend_data <- dendro_data(hc)

# Add colors to labels
label_df <- label(dend_data) %>%
  mutate(
    Group = sample_info$Groups[match(label, rownames(sample_info))],
    color = case_when(
      Group == "H" ~ "#56B4E9",    # Haustoria
      Group == "IM" ~ "#E69FBC",     # Mesophyll  
      Group == "UM" ~ "#8C8C8C",    # Uninfected
      TRUE ~ "lightgreen"
    )
  )

p_dend <- ggplot() +
  geom_segment(data = segment(dend_data), 
               aes(x = x, y = y, xend = xend, yend = yend)) +
  geom_text(data = label_df, 
            aes(x = x, y = y, label = label, colour = color), 
            hjust = -0.1, size = 3.5) +
  scale_colour_identity() +  # Use exact colors
  coord_flip() + 
  scale_y_reverse(expand = c(0.2, 0)) +
  theme_dendro() + 
  labs(title = "VST Clustering (Ward.D2)", 
       subtitle = "Labels colored by Groups (Haustoria/Infected Mesophyll/Uninfected Mesophyll)") +
  theme(plot.title = element_text(hjust = 0.5))
print(p_dend)

ggsave(file.path(graphics_dir, "sample_clustering_colored.png"), 
       p_dend, width = 12, height = 8, dpi = 300)


## Sample distance matrix heatmap
dist_mat <- as.matrix(sample_dist)
colnames(dist_mat) <- rownames(sample_info) 
rownames(dist_mat) <- rownames(sample_info)

colors_dist <- colorRampPalette(rev(RColorBrewer::brewer.pal(9, "Blues")))(255)
p_dist <- pheatmap(dist_mat,
  clustering_distance_rows = sample_dist,
  clustering_distance_cols = sample_dist,
  color = colors_dist,
  main = "Sample Euclidean Distances (VST)",
  show_rownames = TRUE, show_colnames = TRUE,
  filename = file.path(graphics_dir, "sample_distance_heatmap.png"),
  width = 10, height = 9
)
```

```{r PCA}
## PCA Set Up
pca_data <- DESeq2::plotPCA(vsd, 
                           intgroup = c("Groups", "Condition"), 
                           returnData = TRUE)
percentVar <- round(100 * attr(pca_data, "percentVar"))

# Plot
p_pca <- ggplot(pca_data, aes(PC1, PC2, color = Groups, shape = Condition)) +
  geom_point(size = 4.5, stroke = 1.5, alpha = 0.85) +
  scale_color_manual(values = c("UM" = "#8C8C8C", 
                                "IM" = "#E69FBC", 
                                "H"  = "#56B4E9"),
                     name = "Tissue") +
  scale_shape_manual(values = c("Uninfected" = 16,    # Circle
                                "Infected"   = 17),  # Triangle
                     name = "Status") +
  geom_text_repel(aes(label = name),                 
                  box.padding = 0.35, 
                  max.overlaps = Inf,  # Show all labels
                  size = 3.5, 
                  segment.color = "grey60",
                  segment.size = 0.3,
                  bg.color = "white", 
                  bg.r = 0.1) +
  labs(title = "TRAP-seq PCA: Haustoria vs Mesophyll (VST)",
       subtitle = paste("PC1:", round(percentVar[1],1), "% variance |",
                       "PC2:", round(percentVar[2],1), "% variance"),
       caption = "Groups: UM (uninfected mesophyll), IM (infected mesophyll), H (haustoria)") +
  xlab(paste0("PC1 (", round(percentVar[1],1), "%)")) +
  ylab(paste0("PC2 (", round(percentVar[2],1), "%)")) +
  theme_classic(base_size = 13) +
  theme(legend.position = "bottom", 
        legend.title = element_text(face = "bold"),
        plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
        plot.subtitle = element_text(hjust = 0.5, size = 12),
        panel.grid.minor = element_blank())
print(p_pca)

## EXPORT
ggsave(file.path(graphics_dir, "TRAPseq_PCA_vst_final.png"), 
       p_pca, width = 11, height = 8, dpi = 300, bg = "white")
```


```{r DESeq-results-lfc}
## CONTRASTS
res_H_UM <- results(dds_UM, contrast = c("Groups", "H", "UM"), alpha = 0.05)
res_IM_UM <- results(dds_UM, contrast = c("Groups", "IM", "UM"), alpha = 0.05)

## LFC shrinkage (apeglm, more accurate for rankings)
lfc_H_UM <- tryCatch({
  lfcShrink(dds_UM, coef = "Groups_H_vs_UM", type = "apeglm")
}, error = function(e) {
  warning("apeglm failed for H_vs_UM, using normal: ", e$message)
  lfcShrink(dds_UM, contrast = c("Groups", "H", "UM"), type = "normal")
})

lfc_IM_UM <- tryCatch({
  lfcShrink(dds_UM, coef = "Groups_IM_vs_UM", type = "apeglm")
}, error = function(e) {
  warning("apeglm failed for IM_vs_UM, using normal: ", e$message)
  lfcShrink(dds_UM, contrast = c("Groups", "IM", "UM"), type = "normal")
})

# padj ascending, remove NA padj
res_H_UM <- res_H_UM[!is.na(res_H_UM$padj), ] %>% as.data.frame() %>% arrange(padj)
res_IM_UM <- res_IM_UM[!is.na(res_IM_UM$padj), ] %>% as.data.frame() %>% arrange(padj)

lfc_H_UM <- lfc_H_UM[!is.na(lfc_H_UM$padj), ] %>% as.data.frame() %>% arrange(padj)
lfc_IM_UM <- lfc_IM_UM[!is.na(lfc_IM_UM$padj), ] %>% as.data.frame() %>% arrange(padj)

## Clean up time
pad <- 0.05
lfc_cutoff <- 1.0

res_H_UM_df <- res_H_UM %>%
  as.data.frame() %>%
  rownames_to_column(var = "Gene") %>%
  filter(!is.na(padj)) %>%
  arrange(padj)

res_IM_UM_df <- res_IM_UM %>%
  as.data.frame() %>%
  rownames_to_column(var = "Gene") %>%
  filter(!is.na(padj)) %>%
  arrange(padj)

lfc_H_UM_df <- lfc_H_UM %>%
  as.data.frame() %>%
  rownames_to_column(var = "Gene") %>%
  filter(!is.na(padj)) %>%
  arrange(padj)

lfc_IM_UM_df <- lfc_IM_UM %>%
  as.data.frame() %>%
  rownames_to_column(var = "Gene") %>%
  filter(!is.na(padj)) %>%
  arrange(padj)


# QC summaries
sig_H_UM <- sum(res_H_UM_df$padj < pad & abs(res_H_UM_df$log2FoldChange) >= lfc_cutoff)
sig_IM_UM <- sum(res_IM_UM_df$padj < pad & abs(res_IM_UM_df$log2FoldChange) >= lfc_cutoff)

cat("\nðŸ”¬ DEGs (padj <", pad, "|LFC| â‰¥", lfc_cutoff, "):\n")
cat("H vs UM:  ", sig_H_UM, " (", round(100*sig_H_UM/nrow(res_H_UM),1), "%)\n")
cat("IM vs UM: ", sig_IM_UM, " (", round(100*sig_IM_UM/nrow(res_IM_UM),1), "%)\n")
cat("H > IM confirms haustoria enrichment!\n\n")

## EXPORT CSV
write_csv(res_H_UM_df, file.path(tables_dir, "DESeq2_H_vs_UM_base.csv"))
write_csv(lfc_H_UM_df, file.path(tables_dir, "DESeq2_H_vs_UM_LFCshrink.csv"))
write_csv(res_IM_UM_df, file.path(tables_dir, "DESeq2_IM_vs_UM_base.csv"))
write_csv(lfc_IM_UM_df, file.path(tables_dir, "DESeq2_IM_vs_UM_LFCshrink.csv"))
cat("âœ… Exported 4 result tables (base + LFC-shrunk)\n")


# Set up for excel
export_list <- list(
  "H_vs_UM_results" = res_H_UM_df,
  "IM_vs_UM_results" = res_IM_UM_df,
  "H_vs_UM_LFC"     = lfc_H_UM_df,
  "IM_vs_UM_LFC"    = lfc_IM_UM_df
)

writexl::write_xlsx(export_list, path = file.path(tables_dir, "DESeq2_results.xlsx"))
cat("âœ… DESeq2 results saved as Excel at:", file.path(tables_dir, "DESeq2_results.xlsx"), "\n")
```

```{r}
## Single wide tibble (LFC shrunk)
deseq_all <- full_join(
  as_tibble(lfc_IM_UM, rownames = "GeneID") %>% 
    dplyr::select(GeneID, log2FoldChange, padj, pvalue)
  %>% mutate(contrast = "IM_vs_UM"),
  as_tibble(lfc_H_UM, rownames = "GeneID") %>% 
    dplyr::select(GeneID, log2FoldChange, padj, pvalue)
  %>% mutate(contrast = "H_vs_UM"),
  by = "GeneID",
  suffix = c("_IM_vs_UM", "_H_vs_UM")) %>%
dplyr::select(GeneID, ends_with("log2FoldChange"), ends_with("padj"), 
                ends_with("pvalue"), everything()) %>%
  arrange(padj_IM_vs_UM, padj_H_vs_UM)

# Add sig or not
deseq_all <- deseq_all %>%
  mutate(
    sig_IM = ifelse(padj_IM_vs_UM < 0.05 & abs(log2FoldChange_IM_vs_UM) > 1, 
                    "Significant", "NS"),
    sig_H  = ifelse(padj_H_vs_UM < 0.05 & abs(log2FoldChange_H_vs_UM) > 1, 
                    "Significant", "NS")
  )
## EXPORT
write_csv(deseq_all, file.path(tables_dir, "DESeq2_LFC_shrunk_all_contrasts.csv"))
writexl::write_xlsx(deseq_all, path = file.path(tables_dir, "DESeq2_LFC_shrunk_all_contrast.xlsx"))

# Full DE summary table
de_summary <- tibble(
  contrast = c("IM_vs_UM", "H_vs_UM"),
  n_DEG_IM = map_int(list(res_IM_UM, res_H_UM), ~sum(.$padj < 0.05, na.rm = TRUE)),
  n_DEG_H  = c(sum(res_H_UM$padj < 0.05, na.rm = TRUE), NA),
  n_LFC1_IM = map_int(list(lfc_IM_UM, lfc_H_UM), ~sum(abs(.$log2FoldChange) > 1, na.rm = TRUE))
) %>% print()
```


```{r deg-heatmap}
set.seed(123)

## DE genes from BOTH contrasts (intersecting for haustoria candidates)
sig_IM <- rownames(res_IM_UM)[res_IM_UM$padj < 0.05 & !is.na(res_IM_UM$padj) & abs(res_IM_UM$log2FoldChange) >= 1]

sig_H  <- rownames(res_H_UM)[res_H_UM$padj < 0.05 & !is.na(res_H_UM$padj) & abs(res_H_UM$log2FoldChange) >= 1]

top_DE_genes <- head(intersect(sig_IM, sig_H), 100)  # Shared top 100
cat("Shared DE genes (padj<0.05, |LFC|â‰¥1):", length(top_DE_genes), "\n")

## Subset normalized counts and ensure genes exist
if(length(top_DE_genes) > 0) {
  top_DE_genes <- intersect(top_DE_genes, rownames(norm_counts))  # Safety intersect
  if(length(top_DE_genes) > 0) {
    deg_mat <- norm_counts[top_DE_genes, ]
    
    # Sample annotation and ensure rownames match colnames
    ann_col <- data.frame(Groups = sample_info$Groups)
    rownames(ann_col) <- colnames(deg_mat)  # Critical for pheatmap

#PHEATMAP
p_deg <- pheatmap(deg_mat,
      scale = "row",  # Z-score per gene for DE visualization
      color = colorRampPalette(rev(RColorBrewer::brewer.pal(n = 7, "RdYlBu")))(100),  # Explicit namespace
      cluster_rows = TRUE, 
      cluster_cols = TRUE,
      clustering_distance_rows = "correlation",
      clustering_distance_cols = "euclidean",
      clustering_method = "complete",
      annotation_col = ann_col,
      show_rownames = ifelse(length(top_DE_genes) < 30, TRUE, FALSE),
      show_colnames = FALSE,
      main = paste("Top", length(top_DE_genes), "Shared DE Genes\n(padj<0.05, |LFC|â‰¥1: IM & H vs UM)"),
      fontsize_row = 8,
      filename = file.path(graphics_dir, "heatmap_top_shared_DE_genes.png"),
      width = 12, height = 10
    )
    
## EXPORT
    write.csv(data.frame(Gene = top_DE_genes), 
              file.path(tables_dir, "top_shared_DE_genes.csv"), row.names = FALSE)
    
  } else {
    cat("No shared DE genes in norm_counts\n")
  }
} else {
  cat("No shared DE genes found\n")
}
writexl::write_xlsx(data.frame(Gene = top_DE_genes), 
              file.path(tables_dir, "top_shared_DE_genes.xlsx"))
```


```{r H v UM DEGS}
padj_thresh <- 0.05
lfc_thresh <- 1

## MAKE DEG TABLES
# H v UM
deg_H <- res_H_UM %>%
  as.data.frame() %>%  
  rownames_to_column("TAIR") %>%
  as_tibble() %>%
  filter(padj < padj_thresh & !is.na(padj) & abs(log2FoldChange) >= lfc_thresh) %>%
  mutate(direction = case_when(
    log2FoldChange > lfc_thresh ~ "H_UP",
    log2FoldChange < -lfc_thresh ~ "H_DOWN",
    TRUE ~ "NS"
  )) %>%
  filter(direction != "NS") %>%
  mutate(
    symbol = mapIds(org.At.tair.db, keys = TAIR, column = "SYMBOL", keytype = "TAIR", multiVals = "first"),
    entrez = mapIds(org.At.tair.db, keys = TAIR, column = "ENTREZID", keytype = "TAIR", multiVals = "first")
  )

# IM vs UM (infected mesophyll)
deg_IM <- res_IM_UM %>%
  as.data.frame() %>%
  rownames_to_column("TAIR") %>%
  as_tibble() %>%
  filter(padj < padj_thresh & !is.na(padj) & abs(log2FoldChange) >= lfc_thresh) %>%
  mutate(direction = case_when(
    log2FoldChange > lfc_thresh ~ "IM_UP",
    log2FoldChange < -lfc_thresh ~ "IM_DOWN",
    TRUE ~ "NS"
  )) %>%
  filter(direction != "NS") %>%
  mutate(
    symbol = mapIds(org.At.tair.db, keys = TAIR, column = "SYMBOL", keytype = "TAIR", multiVals = "first"),
    entrez = mapIds(org.At.tair.db, keys = TAIR, column = "ENTREZID", keytype = "TAIR", multiVals = "first")
  )


## SHARED HAUSTORIA CANDIDATES
shared_tair <- intersect(deg_H$TAIR, deg_IM$TAIR)
deg_shared <- deg_H %>%
  filter(TAIR %in% shared_tair) %>%
  left_join(select(deg_IM, TAIR, log2FoldChange_IM = log2FoldChange, padj_IM = padj), by = "TAIR") %>%
  mutate(avg_lfc = (log2FoldChange + coalesce(log2FoldChange_IM, 0)) / 2) %>%
  arrange(desc(avg_lfc))

# SPLIT UP/DOWN FOR HEATMAPS
H_UP <- deg_H %>% filter(direction == "H_UP")
H_DOWN <- deg_H %>% filter(direction == "H_DOWN")
IM_UP <- deg_IM %>% filter(direction == "IM_UP")
IM_DOWN <- deg_IM %>% filter(direction == "IM_DOWN")

cat("DE Genes (|LFC| â‰¥", lfc_thresh, ", padj <", padj_thresh, "):\n")
cat("- H vs UM:    ", nrow(deg_H), " (UP:", nrow(H_UP), " DOWN:", nrow(H_DOWN), ")\n")
cat("- IM vs UM:   ", nrow(deg_IM), " (UP:", nrow(IM_UP), " DOWN:", nrow(IM_DOWN), ")\n")
cat("- Shared:     ", nrow(deg_shared), "\n")

## EXCEL
deg_workbook <- list(
  H_vs_UM_All   = deg_H %>% arrange(padj),
  H_vs_UM_UP    = H_UP,
  H_vs_UM_DOWN  = H_DOWN,
  IM_vs_UM_All  = deg_IM %>% arrange(padj),
  IM_vs_UM_UP   = IM_UP,
  IM_vs_UM_DOWN = IM_DOWN,
  Shared        = deg_shared
)

write_xlsx(deg_workbook, file.path(tables_dir, "DE_genes_all_directions.xlsx"))

## Summary stats
summary_stats <- tibble(
  Contrast = c("H vs UM UP", "H vs UM DOWN", "IM vs UM UP", "IM vs UM DOWN", "Shared"),
  n_genes = c(nrow(H_UP), nrow(H_DOWN), nrow(IM_UP), nrow(IM_DOWN), nrow(deg_shared))
)
```

```{r}
## GO ENRICHMENT
tair_list <- list(
  IM_UP   = IM_UP$TAIR[!is.na(IM_UP$TAIR)],
  H_UP    = H_UP$TAIR[!is.na(H_UP$TAIR)],
  IM_DOWN = IM_DOWN$TAIR[!is.na(IM_DOWN$TAIR)],
  H_DOWN  = H_DOWN$TAIR[!is.na(H_DOWN$TAIR)]
)

## SINGLE COMBINED DOTPLOT
go_compare <- compareCluster(
  geneClusters = tair_list,
  fun = "enrichGO",
  OrgDb = org.At.tair.db,
  keyType = "TAIR",
  ont = "BP",
  pAdjustMethod = "BH",
  pvalueCutoff = pad, qvalueCutoff = pad,
  minGSSize = 10
)
p_go_dot <- dotplot(go_compare, showCategory = 25, font.size = 11, label_format = 60) + 
  ggtitle("GO BP Terms: 4-way Comparison (IM_UP/H_UP/IM_DOWN/H_DOWN)")
print(p_go_dot)

ggsave(file.path(graphics_dir, "GO_BP_4way_combined_dotplot.png"), 
       plot = p_go_dot, width = 12, height = 12, dpi = 300)
cat("âœ“ Saved GO BP 4-way combined dotplot\n")

## SUMMARY
go_summary <- tibble(
  Category = c("IM_UP", "H_UP", "IM_DOWN", "H_DOWN"),
  n_genes = c(nrow(IM_UP), nrow(H_UP), nrow(IM_DOWN), nrow(H_DOWN))
)
print(go_summary)


## Individual results for exports
ego_list <- list()
for(category in names(tair_list)) {
  tair_clean <- tair_list[[category]]
  if(length(tair_clean) > 10) {
    ego_list[[category]] <- enrichGO(
      gene = tair_clean,
      OrgDb = org.At.tair.db,
      keyType = "TAIR",
      ont = "BP", 
      pAdjustMethod = "BH",
      pvalueCutoff = pad, qvalueCutoff = pad,
      minGSSize = 10
    )
  } else {
    ego_list[[category]] <- NULL
  }
}

## Assign for backward compatibility
ego_IMup   <- ego_list$IM_UP
ego_Hup    <- ego_list$H_UP
ego_IMdown <- ego_list$IM_DOWN
ego_Hdown  <- ego_list$H_DOWN

cat("âœ… GO objects assigned: ego_IMup, ego_Hup, ego_IMdown, ego_Hdown\n")
```

```{r}
## COMPLETE KEGG (IM_UP, H_UP, IM_DOWN, H_DOWN)
entrez_list <- list(
  IM_UP   = IM_UP$entrez[!is.na(IM_UP$entrez)],
  H_UP    = H_UP$entrez[!is.na(H_UP$entrez)],
  IM_DOWN = IM_DOWN$entrez[!is.na(IM_DOWN$entrez)],
  H_DOWN  = H_DOWN$entrez[!is.na(H_DOWN$entrez)]
)

## SINGLE COMBINED KEGG DOTPLOT (all 4 categories)
kegg_compare <- compareCluster(
  geneClusters = entrez_list,
  fun = "enrichKEGG",
  organism = "ath",
  keyType = "ncbi-geneid",
  pvalueCutoff = pad, qvalueCutoff = pad,
  minGSSize = 10, maxGSSize = 500,
  use_internal_data = FALSE
)

p_kegg_dot <- dotplot(kegg_compare, showCategory = 20, font.size = 11, label_format = 60) + 
  ggtitle("KEGG Pathways: 4-way Comparison (IM_UP/H_UP/IM_DOWN/H_DOWN)")
print(p_kegg_dot)

ggsave(file.path(graphics_dir, "KEGG_4way_combined_dotplot.png"), 
      plot = p_kegg_dot, width = 12, height = 10, dpi = 300)
cat("âœ“ Saved KEGG 4-way combined dotplot\n")

# Keep individual results for exports (run enrichKEGG separately)
kegg_results <- list()
for(category in names(entrez_list)) {
  entrez_clean <- entrez_list[[category]]
  if(length(entrez_clean) > 10) {
    kegg_results[[category]] <- enrichKEGG(
      gene = entrez_clean,
      organism = "ath",
      keyType = "ncbi-geneid",
      pvalueCutoff = pad, qvalueCutoff = pad,
      minGSSize = 10, maxGSSize = 500,
      use_internal_data = FALSE
    )
  } else {
    kegg_results[[category]] <- NULL
  }
}


## COMPLETE EXPORTS
kegg_xlsx <- lapply(kegg_results, function(x) if(is.null(x)) data.frame() else x@result)
kegg_xlsx$Summary <- tibble(
  Category = names(kegg_results),
  n_genes_input = sapply(entrez_list, length),
  n_KEGG_terms = sapply(kegg_results, function(x) if(is.null(x)) 0 else nrow(x@result))
)
kegg_xlsx$KEGG_Compare <- as.data.frame(kegg_compare@compareClusterResult)

write_xlsx(kegg_xlsx, file.path(tables_dir, "KEGG_4way_complete.xlsx"))


## FULL GO+KEGG COMBINED
full_export <- list(
  GO_BP_IM_UP   = ego_IMup@result,
  GO_BP_H_UP    = ego_Hup@result,
  GO_BP_IM_DOWN = ego_IMdown@result,
  GO_BP_H_DOWN  = ego_Hdown@result,
  
  # KEGG individuals
  KEGG_IM_UP    = kegg_results$IM_UP@result,
  KEGG_H_UP     = kegg_results$H_UP@result,
  KEGG_IM_DOWN  = kegg_results$IM_DOWN@result,
  KEGG_H_DOWN   = kegg_results$H_DOWN@result,
  
  # KEGG combined
  KEGG_4way_Compare = kegg_compare@compareClusterResult,
  
  # Summary
  Summary = tibble(
    Category = names(entrez_list),
    n_genes = sapply(entrez_list, length),
    n_GO_terms = c(nrow(ego_IMup@result), nrow(ego_Hup@result), nrow(ego_IMdown@result), nrow(ego_Hdown@result)),
    n_KEGG_terms = sapply(kegg_results, function(x) if(is.null(x)) 0 else nrow(x@result))
  )
)

write_xlsx(full_export, file.path(tables_dir, "COMPLETE_GO_KEGG_4way.xlsx"))

cat("ðŸŽ‰ KEGG 4-WAY SINGLE GRAPHS SAVED:\n")
cat("- KEGG_4way_combined_dotplot.png \n")
cat("- KEGG_4way_combined_similarity.png\n")
cat("- KEGG_4way_complete.xlsx (incl. compareCluster)\n")
cat("- COMPLETE_GO_KEGG_4way.xlsx\n")
```

```{r VIDGER}
FW_df <- vsFourWay(
  x = "H", y = "IM", control = "UM", 
  data = dds_UM,
  d.factor = "Groups", 
  type = "deseq", padj = pad, lfc = 1,
  title = TRUE, grid = TRUE, legend = TRUE,
  data.return = TRUE, xaxis.text.size = 10, yaxis.text.size = 10,
)

print(FW_df$plot)  # View plot
ggsave(file.path(graphics_dir, "FourWay_H_vs_IM_vs_UM.png"), 
       FW_df$plot, width = 10, height = 8, dpi = 300)
```

```{r extract-genes}
pvalueCutoff = pad
qvalueCutoff = pad

## Extract Genes
df_four <- FW_df$data
green_genes <- df_four %>%
  filter(color == "green") %>%
  pull(id)

length(green_genes)  # Count
head(green_genes, 20)

# All sig DEGs (blue + green)
sig_genes <- df_four %>%
  filter(isDE_all == TRUE) %>%
  pull(id)

## EXPORT
write_csv(tibble(Gene = green_genes), 
          file.path(tables_dir, "vidger_green_genes.csv"))
write_xlsx(tibble(Gene = green_genes), 
          file.path(tables_dir, "vidger_green_genes.xlsx"))
write_csv(df_four %>% filter(color == "green"), 
          file.path(tables_dir, "vidger_green_detailed.csv"))
write_xlsx(df_four %>% filter(color == "green"), 
          file.path(tables_dir, "vidger_green_detailed.xlsx"))

## Top-right: Strong H UP (logFC_x > 2), weak IM (logFC_y â‰ˆ 0)
pure_haustoria <- df_four %>%
 filter(
  padj_x < pad,
  padj_y >= pad,
  logFC_x > 1.5,
  abs(logFC_y) < 0.5) %>%
  arrange(desc(logFC_x)) %>%   # Rank by H strength
  pull(id)

length(pure_haustoria)
head(pure_haustoria, 15)

pure_df <- df_four %>%
  filter(id %in% pure_haustoria) %>%
  select(id, logFC_x, logFC_y, padj_x, padj_y) %>%
  arrange(desc(logFC_x))


write_csv(pure_df, file.path(tables_dir, "pure_haustoria_H_specific.csv"))
write_xlsx(pure_df, 
          file.path(tables_dir, "pure_haustoria_H_specific.xlsx"))

# Validate overlap with H_UP
h_up_overlap <- intersect(pure_haustoria, H_UP$TAIR)
length(h_up_overlap) / length(pure_haustoria)

## GO BP
ego_pureH <- enrichGO(
  gene = pure_haustoria,
  OrgDb = org.At.tair.db,
  keyType = "TAIR",
  ont = "BP",
  pAdjustMethod = "BH",
  pvalueCutoff = 1, 
  qvalueCutoff = 1,
  minGSSize = 5
)


## Color by raw pvalue (ALL terms)
p1 <- dotplot(ego_pureH, showCategory = 25, color = "pvalue") + 
  scale_color_gradient(low = "red", high = "blue") +
  ggtitle("Pure Haustoria GO BP") +
  scale_color_continuous(low = "red", high = "blue")
print(p1)
ggsave(file.path(graphics_dir, "pure_haustoria_GO_pvalue.png"), p1, width=12, height=10)

## Top 20 by index
top_idx <- ego_pureH@result %>%
  arrange(p.adjust) %>%
  slice_head(n = 20) %>%
  rownames() %>%
  as.numeric()

p2 <- dotplot(
  ego_pureH,
  showCategory = 20
) +
  ggtitle("Top 20 Pure Haustoria GO")

print(p2)
```


```{r}
## KEGG
entrez <- bitr(pure_haustoria, from="TAIR", to="ENTREZID",
               OrgDb=org.At.tair.db) %>%
  distinct(ENTREZID)

kegg_pureH <- enrichKEGG(
  gene = pure_haustoria,
  organism = "ath",
  keyType = "kegg",
  pvalueCutoff = 0.05
)

kegg_df <- kegg_pureH@result %>%
  mutate(
    GeneRatio_num = as.numeric(sub("/.*", "", GeneRatio)) /
                    as.numeric(sub(".*/", "", GeneRatio))
  ) %>% arrange(pvalue) %>% slice_head(n = 20)

stopifnot(nrow(kegg_df) > 0)

## PLOT
ggplot(kegg_df,
       aes(x = GeneRatio_num,
           y = reorder(Description, GeneRatio_num),
           size = Count,
           color = p.adjust)) +
  geom_point() +
  scale_color_continuous(low = "red", high = "blue") +
  labs(
    title = "Pure Haustoria KEGG Pathways",
    x = "Gene Ratio",
    y = NULL
  ) +
  theme_bw()
```